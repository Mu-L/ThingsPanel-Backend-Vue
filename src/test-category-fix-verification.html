<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card 2.1 文件夹分类系统验证</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .result-box {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #27ae60; background: #d5f5d5; }
        .error { border-left: 4px solid #e74c3c; background: #fde2e2; }
        .info { border-left: 4px solid #3498db; background: #e3f2fd; }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .category-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: white;
        }
        .category-title {
            font-weight: bold;
            color: #2c3e50;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        .component-list {
            list-style: none;
            padding: 0;
        }
        .component-item {
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 Card 2.1 文件夹分类系统修复验证</h1>
            <p>验证自动注册系统是否正确按照文件夹进行分类</p>
        </div>

        <div class="test-section">
            <h3>📋 分类映射配置测试</h3>
            <button class="test-button" onclick="testCategoryMapping()">验证分类映射配置</button>
            <button class="test-button" onclick="testFolderPathParsing()">测试文件夹路径解析</button>
            <div id="mapping-result" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>🚀 自动注册系统测试</h3>
            <button class="test-button" onclick="testAutoRegistry()">测试自动注册系统</button>
            <button class="test-button" onclick="testCategoryFiltering()">测试开发环境分类过滤</button>
            <div id="registry-result" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>📊 分类显示验证</h3>
            <button class="test-button" onclick="showAllCategories()">显示所有分类</button>
            <button class="test-button" onclick="showComponentsByCategory()">按分类显示组件</button>
            <div id="categories-result" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>🎯 期望的分类结果</h3>
            <div class="category-grid">
                <div class="category-card">
                    <div class="category-title">📊 仪表盘</div>
                    <p>dashboard/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">ℹ️ 信息</div>
                    <p>information/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">🎮 控制</div>
                    <p>control/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">📈 数据</div>
                    <p>data/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">📊 统计</div>
                    <p>statistics/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">📍 位置</div>
                    <p>location/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">🎵 音视频</div>
                    <p>media/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">⚠️ 告警</div>
                    <p>alarm/ 文件夹下的组件</p>
                </div>
                <div class="category-card">
                    <div class="category-title">🧪 测试 (仅开发)</div>
                    <p>test/ 文件夹下的组件，仅开发环境显示</p>
                </div>
                <div class="category-card">
                    <div class="category-title">🔧 设备 (特殊逻辑)</div>
                    <p>device/ 不走文件夹逻辑，有其他逻辑实现</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 测试分类映射配置
        window.testCategoryMapping = async function() {
            const resultDiv = document.getElementById('mapping-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box info';
            resultDiv.textContent = '正在测试分类映射配置...';

            try {
                // 动态导入分类映射配置
                const { FOLDER_CATEGORY_MAPPING, getCategoryDisplayName, shouldShowCategory, validateCategoryMapping } = 
                    await import('./src/card2.1/components/category-mapping.ts');

                const validation = validateCategoryMapping();
                let result = '=== 分类映射配置验证结果 ===\n\n';
                
                if (validation.valid) {
                    result += '✅ 配置验证通过！\n\n';
                } else {
                    result += '❌ 配置存在问题:\n' + validation.issues.join('\n') + '\n\n';
                }

                result += '📋 已配置的分类映射:\n';
                Object.entries(FOLDER_CATEGORY_MAPPING).forEach(([folder, config]) => {
                    result += `${folder}/ → "${config.displayName}" (顺序: ${config.order}`;
                    if (config.devOnly) result += ', 仅开发环境';
                    if (!config.enabled) result += ', 未启用';
                    result += ')\n';
                });

                result += '\n🧪 测试用例:\n';
                result += `statistics → ${getCategoryDisplayName('statistics')}\n`;
                result += `test → ${getCategoryDisplayName('test')} (开发环境: ${shouldShowCategory('test', true)})\n`;
                result += `device → ${getCategoryDisplayName('device')} (启用: ${FOLDER_CATEGORY_MAPPING.device.enabled})\n`;

                resultDiv.textContent = result;
                resultDiv.className = 'result-box success';
            } catch (error) {
                resultDiv.textContent = '❌ 测试失败:\n' + error.toString();
                resultDiv.className = 'result-box error';
            }
        };

        // 测试文件夹路径解析
        window.testFolderPathParsing = async function() {
            const resultDiv = document.getElementById('mapping-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box info';
            resultDiv.textContent = '正在测试文件夹路径解析...';

            try {
                const { getCategoryByFolderPath } = await import('./src/card2.1/components/category-mapping.ts');
                
                const testPaths = [
                    './statistics/access-num/index.ts',
                    './test/simple-display/index.ts', 
                    './alarm/alarm-info/index.ts',
                    './data/chart-display/index.ts',
                    './unknown/component/index.ts'
                ];

                let result = '=== 文件夹路径解析测试 ===\n\n';
                testPaths.forEach(path => {
                    const config = getCategoryByFolderPath(path);
                    result += `路径: ${path}\n`;
                    if (config) {
                        result += `  → 分类: ${config.displayName} (顺序: ${config.order})\n`;
                    } else {
                        result += `  → 分类: 未找到映射\n`;
                    }
                    result += '\n';
                });

                resultDiv.textContent = result;
                resultDiv.className = 'result-box success';
            } catch (error) {
                resultDiv.textContent = '❌ 测试失败:\n' + error.toString();
                resultDiv.className = 'result-box error';
            }
        };

        // 测试自动注册系统
        window.testAutoRegistry = async function() {
            const resultDiv = document.getElementById('registry-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box info';
            resultDiv.textContent = '正在测试自动注册系统...';

            try {
                const { autoRegistry } = await import('./src/card2.1/components/auto-registry.ts');
                
                // 等待初始化完成
                await autoRegistry.initialize();

                const components = autoRegistry.getAllComponents();
                const categories = autoRegistry.getAllCategories();
                const stats = autoRegistry.getStats();

                let result = '=== 自动注册系统测试结果 ===\n\n';
                result += `📊 统计信息:\n`;
                result += `- 总组件数: ${stats.total}\n`;
                result += `- 分类数: ${categories.length}\n`;
                result += `- 有效组件数: ${components.length}\n\n`;
                
                result += `📋 发现的分类:\n`;
                categories.forEach((category, index) => {
                    const categoryComponents = autoRegistry.getComponentsByCategory(category);
                    result += `${index + 1}. ${category} (${categoryComponents.length} 个组件)\n`;
                });

                result += '\n🔍 按分类统计:\n';
                Object.entries(stats.byCategory).forEach(([category, count]) => {
                    result += `- ${category}: ${count} 个组件\n`;
                });

                resultDiv.textContent = result;
                resultDiv.className = 'result-box success';
            } catch (error) {
                resultDiv.textContent = '❌ 测试失败:\n' + error.toString();
                resultDiv.className = 'result-box error';
            }
        };

        // 测试开发环境分类过滤
        window.testCategoryFiltering = async function() {
            const resultDiv = document.getElementById('registry-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box info';
            resultDiv.textContent = '正在测试开发环境分类过滤...';

            try {
                const { getValidCategories } = await import('./src/card2.1/components/category-mapping.ts');
                
                const prodCategories = getValidCategories(false); // 生产环境
                const devCategories = getValidCategories(true);   // 开发环境

                let result = '=== 开发环境分类过滤测试 ===\n\n';
                result += `🏭 生产环境分类 (${prodCategories.length} 个):\n`;
                prodCategories.forEach(({ folder, config }) => {
                    result += `- ${config.displayName} (${folder}/)\n`;
                });

                result += `\n🧪 开发环境分类 (${devCategories.length} 个):\n`;
                devCategories.forEach(({ folder, config }) => {
                    result += `- ${config.displayName} (${folder}/)`;
                    if (config.devOnly) result += ' [仅开发环境]';
                    result += '\n';
                });

                result += `\n✅ 过滤逻辑验证:\n`;
                result += `- test 分类在生产环境: ${prodCategories.some(c => c.folder === 'test') ? '显示' : '隐藏'}\n`;
                result += `- test 分类在开发环境: ${devCategories.some(c => c.folder === 'test') ? '显示' : '隐藏'}\n`;
                result += `- device 分类: ${devCategories.some(c => c.folder === 'device') ? '启用' : '禁用'} (特殊逻辑)\n`;

                resultDiv.textContent = result;
                resultDiv.className = 'result-box success';
            } catch (error) {
                resultDiv.textContent = '❌ 测试失败:\n' + error.toString();
                resultDiv.className = 'result-box error';
            }
        };

        // 显示所有分类
        window.showAllCategories = async function() {
            const resultDiv = document.getElementById('categories-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box info';
            resultDiv.textContent = '正在加载分类信息...';

            try {
                const { autoRegistry } = await import('./src/card2.1/components/auto-registry.ts');
                
                await autoRegistry.initialize();
                const categories = autoRegistry.getAllCategories();

                let result = '=== 所有分类显示 ===\n\n';
                result += `发现 ${categories.length} 个分类:\n\n`;
                
                categories.forEach((category, index) => {
                    result += `${index + 1}. ${category}\n`;
                });

                resultDiv.textContent = result;
                resultDiv.className = 'result-box success';
            } catch (error) {
                resultDiv.textContent = '❌ 显示失败:\n' + error.toString();
                resultDiv.className = 'result-box error';
            }
        };

        // 按分类显示组件
        window.showComponentsByCategory = async function() {
            const resultDiv = document.getElementById('categories-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box info';
            resultDiv.textContent = '正在加载组件分类信息...';

            try {
                const { autoRegistry } = await import('./src/card2.1/components/auto-registry.ts');
                
                await autoRegistry.initialize();
                const categories = autoRegistry.getAllCategories();

                let result = '=== 按分类显示组件 ===\n\n';
                
                categories.forEach(category => {
                    const components = autoRegistry.getComponentsByCategory(category);
                    result += `📂 ${category} (${components.length} 个组件):\n`;
                    
                    if (components.length === 0) {
                        result += '  (暂无组件)\n';
                    } else {
                        components.forEach(component => {
                            result += `  - ${component.name} (${component.type})\n`;
                        });
                    }
                    result += '\n';
                });

                resultDiv.textContent = result;
                resultDiv.className = 'result-box success';
            } catch (error) {
                resultDiv.textContent = '❌ 显示失败:\n' + error.toString();
                resultDiv.className = 'result-box error';
            }
        };

        // 页面加载完成后自动运行基本测试
        window.addEventListener('load', function() {
            console.log('🚀 Card 2.1 分类系统验证页面已加载');
            console.log('📝 请点击按钮进行各项测试');
            
            // 自动运行分类映射配置测试
            setTimeout(testCategoryMapping, 1000);
        });
    </script>
</body>
</html>