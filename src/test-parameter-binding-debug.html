<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔍 参数绑定调试验证</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #ff7875 0%, #faad14 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }
    .header {
      background: linear-gradient(135deg, #ff7875 0%, #faad14 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      text-align: center;
    }
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 24px;
    }
    .debug-section {
      margin-bottom: 24px;
      padding: 20px;
      border: 2px solid #ff7875;
      border-radius: 8px;
      background: #fff2f0;
    }
    .debug-section h3 {
      margin: 0 0 16px 0;
      color: #ff7875;
      font-size: 18px;
    }
    .problem-item {
      margin: 12px 0;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #ff7875;
    }
    .fix-item {
      margin: 12px 0;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #52c41a;
    }
    .log-sample {
      background: #1f1f1f;
      color: #00ff00;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      margin: 8px 0;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .config-sample {
      background: #f8f8f8;
      border: 1px solid #d9d9d9;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      margin: 8px 0;
      overflow-x: auto;
    }
    .nav-button {
      display: inline-block;
      padding: 10px 20px;
      background: #ff7875;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      margin-right: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    .nav-button:hover {
      background: #ff4d4f;
      transform: translateY(-1px);
    }
    .expected-log {
      background: #f6ffed;
      border: 1px solid #52c41a;
      padding: 12px;
      border-radius: 4px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🔍 参数绑定调试验证</h1>
      <p>专门调试修改设备ID后参数绑定为什么还用默认值的问题</p>
    </div>

    <div class="debug-section">
      <h3>❌ 发现的核心问题</h3>
      
      <div class="problem-item">
        <h4>问题：参数配置中 value 字段为空</h4>
        <p>从你提供的日志配置可以看到：</p>
        <div class="config-sample">{
  "key": "id",
  "value": "",                    // ❌ 空字符串！
  "valueMode": "component",
  "selectedTemplate": "component-property-binding",
  "defaultValue": "1"
}</div>
        <p><strong>根因</strong>：参数绑定需要完整路径如 <code>triple-data-display_1757425833399.customize.deviceId</code>，但实际 value 为空</p>
      </div>

      <div class="problem-item">
        <h4>结果：总是回退到默认值</h4>
        <p>因为 <code>getComponentPropertyValue("")</code> 返回 undefined，触发默认值机制</p>
        <div class="log-sample">🔗 [DataItemFetcher] 路径参数解析: id = 1  ← 使用了默认值而不是最新的 122</div>
      </div>
    </div>

    <div class="debug-section">
      <h3>✅ 实施的修复方案</h3>
      
      <div class="fix-item">
        <h4>修复1：参数解析过程调试日志</h4>
        <p><strong>文件</strong>：<code>/src/core/data-architecture/executors/DataItemFetcher.ts:169-177</code></p>
        <p>添加详细的参数解析调试信息，显示：</p>
        <ul>
          <li>参数键、值、模板类型</li>
          <li>默认值和组件ID</li>
        </ul>
      </div>

      <div class="fix-item">
        <h4>修复2：自动构造属性绑定路径</h4>
        <p><strong>文件</strong>：<code>/src/core/data-architecture/executors/DataItemFetcher.ts:183-188</code></p>
        <p>当 value 为空时，自动构造正确的绑定路径：</p>
        <div class="config-sample">// 🔥 关键修复：如果 value 为空，构造正确的属性绑定路径
if (!bindingPath || bindingPath.trim() === '') {
  // 根据参数配置构造属性绑定路径
  bindingPath = `${this.componentId}.customize.deviceId`
  console.log(`🔧 [DataItemFetcher] 自动构造属性绑定路径: ${bindingPath}`)
}</div>
      </div>

      <div class="fix-item">
        <h4>修复3：属性绑定过程调试增强</h4>
        <p><strong>文件</strong>：<code>/src/core/data-architecture/executors/DataItemFetcher.ts:106-142</code></p>
        <p>在 <code>getComponentPropertyValue</code> 中添加详细调试，显示：</p>
        <ul>
          <li>绑定路径解析过程</li>
          <li>EditorStore 中可用的节点列表</li>
          <li>属性读取结果</li>
        </ul>
      </div>
    </div>

    <div class="debug-section">
      <h3>🧪 测试验证步骤</h3>
      
      <div class="expected-log">
        <h4>预期的新增调试日志（按顺序出现）：</h4>
        <div class="log-sample">🔍 [DataItemFetcher] resolveParameterValue 调试 {
  "paramKey": "id",
  "paramValue": "",
  "selectedTemplate": "component-property-binding",
  "valueMode": "component",
  "defaultValue": "1",
  "componentId": "triple-data-display_1757425833399"
}

🔧 [DataItemFetcher] 自动构造属性绑定路径: triple-data-display_1757425833399.customize.deviceId

🔍 [DataItemFetcher] getComponentPropertyValue 调试 {
  "bindingPath": "triple-data-display_1757425833399.customize.deviceId",
  "currentComponentId": "triple-data-display_1757425833399"
}

🔧 [DataItemFetcher] 解析属性绑定路径 {
  "原始路径": "triple-data-display_1757425833399.customize.deviceId",
  "组件ID": "triple-data-display_1757425833399",
  "属性路径": "customize.deviceId"
}

🎯 [DataItemFetcher] 属性绑定结果 {
  "bindingPath": "triple-data-display_1757425833399.customize.deviceId",
  "actualValue": 122,                    ← 关键：应该是新值 122 而不是默认值 1
  "actualValueType": "string"
}

🔗 [DataItemFetcher] 路径参数解析: id = 122    ← 最终目标：使用新值而不是默认值</div>
      </div>
    </div>

    <div class="debug-section">
      <h3>🎯 测试操作指南</h3>
      
      <p><strong>测试步骤</strong>：</p>
      <ol>
        <li>访问数据源测试页面</li>
        <li>添加 TripleDataDisplay 组件并配置HTTP数据源</li>
        <li>设置路径参数绑定到组件属性</li>
        <li>在属性面板修改 deviceId 从默认值改为 122</li>
        <li><strong>重点观察控制台中新增的调试日志</strong></li>
      </ol>

      <p><strong>成功标志</strong>：</p>
      <ul>
        <li>看到 <code>🔧 自动构造属性绑定路径</code> 日志</li>
        <li>看到 <code>actualValue: 122</code> 而不是默认值</li>
        <li>HTTP请求使用新的设备ID值发送</li>
      </ul>
    </div>

    <div class="debug-section">
      <h3>🔗 测试链接</h3>
      <a href="http://localhost:5002/test/data-source-system" class="nav-button" target="_blank">
        🧪 开始测试验证
      </a>
    </div>

    <div class="debug-section">
      <h3>📋 如果仍有问题</h3>
      <p>请提供完整的控制台日志，特别关注：</p>
      <ul>
        <li><code>🔍 [DataItemFetcher] resolveParameterValue 调试</code> 的完整输出</li>
        <li><code>🔍 [DataItemFetcher] getComponentPropertyValue 调试</code> 的结果</li>
        <li><code>🎯 [DataItemFetcher] 属性绑定结果</code> 中的 actualValue</li>
      </ul>
      <p>这将帮助我们精确定位参数绑定失败的具体环节。</p>
    </div>
  </div>
</body>
</html>