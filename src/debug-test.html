<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card 2.1 系统调试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        h1 { color: #2d3748; margin-bottom: 30px; }
        h2 { color: #4a5568; margin-top: 30px; margin-bottom: 15px; }
        .step {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .highlight {
            background: #fef5e7;
            border-left: 4px solid #f6ad55;
            padding: 15px;
            margin: 15px 0;
        }
        .success { border-left-color: #68d391; background: #f0fff4; }
        .error { border-left-color: #fc8181; background: #fed7d7; }
        .info { border-left-color: #63b3ed; background: #ebf8ff; }
        .warning { border-left-color: #f6ad55; background: #fef5e7; }
        ul li { margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Card 2.1 系统调试页面</h1>
        
        <div class="highlight info">
            <strong>📌 调试目标：</strong>解决 <code>universal-data-viz</code> 组件未出现在 Visual Editor 左侧组件列表的问题。
        </div>

        <h2>🚀 快速开始调试</h2>
        <div class="step">
            <h3>1. 启动开发服务器</h3>
            <div class="code-block">pnpm dev</div>
            <p>在浏览器中访问：<a href="http://localhost:5002">http://localhost:5002</a></p>
        </div>

        <div class="step">
            <h3>2. 打开浏览器开发者工具</h3>
            <ul>
                <li>按 F12 打开开发者工具</li>
                <li>切换到 "Console" 标签</li>
                <li>清空控制台（Ctrl+L 或 Cmd+K）</li>
            </ul>
        </div>

        <div class="step">
            <h3>3. 访问 Visual Editor 测试页面</h3>
            <ul>
                <li>在主应用中导航到：<strong>菜单 → 测试 → 编辑器集成测试</strong></li>
                <li>或直接访问：<code>/test/editor-integration</code></li>
            </ul>
        </div>

        <h2>🔍 关键调试日志</h2>
        <div class="step">
            <p>在控制台中查找以下关键日志标签（按顺序出现）：</p>
            
            <h4>1. 组件加载阶段</h4>
            <div class="code-block">
[ComponentLoader] 正在提取组件ID，路径: ../components/universal-data-viz/index.ts
🎯 [ComponentLoader] 检测到 universal-data-viz 组件路径
🎯 [ComponentLoader] 提取的组件ID: universal-data-viz
[ComponentLoader] Including component: universal-data-viz
            </div>

            <h4>2. 权限检查阶段</h4>
            <div class="code-block">
🎯 [AutoRegistry] universal-data-viz 权限检查: {组件权限: "不限", 用户权限: "TENANT_USER"}
✅ [AutoRegistry] universal-data-viz 权限检查通过: 组件权限为"不限"
            </div>

            <h4>3. 注册检查阶段</h4>
            <div class="code-block">
🎯 [AutoRegistry] universal-data-viz 注册检查: {isRegistered: true, 计算结果: true}
✅ [AutoRegistry] universal-data-viz 注册检查通过
✅ [AutoRegistry] 注册组件: universal-data-viz (通用数据可视化)
            </div>

            <h4>4. Visual Editor 集成阶段</h4>
            <div class="code-block">
🎯 [VisualEditorIntegration] filteredComponents 中是否包含 universal-data-viz: true
            </div>
        </div>

        <h2>❌ 常见问题诊断</h2>
        
        <div class="step">
            <h3>问题1：组件未被加载</h3>
            <div class="highlight error">
                <strong>症状：</strong>控制台中没有看到 <code>[ComponentLoader] 检测到 universal-data-viz 组件路径</code>
            </div>
            <p><strong>解决方法：</strong></p>
            <ul>
                <li>检查文件是否存在：<code>src/card2.1/components/universal-data-viz/index.ts</code></li>
                <li>检查 glob 模式是否正确匹配</li>
                <li>重启开发服务器</li>
            </ul>
        </div>

        <div class="step">
            <h3>问题2：权限检查失败</h3>
            <div class="highlight error">
                <strong>症状：</strong>看到权限检查但结果为 false
            </div>
            <p><strong>解决方法：</strong></p>
            <ul>
                <li>检查组件定义中的 <code>permission: '不限'</code></li>
                <li>检查用户权限设置（localStorage 中的 userInfo）</li>
            </ul>
        </div>

        <div class="step">
            <h3>问题3：注册检查失败</h3>
            <div class="highlight error">
                <strong>症状：</strong>组件被检测到但未注册
            </div>
            <p><strong>解决方法：</strong></p>
            <ul>
                <li>检查组件定义中的 <code>isRegistered: true</code></li>
                <li>检查组件定义的必需字段（type, name, component）</li>
            </ul>
        </div>

        <div class="step">
            <h3>问题4：Visual Editor 集成失败</h3>
            <div class="highlight error">
                <strong>症状：</strong>组件已注册但未出现在编辑器中
            </div>
            <p><strong>解决方法：</strong></p>
            <ul>
                <li>检查 <code>availableWidgets</code> 计算属性的结果</li>
                <li>检查组件转换逻辑是否正确</li>
                <li>检查 WidgetLibrary 组件是否正确使用集成</li>
            </ul>
        </div>

        <h2>🛠️ 手动验证命令</h2>
        <div class="step">
            <p>在浏览器控制台中运行以下命令进行手动验证：</p>
            
            <h4>检查 Card 2.1 系统状态</h4>
            <div class="code-block">
// 在 Vue DevTools 或组件内部执行
const { initializeCard2System, getComponentRegistry } = await import('/src/card2.1/index.ts')
await initializeCard2System()
const registry = getComponentRegistry()
console.log('注册的组件：', registry.getAll().map(c => c.type))
            </div>

            <h4>检查 Visual Editor 集成</h4>
            <div class="code-block">
// 在 WidgetLibrary 组件中检查
console.log('Available Widgets:', this.card2Integration.availableWidgets.value)
console.log('包含 universal-data-viz：', 
  this.card2Integration.availableWidgets.value.some(w => w.type === 'universal-data-viz'))
            </div>
        </div>

        <h2>✅ 成功验证标准</h2>
        <div class="step highlight success">
            <p>当看到以下所有日志时，说明组件加载成功：</p>
            <ol>
                <li>✅ ComponentLoader 成功检测到组件路径</li>
                <li>✅ ComponentLoader 成功提取组件ID</li>
                <li>✅ AutoRegistry 权限检查通过</li>
                <li>✅ AutoRegistry 注册检查通过</li>
                <li>✅ AutoRegistry 成功注册组件</li>
                <li>✅ VisualEditorIntegration 在 filteredComponents 中找到组件</li>
                <li>✅ VisualEditorIntegration 成功转换为 Widget</li>
                <li>✅ WidgetLibrary 在左侧列表中显示组件</li>
            </ol>
        </div>

        <div class="highlight info">
            <p><strong>💡 提示：</strong>如果问题仍然存在，请将完整的控制台日志发送给开发团队进行进一步分析。</p>
        </div>
    </div>
</body>
</html>