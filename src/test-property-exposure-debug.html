<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>属性暴露调试测试</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .json-display { background: #f4f4f4; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 属性暴露调试测试</h1>
        <p>直接检查 propertyExposureRegistry 的注册状态和内容</p>

        <div class="debug-section">
            <h3>1️⃣ 检查注册表状态</h3>
            <button onclick="checkRegistryStatus()">检查注册表</button>
            <div id="registry-status"></div>
        </div>

        <div class="debug-section">
            <h3>2️⃣ 检查simple-display组件属性</h3>
            <button onclick="checkSimpleDisplayProperties()">检查simple-display属性</button>
            <div id="simple-display-properties"></div>
        </div>

        <div class="debug-section">
            <h3>3️⃣ 检查基础配置属性</h3>
            <button onclick="checkBaseConfigProperties()">检查基础配置属性</button>
            <div id="base-config-properties"></div>
        </div>

        <div class="debug-section">
            <h3>4️⃣ 模拟注册过程</h3>
            <button onclick="simulateRegistration()">模拟重新注册</button>
            <div id="registration-result"></div>
        </div>
    </div>

    <script type="module">
        // 检查注册表状态
        window.checkRegistryStatus = async function() {
            try {
                const { propertyExposureRegistry } = await import('./src/card2.1/core/property-exposure.js');
                
                // 通过反射访问内部状态
                const registrations = (propertyExposureRegistry as any).registrations;
                const registrationMap = new Map(registrations);
                
                const status = {
                    totalRegistrations: registrationMap.size,
                    registeredTypes: Array.from(registrationMap.keys()),
                    detailed: {}
                };
                
                // 获取每个组件的详细信息
                for (const [type, config] of registrationMap.entries()) {
                    status.detailed[type] = {
                        componentName: config.componentName,
                        propertiesCount: config.listenableProperties?.length || 0,
                        properties: config.listenableProperties?.map(p => ({
                            name: p.name,
                            type: p.type,
                            group: p.group,
                            isCore: p.isCore
                        })) || []
                    };
                }
                
                document.getElementById('registry-status').innerHTML = `<div class="json-display">${JSON.stringify(status, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('registry-status').innerHTML = `<div style="color: red;">错误: ${error.message}</div>`;
            }
        };

        // 检查simple-display组件的属性
        window.checkSimpleDisplayProperties = async function() {
            try {
                const { propertyExposureRegistry } = await import('./src/card2.1/core/property-exposure.js');
                
                const exposure = propertyExposureRegistry.getComponentExposure('simple-display');
                
                const result = {
                    exists: !!exposure,
                    componentName: exposure?.componentName,
                    propertiesCount: exposure?.listenableProperties?.length || 0,
                    properties: exposure?.listenableProperties?.map(p => ({
                        name: p.name,
                        label: p.label,
                        type: p.type,
                        group: p.group,
                        isCore: p.isCore,
                        description: p.description
                    })) || [],
                    hasDeviceId: exposure?.listenableProperties?.some(p => p.name === 'deviceId') || false,
                    hasMetricsList: exposure?.listenableProperties?.some(p => p.name === 'metricsList') || false
                };
                
                document.getElementById('simple-display-properties').innerHTML = `<div class="json-display">${JSON.stringify(result, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('simple-display-properties').innerHTML = `<div style="color: red;">错误: ${error.message}</div>`;
            }
        };

        // 检查基础配置属性定义
        window.checkBaseConfigProperties = async function() {
            try {
                const { getBaseConfigurationProperties } = await import('./src/card2.1/core/property-exposure.js');
                
                const baseProperties = getBaseConfigurationProperties();
                
                const result = {
                    count: baseProperties.length,
                    deviceFields: baseProperties.filter(p => ['deviceId', 'metricsList'].includes(p.name)),
                    allProperties: baseProperties.map(p => ({
                        name: p.name,
                        label: p.label,
                        type: p.type,
                        group: p.group,
                        isCore: p.isCore
                    }))
                };
                
                document.getElementById('base-config-properties').innerHTML = `<div class="json-display">${JSON.stringify(result, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('base-config-properties').innerHTML = `<div style="color: red;">错误: ${error.message}</div>`;
            }
        };

        // 模拟重新注册过程
        window.simulateRegistration = async function() {
            try {
                const { ComponentRegistry } = await import('./src/card2.1/core/component-registry.js');
                const { propertyExposureRegistry } = await import('./src/card2.1/core/property-exposure.js');
                
                // 检查组件是否已注册
                const hasSimpleDisplay = ComponentRegistry.has('simple-display');
                const definition = ComponentRegistry.get('simple-display');
                
                // 尝试重新注册
                if (definition) {
                    ComponentRegistry.register(definition);
                }
                
                // 检查注册后的状态
                const exposure = propertyExposureRegistry.getComponentExposure('simple-display');
                
                const result = {
                    componentRegistered: hasSimpleDisplay,
                    definitionExists: !!definition,
                    exposureAfterReRegister: {
                        exists: !!exposure,
                        propertiesCount: exposure?.listenableProperties?.length || 0,
                        hasDeviceId: exposure?.listenableProperties?.some(p => p.name === 'deviceId') || false,
                        hasMetricsList: exposure?.listenableProperties?.some(p => p.name === 'metricsList') || false
                    }
                };
                
                document.getElementById('registration-result').innerHTML = `<div class="json-display">${JSON.stringify(result, null, 2)}</div>`;
                
            } catch (error) {
                document.getElementById('registration-result').innerHTML = `<div style="color: red;">错误: ${error.message}</div>`;
            }
        };

        // 页面加载后自动运行检查
        window.addEventListener('load', function() {
            console.log('🔍 [PropertyExposureDebug] 页面已加载，开始调试...');
            
            // 延迟检查，确保模块加载完成
            setTimeout(function() {
                checkRegistryStatus();
                checkSimpleDisplayProperties();
                checkBaseConfigProperties();
            }, 1000);
        });
    </script>
</body>
</html>