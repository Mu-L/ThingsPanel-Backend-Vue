# Visual Editor 配置系统

## 1. 概述

Visual Editor 的配置系统是其灵活性的核心。它允许开发者和用户通过声明式的方式定义组件的外观、行为和数据绑定。配置系统设计的目标是实现**自动化**、**标准化**和**易于扩展**。

## 2. 核心概念

- **配置组件 (Config Components)**: 用于修改组件配置的 Vue 组件。它们通常是表单，允许用户通过图形界面来编辑配置。
- **配置发现 (Config Discovery)**: 一个自动扫描和注册配置组件的机制。它使得开发者可以轻松地为新组件添加配置界面，而无需手动注册。
- **数据需求 (Data Requirements)**: 组件对其数据源的声明。这使得编辑器可以动态地为组件提供合适的数据源配置选项。
- **API 配置 (API Config)**: 根据组件类型自动配置数据源 API 的系统。这简化了数据绑定的过程。

## 3. 配置发现 (`ConfigDiscovery.ts`)

`ConfigDiscovery` 类负责自动发现和注册所有可用的配置组件。它的主要特点包括：

- **多种路径模式**: 支持扫描多种不同的文件路径模式，以兼容不同来源的组件（例如 Card 2.1、旧版 Panel 和 Visual Editor 自身的组件）。
- **性能优化**: 
    - **缓存**: 缓存扫描结果，避免在每次加载时都重新扫描文件系统。
    - **并行扫描**: 同时处理多个扫描任务，以加快发现过程。
    - **懒加载**: 使用 `defineAsyncComponent` 按需加载配置组件，以减少初始加载时间。

## 4. 组件数据需求 (`component-data-requirements.ts`)

该文件定义了一个标准化的方式，让组件可以声明它们需要什么样的数据。这通过 `ComponentDataRequirementsBuilder` 类来实现，它提供了一个链式 API 来构建数据需求声明。

一个组件可以声明它需要一个或多个数据源，并为每个数据源指定：

- **ID 和名称**: 用于在界面上标识数据源。
- **类型**: 数据源的类型，例如 `device`、`http` 或 `static`。
- **结构**: 数据的结构，例如是单个对象还是数组。
- **字段**: 数据应包含的字段，包括字段名、类型、描述和示例值。

此外，系统还提供了预定义的数据源模板（例如 `JSON_OBJECT`, `TIME_SERIES`），以简化常见数据结构的声明。

## 5. 组件 API 配置 (`component-api-config.ts`)

这个系统将组件的数据需求与后端 API 连接起来。它维护一个注册表，将组件类型映射到特定的 API 配置。

`ComponentApiConfig` 接口定义了：

- **API 类型**: 主要和备用的 API 端点。
- **数据源类型**: 通常是 `device`。
- **轮询**: 是否需要轮询数据。
- **支持的指标类型**: 组件支持的数据类型，例如 `telemetry`、`attributes` 或 `command`。

`selectApiForComponent` 函数根据组件类型和所需的指标类型，自动选择最合适的 API。这使得组件开发者可以专注于组件的业务逻辑，而将数据获取的复杂性交给配置系统来处理。

## 6. 如何为组件添加配置

1.  **创建配置组件**: 创建一个 Vue 组件，它提供一个表单来编辑组件的配置。将该组件放置在 `visual-editor/components/config` 目录下，并以 `*Config.vue` 结尾。
2.  **声明数据需求**: 在你的组件代码中，使用 `ComponentDataRequirementsBuilder` 来声明组件的数据需求。
3.  **（可选）注册 API 配置**: 如果你的组件需要与特定的设备 API 交互，可以在 `component-api-config.ts` 中为其添加一个条目。

通过遵循这些步骤，你的组件将无缝地集成到 Visual Editor 的配置系统中，用户将能够通过自动生成的界面来配置它。