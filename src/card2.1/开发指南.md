# Card 2.1 组件开发指南

## 概述

本文档总结了 Card 2.1 组件系统的开发流程和关键要点，基于仪表盘组件（gauge-chart）的完整开发过程整理。

## 组件开发流程

### 1. 文件结构创建

Card 2.1 组件必须遵循以下文件结构：

```
src/card2.1/components/
└── [category]/        # 类别文件夹（如 chart, system, alarm）
    └── [subcategory]/ # 子类别（如 data, status）
        └── [component-name]/
            ├── definition.ts      # 组件定义和元数据
            ├── index.vue          # 组件实现
            ├── setting.vue        # 配置面板UI
            ├── settingConfig.ts   # 配置项类型定义
            └── index.ts           # 导出文件
```

#### 示例：仪表盘组件
```
src/card2.1/components/chart/data/gauge-chart/
├── definition.ts
├── index.vue
├── setting.vue
├── settingConfig.ts
└── index.ts
```

### 2. 组件定义（definition.ts）

#### 必需字段
```typescript
export const gaugeChartDefinition: ComponentDefinition = {
  // 基础信息
  id: 'gauge-chart',
  name: '仪表盘',
  description: '圆形仪表盘图表，用于显示单个数值及其在范围内的位置',
  category: 'chart',
  subCategory: 'data',
  version: '1.0.0',

  // 组件配置
  component: GaugeChartCustomize,

  // 🔥 关键：数据源定义
  dataSources: [
    {
      key: 'main',
      name: '数据源',
      description: '仪表盘的主要数据源',
      supportedTypes: ['static', 'api', 'websocket'],
      required: false,
      // 🔥 重要：提供示例值
      example: {
        value: 75,
        unit: '℃',
        metricsName: '温度',
        timestamp: '2025-10-15T10:30:00.000Z'
      }
    }
  ],

  // 交互能力（可选）
  interactionCapabilities: {
    canTrigger: false,
    canReceive: false,
    exposedProperties: []
  }
}
```

#### 数据源设计原则

**单一数据源 vs 多数据源**

- ✅ **单一数据源**：适用于大多数组件
  ```typescript
  dataSources: [{
    key: 'main',
    example: { value, unit, metricsName, timestamp }
  }]
  ```

- ✅ **多数据源**：仅用于多系列图表（多条曲线、多柱状图等）
  ```typescript
  dataSources: [
    { key: 'series1', example: {...} },
    { key: 'series2', example: {...} }
  ]
  ```

**数据源 vs 配置项**

- **数据源（dataSources）**：动态数据，来自 API、WebSocket 等
- **配置项（component）**：静态设置，如颜色、尺寸、最小值、最大值

### 3. 配置类型定义（settingConfig.ts）

```typescript
export interface GaugeChartCustomize {
  // 数据配置（静态配置，非数据源）
  value?: number        // 默认值
  min?: number          // 最小值
  max?: number          // 最大值
  title?: string        // 标题
  unit?: string         // 单位

  // 样式配置
  radius?: string       // 仪表盘半径
  thickness?: number    // 指示器粗细
  titleColor?: string   // 标题颜色
  valueColor?: string   // 数值颜色

  // 动画配置
  animationDuration?: number
}
```

### 4. 组件实现（index.vue）

#### 关键要点

**4.1 使用 useCard2Props Hook**

```typescript
// 🔥 关键修复：data 必须传入 computed 包装
const { unifiedConfig, displayData } = useCard2Props({
  config: props.config,
  data: computed(() => props.data),  // ✅ 正确：建立响应式依赖
  // data: props.data,                // ❌ 错误：无法响应变化
  componentId: props.componentId
})
```

**为什么必须使用 `computed(() => props.data)`？**

- `props.data` 是响应式数据，但直接传递只会传递当前值的快照
- `computed(() => props.data)` 创建计算属性，建立响应式依赖链
- 当 `props.data` 更新时，计算属性会重新执行，触发 `useCard2Props` 内部的 `displayData` 更新

**4.2 数据访问路径**

数据源返回的数据结构：
```typescript
{
  main: {           // 数据源 key
    data: {         // 实际数据
      value: 75,
      unit: '℃',
      metricsName: '温度',
      timestamp: '...'
    }
  }
}
```

访问方式：
```typescript
const displayValue = computed(() => {
  // 数据源优先，配置值兜底
  const dataSourceValue = displayData.value?.main?.data?.value
  return Number(dataSourceValue ?? unifiedConfig.value.component?.value ?? 75)
})
```

**4.3 完整示例**

```vue
<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'
import { useCard2Props } from '@/card2.1/hooks'
import type { GaugeChartCustomize } from './settingConfig'

interface Props {
  config: GaugeChartCustomize
  data?: Record<string, unknown>
  componentId?: string
}

const props = withDefaults(defineProps<Props>(), {
  data: () => ({})
})

// 🔥 关键：使用 computed 包装 props.data
const { unifiedConfig, displayData } = useCard2Props({
  config: props.config,
  data: computed(() => props.data),
  componentId: props.componentId
})

// 计算显示值（数据源优先）
const displayValue = computed(() => {
  const dataSourceValue = displayData.value?.main?.data?.value
  return Number(dataSourceValue ?? unifiedConfig.value.component?.value ?? 75)
})

// 组件逻辑...
</script>
```

### 5. 配置面板（setting.vue）

使用 Naive UI 组件构建配置界面：

```vue
<template>
  <n-space vertical :size="16">
    <n-form-item label="当前值">
      <n-input-number
        v-model:value="localConfig.value"
        :min="0"
        :max="100"
        @update:value="handleConfigChange"
      />
    </n-form-item>

    <!-- 更多配置项... -->
  </n-space>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue'
import { NSpace, NFormItem, NInputNumber } from 'naive-ui'
import type { GaugeChartCustomize } from './settingConfig'

// Props 和 emits
const props = defineProps<{ config: GaugeChartCustomize }>()
const emit = defineEmits<{
  (e: 'update:config', config: GaugeChartCustomize): void
}>()

// 本地配置
const localConfig = ref<GaugeChartCustomize>({ ...props.config })

// 配置变更处理
const handleConfigChange = () => {
  emit('update:config', { ...localConfig.value })
}

// 监听外部配置变化
watch(() => props.config, (newConfig) => {
  localConfig.value = { ...newConfig }
}, { deep: true })
</script>
```

### 6. 组件注册

#### 6.1 类别映射

在 `src/card2.1/core2/registry/category-definition.ts` 添加映射：

```typescript
export const COMPONENT_TO_CATEGORY_MAP: Record<string, string> = {
  // ... 其他组件
  'gauge-chart': 'data',  // 新增仪表盘组件映射
}
```

#### 6.2 自动注册

系统通过 `import.meta.glob` 自动发现和注册组件，无需手动注册。

### 7. 常见问题和解决方案

#### 问题1：组件显示默认值，不显示数据源数据

**原因**：响应式依赖链断裂

**解决方案**：
```typescript
// ❌ 错误
const { displayData } = useCard2Props({
  data: props.data
})

// ✅ 正确
const { displayData } = useCard2Props({
  data: computed(() => props.data)
})
```

#### 问题2：示例值未在数据源配置界面显示

**原因**：示例值访问路径错误

**解决方案**：
```typescript
// ❌ 错误
const exampleData = currentDataSource?.originalData?.originalData?.example

// ✅ 正确
const exampleData = currentDataSource?.originalData?.example
```

#### 问题3：组件归类到 "other" 分类

**原因**：未在 COMPONENT_TO_CATEGORY_MAP 添加映射

**解决方案**：
在 `category-definition.ts` 添加组件ID到分类的映射

#### 问题4：数据源结构识别失败

**原因**：`useCard2Props` 的 `isDataFromWarehouse` 检查不支持嵌套结构

**解决方案**：
系统已支持嵌套结构识别（如 `{ main: { data: {...} } }`），无需额外处理

## 开发检查清单

开发新组件时，按以下清单逐项检查：

### 文件结构
- [ ] 创建正确的目录结构
- [ ] 包含所有必需文件（definition.ts, index.vue, setting.vue, settingConfig.ts, index.ts）

### 组件定义
- [ ] 定义正确的 category 和 subCategory
- [ ] 数据源设计合理（单一 vs 多数据源）
- [ ] 提供完整的示例值（example）
- [ ] 区分数据源和配置项

### 组件实现
- [ ] 使用 `computed(() => props.data)` 包装 data 参数
- [ ] 正确访问数据路径（displayData.value?.main?.data?.xxx）
- [ ] 数据源优先，配置值兜底
- [ ] 添加详细的中文注释

### 配置面板
- [ ] 使用 Naive UI 组件
- [ ] 实现双向绑定（v-model 和 emit）
- [ ] 监听外部配置变化

### 组件注册
- [ ] 在 COMPONENT_TO_CATEGORY_MAP 添加映射
- [ ] 验证组件出现在正确的分类下

### 测试验证
- [ ] 静态配置能正确显示
- [ ] 数据源数据能正确显示
- [ ] 数据源更新时组件响应式更新
- [ ] 配置面板修改能实时生效

## 最佳实践

1. **优先使用 Naive UI 组件**：避免重复造轮子
2. **完整的类型定义**：避免使用 `any`
3. **详细的中文注释**：特别是业务逻辑和关键修复点
4. **响应式依赖**：传递 props 时必须使用 `computed` 或 `toRef`
5. **数据源设计**：遵循单一职责，区分动态数据和静态配置
6. **示例值完整**：确保数据源配置界面能正确预览

## 调试技巧

### 查看数据流
```typescript
// 在组件中添加临时日志
console.log('displayData:', displayData.value)
console.log('unifiedConfig:', unifiedConfig.value)
```

### 验证响应式
```typescript
// 检查 computed 是否被触发
const displayValue = computed(() => {
  console.log('displayValue computed 被触发')
  return displayData.value?.main?.data?.value
})
```

### 检查数据源执行
打开浏览器开发者工具，查看 Network 面板和 Console 面板，确认：
- API 请求成功
- 数据格式正确
- 组件接收到数据更新

## 参考组件

推荐参考以下组件的实现：
- **仪表盘组件**：`src/card2.1/components/chart/data/gauge-chart/`
- **数字指示器**：`src/card2.1/components/chart/data/digit-indicator/`

## 总结

Card 2.1 组件开发的核心要点：

1. **严格的文件结构**：保证自动注册机制正常工作
2. **正确的数据源设计**：单一数据源优先，区分数据和配置
3. **响应式依赖处理**：使用 `computed(() => props.data)` 建立依赖链
4. **标准化配置接口**：使用 `useCard2Props` 统一管理配置
5. **完整的类型定义**：TypeScript 严格模式，避免 `any`

遵循本指南，可以快速开发出符合 Card 2.1 架构规范的高质量组件。
