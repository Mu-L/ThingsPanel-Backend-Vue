<template>
  <div class="data-source-config-form">
    <n-collapse :default-expanded-names="[props.dataSources[0]?.key]" accordion>
      <n-collapse-item v-for="dataSource in props.dataSources" :key="dataSource.key" :name="dataSource.key">
        <template #header>
          <div class="data-source-header">
            <span>{{ dataSource.name || dataSource.key }} ({{ getDataTypeText(dataSource) }})</span>
            <!-- üî• Êñ∞Â¢ûÔºöÁ§∫‰æãÊï∞ÊçÆÊèêÁ§∫ÂõæÊ†á -->
            <n-tooltip placement="right" trigger="hover">
              <template #trigger>
                <n-icon size="16" class="example-data-icon">
                  <InformationCircleOutline />
                </n-icon>
              </template>
              <div class="example-data-tooltip">
                <div class="tooltip-title">Á§∫‰æãÊï∞ÊçÆÊ†ºÂºè:</div>
                <div class="example-code-container">
                  <pre class="example-code">{{ getExampleDataCode(dataSource) }}</pre>
                </div>
              </div>
            </n-tooltip>
          </div>
        </template>
        <!-- Êï∞ÊçÆÊ∫êÈÖçÁΩÆÂÜÖÂÆπ -->
        <div class="data-source-content">
          <n-space vertical :size="16">
            <!-- ÂéüÂßãÊï∞ÊçÆÁÆ°ÁêÜ -->
            <div>
              <n-text strong>ÂéüÂßãÊï∞ÊçÆÁÆ°ÁêÜ:</n-text>
              <n-space vertical :size="8" style="margin-top: 8px">
                <!-- Ê∑ªÂä†ÂéüÂßãÊï∞ÊçÆÊåâÈíÆ - ÂºπÁ™óÂΩ¢Âºè -->
                <n-button type="dashed" size="small" class="add-data-btn" @click="openAddRawDataModal(dataSource.key)">
                  <template #icon>
                    <n-icon size="14">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                      </svg>
                    </n-icon>
                  </template>
                  Ê∑ªÂä†Êï∞ÊçÆÈ°π
                </n-button>

                <!-- ÂéüÂßãÊï∞ÊçÆÂàóË°® -->
                <div v-if="dataValues[dataSource.key]?.rawDataList?.length > 0" class="raw-data-list">
                  <n-text depth="3" style="font-size: 12px">
                    ÂéüÂßãÊï∞ÊçÆÂàóË°® ({{ dataValues[dataSource.key].rawDataList.length }} È°π):
                  </n-text>
                  <n-space vertical :size="4" style="margin-top: 4px">
                    <div
                      v-for="rawDataItem in dataValues[dataSource.key].rawDataList"
                      :key="rawDataItem.id"
                      class="raw-data-item-compact"
                    >
                      <n-space align="center" justify="space-between">
                        <n-space align="center" :size="8">
                          <span class="raw-data-name">{{ rawDataItem.name }}</span>
                          <!-- üî• Êñ∞Â¢ûÔºöÊòæÁ§∫Êï∞ÊçÆÈ°πÁ±ªÂûã -->
                          <n-tag :type="getDataItemTypeColor(rawDataItem.type)" size="small" round>
                            {{ rawDataItem.type?.toUpperCase() || 'JSON' }}
                          </n-tag>
                        </n-space>
                        <n-space :size="4">
                          <n-button
                            size="tiny"
                            quaternary
                            type="info"
                            class="compact-btn"
                            @click="viewRawDataDetail(dataSource.key, rawDataItem.id)"
                          >
                            Êü•Áúã
                          </n-button>
                          <!-- üî• Êñ∞Â¢ûÔºöÁºñËæëÊåâÈíÆ -->
                          <n-button
                            size="tiny"
                            quaternary
                            type="warning"
                            class="compact-btn"
                            @click="editRawData(dataSource.key, rawDataItem.id)"
                          >
                            ÁºñËæë
                          </n-button>
                          <n-button
                            size="tiny"
                            quaternary
                            type="error"
                            class="compact-btn"
                            @click="deleteRawData(dataSource.key, rawDataItem.id)"
                          >
                            Âà†Èô§
                          </n-button>
                        </n-space>
                      </n-space>
                    </div>
                  </n-space>
                </div>
                <n-text v-else depth="3" style="font-size: 12px">ÊöÇÊó†ÂéüÂßãÊï∞ÊçÆÈ°π</n-text>
              </n-space>
            </div>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <n-space :size="8">
              <n-button @click="resetData(dataSource.key)">ÈáçÁΩÆ‰∏∫ÈªòËÆ§</n-button>
              <n-button type="info" @click="showCurrentFinalData(dataSource.key)">Êü•ÁúãÂΩìÂâçÊï∞ÊçÆÊ∫êÊúÄÁªàÊï∞ÊçÆ</n-button>
            </n-space>
          </n-space>
        </div>
      </n-collapse-item>
    </n-collapse>
  </div>

  <!-- Ê∑ªÂä†/ÁºñËæëÂéüÂßãÊï∞ÊçÆÂºπÁ™ó - Â∑¶Âè≥ÂàÜÊ†èÂ∏ÉÂ±Ä -->
  <n-modal
    v-model:show="showAddRawDataModal"
    preset="dialog"
    :title="isEditMode ? 'ÁºñËæëÊï∞ÊçÆÈ°π' : 'Ê∑ªÂä†Êï∞ÊçÆÈ°π'"
    style="width: 1400px"
  >
    <n-grid :cols="2" :x-gap="12">
      <!-- Â∑¶‰æßÔºöÊï∞ÊçÆËé∑ÂèñÂå∫Âüü -->
      <n-grid-item>
        <n-space vertical :size="4">
          <n-text strong style="font-size: 13px; color: var(--primary-color)">üì• Êï∞ÊçÆËé∑Âèñ</n-text>

          <!-- Âü∫Êú¨‰ø°ÊÅØ -->
          <n-grid :cols="2" :x-gap="6">
            <n-grid-item>
              <n-form-item label="ÂêçÁß∞" size="small" :label-width="50">
                <n-input v-model:value="newRawDataName" placeholder="Áî®Êà∑Êï∞ÊçÆ" clearable size="small" />
              </n-form-item>
            </n-grid-item>
            <n-grid-item>
              <n-form-item label="Á±ªÂûã" size="small" :label-width="50">
                <n-space :size="4">
                  <n-tag
                    v-for="type in ['json', 'http', 'websocket']"
                    :key="type"
                    :type="newRawDataType === type ? 'primary' : 'default'"
                    :bordered="newRawDataType !== type"
                    checkable
                    :checked="newRawDataType === type"
                    style="cursor: pointer; user-select: none"
                    size="small"
                    @click="newRawDataType = type as RawDataItemType"
                  >
                    {{ type.toUpperCase() }}
                  </n-tag>
                </n-space>
              </n-form-item>
            </n-grid-item>
          </n-grid>

          <!-- Êï∞ÊçÆÂΩïÂÖ•Âå∫Âüü -->
          <n-card size="small" :bordered="false" style="background: var(--hover-color); margin: 2px 0">
            <template #header>
              <n-text depth="2" style="font-size: 11px">Êï∞ÊçÆÂΩïÂÖ•</n-text>
            </template>

            <!-- JSONÊï∞ÊçÆËæìÂÖ• -->
            <div v-if="newRawDataType === 'json'">
              <n-form-item label="JSONÊï∞ÊçÆ" size="small" :label-width="60" style="margin-bottom: 2px">
                <n-input
                  v-model:value="newRawDataJsonContent"
                  type="textarea"
                  :rows="8"
                  :placeholder="getJsonPlaceholder()"
                  size="small"
                  style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; font-size: 11px"
                  @input="updatePreviewData"
                />
              </n-form-item>
            </div>

            <!-- HTTPÊï∞ÊçÆËæìÂÖ• -->
            <div v-else-if="newRawDataType === 'http'">
              <n-space vertical :size="3">
                <n-form-item label="ËØ∑Ê±ÇURL" size="small" :label-width="60" style="margin-bottom: 2px">
                  <n-input
                    v-model:value="newRawDataHttpUrl"
                    placeholder="https://api.example.com/data"
                    clearable
                    size="small"
                    @input="updatePreviewData"
                  />
                </n-form-item>
                <n-form-item label="ËØ∑Ê±ÇÊñπÊ≥ï" size="small" :label-width="60" style="margin-bottom: 2px">
                  <n-select
                    v-model:value="newRawDataHttpMethod"
                    :options="[
                      { label: 'GET', value: 'GET' },
                      { label: 'POST', value: 'POST' },
                      { label: 'PUT', value: 'PUT' },
                      { label: 'DELETE', value: 'DELETE' }
                    ]"
                    size="small"
                    @update:value="updatePreviewData"
                  />
                </n-form-item>
                <n-form-item label="ËØ∑Ê±ÇÂ§¥" size="small" :label-width="60" style="margin-bottom: 0">
                  <n-input
                    v-model:value="newRawDataHttpHeaders"
                    type="textarea"
                    :rows="3"
                    placeholder='{"Content-Type": "application/json"}'
                    size="small"
                    style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; font-size: 11px"
                    @input="updatePreviewData"
                  />
                </n-form-item>
              </n-space>
            </div>

            <!-- WebSocketÊï∞ÊçÆËæìÂÖ• -->
            <div v-else-if="newRawDataType === 'websocket'">
              <n-space vertical :size="3">
                <n-form-item label="WebSocket URL" size="small" :label-width="80" style="margin-bottom: 2px">
                  <n-input
                    v-model:value="newRawDataWebsocketUrl"
                    placeholder="ws://localhost:8080/ws"
                    clearable
                    size="small"
                    @input="updatePreviewData"
                  />
                </n-form-item>
                <n-form-item label="ÂçèËÆÆ" size="small" :label-width="80" style="margin-bottom: 0">
                  <n-input
                    v-model:value="newRawDataWebsocketProtocols"
                    placeholder="protocol1,protocol2"
                    clearable
                    size="small"
                    @input="updatePreviewData"
                  />
                </n-form-item>
              </n-space>
            </div>
          </n-card>

          <!-- Êï∞ÊçÆÂ±ïÁ§∫Âå∫Âüü -->
          <n-card size="small" :bordered="false" style="background: var(--hover-color); margin: 2px 0">
            <template #header>
              <n-text depth="2" style="font-size: 11px">ÂéüÂßãÊï∞ÊçÆÈ¢ÑËßà</n-text>
            </template>
            <n-code
              :code="previewOriginalData"
              language="json"
              style="max-height: 220px; overflow-y: auto; font-size: 10px"
              :show-line-numbers="false"
            />
          </n-card>
        </n-space>
      </n-grid-item>

      <!-- Âè≥‰æßÔºöÊï∞ÊçÆÂ§ÑÁêÜÂå∫Âüü -->
      <n-grid-item>
        <n-space vertical :size="4">
          <n-text strong style="font-size: 13px; color: var(--success-color)">‚öôÔ∏è Êï∞ÊçÆÂ§ÑÁêÜ</n-text>

          <!-- Â§ÑÁêÜÈÖçÁΩÆÂå∫Âüü -->
          <n-card size="small" :bordered="false" style="background: var(--hover-color); margin: 2px 0">
            <template #header>
              <n-text depth="2" style="font-size: 11px">Â§ÑÁêÜÈÖçÁΩÆ</n-text>
            </template>

            <n-space vertical :size="3">
              <!-- ËøáÊª§Ë∑ØÂæÑ -->
              <n-form-item label="ËøáÊª§Ë∑ØÂæÑ" size="small" :label-width="60" style="margin-bottom: 2px">
                <n-input
                  v-model:value="currentFilterPath"
                  placeholder="$.data.list"
                  clearable
                  size="small"
                  @input="updatePreviewData"
                />
              </n-form-item>

              <!-- Â§ÑÁêÜËÑöÊú¨ -->
              <n-form-item size="small" :label-width="60" style="margin-bottom: 0">
                <template #label>
                  <n-space :size="2" align="center">
                    <span style="font-size: 11px">Â§ÑÁêÜËÑöÊú¨</span>
                    <n-tooltip placement="top" trigger="hover">
                      <template #trigger>
                        <n-icon size="10" style="color: var(--info-color); cursor: help">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                            <path
                              d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                            />
                            <path
                              d="M12 17h.01"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                            />
                          </svg>
                        </n-icon>
                      </template>
                      <div style="max-width: 260px">
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 11px">üìù ËÑöÊú¨ÁºñÂÜôÊåáÂçó</div>
                        <div style="font-size: 10px; line-height: 1.2">
                          <p style="margin: 2px 0">
                            <strong>ÂèØÁî®ÂèòÈáèÔºö</strong>
                            <br />
                            ‚Ä¢ data - ËæìÂÖ•Êï∞ÊçÆ
                          </p>
                          <p style="margin: 2px 0">
                            <strong>Â∏∏Áî®Êìç‰ΩúÔºö</strong>
                            <br />
                            ‚Ä¢ ‰øÆÊîπÂ≠óÊÆµÔºödata.newField = data.oldField
                            <br />
                            ‚Ä¢ Âà†Èô§Â≠óÊÆµÔºödelete data.fieldName
                            <br />
                            ‚Ä¢ ËøîÂõûÁªìÊûúÔºöreturn data
                          </p>
                          <p style="margin: 2px 0">
                            <strong>Ê≥®ÊÑèÔºö</strong>
                            ‰ΩøÁî® var ÂÆö‰πâÂèòÈáè
                          </p>
                        </div>
                      </div>
                    </n-tooltip>
                  </n-space>
                </template>
                <Codemirror
                  v-model:value="currentProcessScript"
                  :options="{
                    mode: 'javascript',
                    theme: 'default',
                    lineNumbers: true,
                    lineWrapping: true,
                    foldGutter: true,
                    gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
                    tabSize: 2,
                    indentUnit: 2,
                    smartIndent: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    highlightActiveLineGutter: true,
                    highlightSelectionMatches: { showToken: /\w/, annotateScrollbar: true }
                  }"
                  :height="200"
                  @change="updatePreviewData"
                />
              </n-form-item>
            </n-space>
          </n-card>

          <!-- Â§ÑÁêÜÁªìÊûúÂå∫Âüü -->
          <n-card size="small" :bordered="false" style="background: var(--hover-color); margin: 2px 0">
            <template #header>
              <n-space justify="space-between" align="center" style="margin: 0">
                <n-text depth="2" style="font-size: 11px">Â§ÑÁêÜÁªìÊûú</n-text>
                <n-tag :type="previewStatus.type" size="small" style="font-size: 10px">
                  {{ previewStatus.text }}
                </n-tag>
              </n-space>
            </template>

            <n-space vertical :size="2">
              <n-code
                :code="previewProcessedData"
                language="json"
                style="max-height: 250px; overflow-y: auto; font-size: 10px"
                :show-line-numbers="false"
              />

              <!-- Â§ÑÁêÜÁä∂ÊÄÅÊ∂àÊÅØ -->
              <div v-if="previewStatus.message" style="margin-top: 2px">
                <n-text depth="3" style="font-size: 10px">
                  {{ previewStatus.message }}
                </n-text>
              </div>
            </n-space>
          </n-card>
        </n-space>
      </n-grid-item>
    </n-grid>

    <template #action>
      <n-space :size="12" justify="end">
        <n-button size="medium" @click="cancelEdit">ÂèñÊ∂à</n-button>
        <n-button
          size="medium"
          type="primary"
          :disabled="!newRawDataName || !newRawDataName.trim()"
          @click="handleConfirmClick"
        >
          {{ isEditMode ? '‰øùÂ≠ò‰øÆÊîπ' : 'Á°ÆËÆ§Ê∑ªÂä†' }}
        </n-button>
      </n-space>
    </template>
  </n-modal>

  <!-- Êü•ÁúãÊúÄÁªàÊï∞ÊçÆÂºπÁ™ó -->
  <n-modal v-model:show="showFinalDataModal" preset="dialog" title="ÂΩìÂâçÊï∞ÊçÆÊ∫êÊúÄÁªàÊï∞ÊçÆ" style="width: 600px">
    <n-space vertical :size="12">
      <n-text>Êï∞ÊçÆÊ∫ê "{{ currentDataSourceKey }}" ÁöÑÂΩìÂâçÊúÄÁªàÊï∞ÊçÆÔºö</n-text>
      <n-code
        :code="currentFinalData"
        language="json"
        :show-line-numbers="true"
        style="max-height: 400px; overflow-y: auto"
      />
    </n-space>
    <template #action>
      <n-button @click="showFinalDataModal = false">ÂÖ≥Èó≠</n-button>
    </template>
  </n-modal>

  <!-- Êü•ÁúãÂéüÂßãÊï∞ÊçÆËØ¶ÊÉÖÂºπÁ™ó -->
  <n-modal v-model:show="showRawDataDetailModal" preset="dialog" title="ÂéüÂßãÊï∞ÊçÆËØ¶ÊÉÖ" style="width: 600px">
    <n-space vertical :size="12">
      <n-text>Êï∞ÊçÆÈ°π "{{ currentRawDataName }}" ÁöÑËØ¶ÁªÜÂÜÖÂÆπÔºö</n-text>
      <n-code
        :code="currentRawDataDetail"
        language="json"
        :show-line-numbers="true"
        style="max-height: 400px; overflow-y: auto"
      />
    </n-space>
    <template #action>
      <n-button @click="showRawDataDetailModal = false">ÂÖ≥Èó≠</n-button>
    </template>
  </n-modal>
</template>

<script setup lang="ts">
/**
 * Êï∞ÊçÆÊ∫êÈÖçÁΩÆË°®Âçï - ÊûÅÁÆÄÈáçÂÜôÁâàÊú¨
 * ÁõÆÊ†áÔºöÂÆûÁé∞Âü∫Á°ÄÊï∞ÊçÆÊµÅÈó≠ÁéØ
 */

import { ref, reactive, watch, computed, onMounted } from 'vue'
import {
  NCollapse,
  NCollapseItem,
  NSpace,
  NText,
  NCode,
  NButton,
  NTooltip,
  NIcon,
  NModal,
  NCard,
  NInput,
  NList,
  NListItem,
  NThing,
  NTime,
  NFormItem,
  NAlert,
  NTag,
  NGrid,
  NGridItem
} from 'naive-ui'
import { InformationCircleOutline } from '@vicons/ionicons5'
// import { configurationManager } from '../ConfigurationManager'

// üî• ‰ΩøÁî®È°πÁõÆÂ∑≤ÊúâÁöÑ CodeMirror ÁºñËæëÂô®
import Codemirror from 'codemirror-editor-vue3'

// üî• Êñ∞Â¢ûÔºöÂØºÂÖ•ËÑöÊú¨ÂºïÊìé
import { defaultScriptEngine } from '@/core/script-engine'

interface DataSource {
  key: string
  name?: string
  description?: string
  fieldMappings?: Record<string, any>
  fieldsToMap?: Array<{ key: string; targetProperty: string }>
}

interface Props {
  selectedWidgetId?: string // ‰øÆÊîπ‰∏∫ÂåπÈÖç ConfigurationPanel ‰º†ÈÄíÁöÑÂ±ûÊÄßÂêç
  dataSources: DataSource[]
}

interface Emits {
  (e: 'update', config: any): void
  (e: 'request-current-data', widgetId: string): void // üî• Êñ∞Â¢ûÔºöËØ∑Ê±ÇÂΩìÂâçÊï∞ÊçÆ
}

const props = defineProps<Props>()
const emit = defineEmits<Emits>()

// üî• Êñ∞Â¢ûÔºöÂéüÂßãÊï∞ÊçÆÈ°πÁ±ªÂûãÊûö‰∏æ
type RawDataItemType = 'json' | 'http' | 'websocket'

// üî• Êñ∞Â¢ûÔºöÂéüÂßãÊï∞ÊçÆÈ°πÊé•Âè£ÔºàÂ¢ûÂä†Á±ªÂûãÂ≠óÊÆµÔºâ
interface RawDataItem {
  id: string
  name: string
  type: RawDataItemType // Êï∞ÊçÆÈ°πÁ±ªÂûã
  data: any
  config?: {
    // Ê†πÊçÆÁ±ªÂûãÂ≠òÂÇ®‰∏çÂêåÁöÑÈÖçÁΩÆ
    jsonData?: string // jsonÁ±ªÂûãÁöÑÊï∞ÊçÆ
    httpConfig?: {
      // httpÁ±ªÂûãÁöÑÈÖçÁΩÆ
      url: string
      method: string
      headers?: Record<string, string>
    }
    websocketConfig?: {
      // websocketÁ±ªÂûãÁöÑÈÖçÁΩÆ
      url: string
      protocols?: string[]
    }
  }
  createdAt: string
  isActive: boolean
}

// üî• ‰øÆÊîπÔºöÊï∞ÊçÆÁªìÊûÑÊé•Âè£ - ÂéüÂßãÊï∞ÊçÆÈ°πÂÆåÂÖ®Áã¨Á´ã
interface DataSourceValue {
  currentData: any // ÊúÄÁªàÊï∞ÊçÆÔºàÂÆåÂÖ®Áã¨Á´ãÔºâ
  rawDataList: RawDataItem[] // ÂéüÂßãÊï∞ÊçÆÂàóË°®ÔºàÂÆåÂÖ®Áã¨Á´ãÔºå‰∏çÂΩ±ÂìçÊúÄÁªàÊï∞ÊçÆÔºâ
}

// Êï∞ÊçÆÂ≠òÂÇ® - üî• ‰øÆÊîπÔºöÊîØÊåÅÂéüÂßãÊï∞ÊçÆÂàóË°®
const dataValues = reactive<Record<string, DataSourceValue>>({})

// üî• ÂºπÁ™óÁä∂ÊÄÅÁÆ°ÁêÜ
const showAddRawDataModal = ref(false)
const currentDataSourceKey = ref('')
const newRawDataName = ref('')

// üî• Êñ∞Â¢ûÔºöÊï∞ÊçÆÈ°πÁ±ªÂûãÈÄâÊã©Áõ∏ÂÖ≥Áä∂ÊÄÅ
const newRawDataType = ref<RawDataItemType>('json')
const newRawDataJsonContent = ref('')
const newRawDataHttpUrl = ref('')
const newRawDataHttpMethod = ref('GET')
const newRawDataHttpHeaders = ref('')
const newRawDataWebsocketUrl = ref('')
const newRawDataWebsocketProtocols = ref('')

// üî• Êñ∞Â¢ûÔºöÊü•ÁúãÊúÄÁªàÊï∞ÊçÆÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showFinalDataModal = ref(false)
const currentFinalData = ref('')

// üî• Êñ∞Â¢ûÔºöÊü•ÁúãÂéüÂßãÊï∞ÊçÆËØ¶ÊÉÖÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showRawDataDetailModal = ref(false)
const currentRawDataDetail = ref('')
const currentRawDataName = ref('')

// üî• ÁÆÄÂåñÔºöÁõ¥Êé•ÁöÑÁä∂ÊÄÅÁÆ°ÁêÜ
const currentFilterPath = ref('')
const currentProcessScript = ref('')

// üî• Êñ∞Â¢ûÔºöÁºñËæëÊ®°ÂºèÁä∂ÊÄÅÁÆ°ÁêÜ
const isEditMode = ref(false)
const editingDataSourceKey = ref('')
const editingRawDataId = ref('')

// üî• Êñ∞Â¢ûÔºöÊï∞ÊçÆÈ¢ÑËßàÁä∂ÊÄÅ
const previewOriginalData = ref('{}')
const previewProcessedData = ref('{}')
const previewStatus = ref({ type: 'default', text: 'Á≠âÂæÖÂ§ÑÁêÜ', message: '' })

/**
 * üî• Êñ∞Â¢ûÔºöÊõ¥Êñ∞Êï∞ÊçÆÈ¢ÑËßà
 */
const updatePreviewData = async () => {
  try {
    // 1. Ëé∑ÂèñÂéüÂßãÊï∞ÊçÆ
    let originalData = {}
    if (newRawDataJsonContent.value.trim()) {
      try {
        originalData = JSON.parse(newRawDataJsonContent.value)
      } catch (error) {
        previewStatus.value = { type: 'error', text: 'JSONÈîôËØØ', message: 'JSONÊ†ºÂºè‰∏çÊ≠£Á°Æ' }
        previewOriginalData.value = '{"error": "JSONÊ†ºÂºèÈîôËØØ"}'
        previewProcessedData.value = '{"error": "JSONÊ†ºÂºèÈîôËØØ"}'
        return
      }
    }

    previewOriginalData.value = JSON.stringify(originalData, null, 2)

    // 2. Â∫îÁî®Êï∞ÊçÆÂ§ÑÁêÜ
    let processedData = originalData

    // Â∫îÁî®ËøáÊª§Ë∑ØÂæÑ
    if (currentFilterPath.value.trim()) {
      try {
        processedData = applyDataFilter(processedData, currentFilterPath.value)
      } catch (error) {
        previewStatus.value = { type: 'warning', text: 'ËøáÊª§Ë≠¶Âëä', message: 'ËøáÊª§Ë∑ØÂæÑÂèØËÉΩÊúâËØØ' }
      }
    }

    // Â∫îÁî®Â§ÑÁêÜËÑöÊú¨
    if (currentProcessScript.value.trim()) {
      try {
        processedData = await applyProcessScript(processedData, currentProcessScript.value)
        previewStatus.value = { type: 'success', text: 'Â§ÑÁêÜÊàêÂäü', message: 'Êï∞ÊçÆÂ∑≤Â§ÑÁêÜ' }
      } catch (error) {
        previewStatus.value = { type: 'error', text: 'ËÑöÊú¨ÈîôËØØ', message: 'ËÑöÊú¨ÊâßË°åÂ§±Ë¥•' }
      }
    } else {
      previewStatus.value = { type: 'info', text: 'Êó†ËÑöÊú¨', message: 'Êú™ËÆæÁΩÆÂ§ÑÁêÜËÑöÊú¨' }
    }

    previewProcessedData.value = JSON.stringify(processedData, null, 2)
  } catch (error) {
    previewStatus.value = { type: 'error', text: 'È¢ÑËßàÈîôËØØ', message: 'Êï∞ÊçÆÈ¢ÑËßàÂ§±Ë¥•' }
    previewProcessedData.value = '{"error": "È¢ÑËßàÂ§±Ë¥•"}'
  }
}

/**
 * Ëé∑ÂèñÊï∞ÊçÆÁ±ªÂûãÊñáÊú¨ÊèèËø∞
 */
const getDataTypeText = (dataSource: DataSource) => {
  // Ê†πÊçÆ fieldsToMap Âà§Êñ≠ÊúüÊúõÁöÑÊï∞ÊçÆÁ±ªÂûã
  if (dataSource.fieldsToMap && dataSource.fieldsToMap.length > 0) {
    const targetProperty = dataSource.fieldsToMap[0].targetProperty
    if (targetProperty.includes('array') || targetProperty.includes('Array')) {
      return 'Êï∞ÁªÑ'
    }
    if (targetProperty.includes('object') || targetProperty.includes('Object')) {
      return 'ÂØπË±°'
    }
  }

  // Ê†πÊçÆ key Âà§Êñ≠
  if (dataSource.key.toLowerCase().includes('array')) return 'Êï∞ÁªÑ'
  if (dataSource.key.toLowerCase().includes('object')) return 'ÂØπË±°'

  return 'Êï∞ÊçÆ'
}

/**
 * Ëé∑ÂèñÈªòËÆ§Êï∞ÊçÆ - üî• ‰øÆÊîπÔºöÁªü‰∏ÄËøîÂõûÁ©∫ÂØπË±°
 */
const getDefaultData = (dataSourceKey: string) => {
  const dataSource = props.dataSources.find(ds => ds.key === dataSourceKey)
  if (!dataSource) return {}

  // üî• ‰øÆÂ§çÔºö‰ºòÂÖà‰ªé fieldMappings ‰∏≠Ëé∑Âèñ defaultValue
  if (dataSource.fieldMappings) {
    // Êü•ÊâæÂåπÈÖçÁöÑÂ≠óÊÆµÊò†Â∞Ñ
    const targetFieldMapping = Object.values(dataSource.fieldMappings).find(
      (mapping: any) => mapping.targetField === dataSourceKey || mapping.type
    )

    if (targetFieldMapping && targetFieldMapping.defaultValue !== undefined) {
      console.log(`üîß [DEBUG-Config] ‰ΩøÁî®ÁªÑ‰ª∂ÂÆö‰πâÁöÑÈªòËÆ§ÂÄº (${dataSourceKey}):`, targetFieldMapping.defaultValue)
      return targetFieldMapping.defaultValue
    }
  }

  // üî• ‰øÆÊîπÔºöÁªü‰∏ÄËøîÂõûÁ©∫ÂØπË±°Ôºå‰∏çÂÜç‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
  return {}
}

/**
 * Ê†ºÂºèÂåñÊòæÁ§∫Êï∞ÊçÆ - üî• ‰øÆÊîπÔºöÊòæÁ§∫ÂΩìÂâçÊøÄÊ¥ªÁöÑÊï∞ÊçÆ
 */
const getFormattedData = (dataSourceKey: string) => {
  const dataSourceValue = dataValues[dataSourceKey]

  // üî• Ë∞ÉËØïÔºöÊâìÂç∞Êï∞ÊçÆÁä∂ÊÄÅ
  console.log(`üîß [DEBUG-Config] getFormattedData(${dataSourceKey}):`, {
    dataSourceValue,
    hasCurrentData: !!dataSourceValue?.currentData,
    currentData: dataSourceValue?.currentData,
    dataValuesKeys: Object.keys(dataValues)
  })

  if (!dataSourceValue?.currentData) {
    console.warn(`‚ö†Ô∏è [DEBUG-Config] Êï∞ÊçÆÊ∫ê ${dataSourceKey} Ê≤°ÊúâcurrentDataÔºådataSourceValue:`, dataSourceValue)
    return 'ÊöÇÊó†Êï∞ÊçÆ'
  }

  try {
    return JSON.stringify(dataSourceValue.currentData, null, 2)
  } catch {
    return String(dataSourceValue.currentData)
  }
}

/**
 * üî• ‰øÆÊîπÔºöËé∑ÂèñÁ§∫‰æãÊï∞ÊçÆ‰ª£Á†ÅÁî®‰∫éÊÇ¨ÂÅúÊèêÁ§∫ - Áªü‰∏ÄËøîÂõûÁ©∫ÂØπË±°
 */
const getExampleDataCode = (dataSource: DataSource) => {
  // ‰ªé fieldMappings ‰∏≠Ëé∑Âèñ defaultValue
  if (dataSource.fieldMappings) {
    const firstMapping = Object.values(dataSource.fieldMappings)[0] as any
    if (firstMapping && firstMapping.defaultValue !== undefined) {
      try {
        return JSON.stringify(firstMapping.defaultValue, null, 2)
      } catch {
        return JSON.stringify(firstMapping.defaultValue)
      }
    }
  }

  // üî• ‰øÆÊîπÔºöÁªü‰∏ÄËøîÂõûÁ©∫ÂØπË±°Ê†ºÂºè
  return '{}'
}

/**
 * ÈáçÁΩÆÊï∞ÊçÆ‰∏∫ÈªòËÆ§ - üî• ‰øÆÊîπÔºöÊîØÊåÅÊñ∞ÁöÑÊï∞ÊçÆÁªìÊûÑ
 */
const resetData = (dataSourceKey: string) => {
  const defaultData = getDefaultData(dataSourceKey)

  // üî• ‰øÆÊîπÔºöÊõ¥Êñ∞Êï∞ÊçÆÁªìÊûÑ
  if (!dataValues[dataSourceKey]) {
    dataValues[dataSourceKey] = {
      currentData: defaultData,
      rawDataList: []
    }
  } else {
    dataValues[dataSourceKey].currentData = defaultData
  }

  console.log('üîß [DEBUG-Config] ÈáçÁΩÆÊï∞ÊçÆ:', { dataSourceKey, data: dataValues[dataSourceKey] })
  sendUpdate()
}

// ‰∏äÊ¨°ÂèëÈÄÅÁöÑÈÖçÁΩÆÔºåÁî®‰∫éÈò≤Ê≠¢ÈáçÂ§çÂèëÈÄÅ
let lastSentConfig: string | null = null

/**
 * ÂèëÈÄÅÈÖçÁΩÆÊõ¥Êñ∞ - üî• ‰øÆÊîπÔºöÂéüÂßãÊï∞ÊçÆÈ°π‰∏éÊúÄÁªàÊï∞ÊçÆÂÆåÂÖ®ÂàÜÁ¶ª
 */
const sendUpdate = () => {
  const dataSourceBindings: Record<string, any> = {}

  // üî• ‰øÆÊîπÔºöÊûÑÂª∫ÂÖºÂÆπÂéüÊúâÊ†ºÂºèÁöÑÈÖçÁΩÆÁªìÊûÑ
  props.dataSources.forEach(dataSource => {
    const dataSourceValue = dataValues[dataSource.key]
    if (dataSourceValue) {
      // üî• ‰øùÊåÅÂéüÊúâÁöÑÁªìÊûÑÔºå‰ΩÜÂ¢ûÂº∫Êï∞ÊçÆÂÜÖÂÆπ
      dataSourceBindings[dataSource.key] = {
        // ‰øùÊåÅÂéüÊúâÁöÑÂ≠óÊÆµ
        rawData: dataSourceValue.currentData ? JSON.stringify(dataSourceValue.currentData) : undefined,

        // üî• Êñ∞Â¢ûÔºöÂ¢ûÂº∫ÁöÑÊï∞ÊçÆÊ∫êÈÖçÁΩÆ
        enhancedConfig: {
          // ÂéüÂßãÊï∞ÊçÆÈ°πÂàóË°®
          rawDataList: dataSourceValue.rawDataList || [],
          // ÂÖÉÊï∞ÊçÆ
          metadata: {
            hasRawDataList: (dataSourceValue.rawDataList?.length || 0) > 0,
            rawDataCount: dataSourceValue.rawDataList?.length || 0,
            lastUpdated: new Date().toISOString(),
            version: '2.1'
          },
          // Êï∞ÊçÆÊ∫êÁ±ªÂûã‰ø°ÊÅØ
          dataSourceInfo: {
            key: dataSource.key,
            name: dataSource.name,
            description: dataSource.description,
            fieldMappings: dataSource.fieldMappings,
            fieldsToMap: dataSource.fieldsToMap
          }
        }
      }
    }
  })

  // üî• ‰øùÊåÅÂÖºÂÆπÁöÑÈÖçÁΩÆÁªìÊûÑÔºåÂêåÊó∂Â¢ûÂº∫ÂäüËÉΩ
  const config = {
    dataSourceBindings,
    // üî• Êñ∞Â¢ûÔºöÁ≥ªÁªüÁ∫ßÈÖçÁΩÆ
    systemConfig: {
      version: '2.1',
      features: ['rawDataManagement', 'scriptProcessing', 'dataFiltering'],
      lastConfigUpdate: new Date().toISOString(),
      selectedWidgetId: props.selectedWidgetId
    }
  }
  const configHash = JSON.stringify(config)

  // üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂè™Âú®ÈÖçÁΩÆÁúüÊ≠£ÂèòÂåñÊó∂ÊâçÂèëÈÄÅ
  if (configHash !== lastSentConfig) {
    console.log('üîß [DEBUG-Config] Ê£ÄÊµãÂà∞ÈÖçÁΩÆÂèòÂåñÔºåÂèëÈÄÅÊõ¥Êñ∞:', {
      selectedWidgetId: props.selectedWidgetId,
      bindingKeys: Object.keys(dataSourceBindings),
      hasDataChanged: configHash !== lastSentConfig,
      config
    })

    lastSentConfig = configHash
    emit('update', config)
  } else {
    console.log('üîß [DEBUG-Config] ÈÖçÁΩÆÊú™ÂèòÂåñÔºåË∑≥ËøáÂèëÈÄÅ:', {
      selectedWidgetId: props.selectedWidgetId,
      bindingKeys: Object.keys(dataSourceBindings)
    })
  }
}

/**
 * ÂàùÂßãÂåñÊï∞ÊçÆ - üî• ‰øÆÂ§çÔºö‰ºòÂÖà‰ΩøÁî®ÂΩìÂâçËøêË°åÊó∂Êï∞ÊçÆ
 */
const initializeData = () => {
  console.log('üîß [DEBUG-Config] ÂàùÂßãÂåñÊï∞ÊçÆÊ∫êÊï∞ÊçÆ:', {
    selectedWidgetId: props.selectedWidgetId,
    dataSourcesCount: props.dataSources.length,
    dataSourceKeys: props.dataSources.map(ds => ds.key)
  })

  // üî• ÈáçÁΩÆÈÖçÁΩÆÁºìÂ≠òÔºåÂÖÅËÆ∏Êñ∞ÁöÑÈÖçÁΩÆÂèëÈÄÅ
  lastSentConfig = null

  // üî• Ê†∏ÂøÉ‰øÆÂ§çÔºöÂÖàËØ∑Ê±ÇÂΩìÂâçËøêË°åÊó∂Êï∞ÊçÆ
  if (props.selectedWidgetId) {
    console.log('üîÑ [DataSourceConfigForm] ËØ∑Ê±ÇÂΩìÂâçËøêË°åÊó∂Êï∞ÊçÆ:', props.selectedWidgetId)
    emit('request-current-data', props.selectedWidgetId)

    // ÁªôÁà∂ÁªÑ‰ª∂‰∏ÄÁÇπÊó∂Èó¥ÂìçÂ∫îÔºåÁÑ∂ÂêéÂÜçÂ∞ùËØïÊÅ¢Â§ç
    setTimeout(() => {
      attemptDataRestore()
    }, 50)
  } else {
    // Ê≤°ÊúâÈÄâ‰∏≠ÁªÑ‰ª∂Ôºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
    useDefaultData()
  }
}

/**
 * Â∞ùËØïÊï∞ÊçÆÊÅ¢Â§çÔºà‰ªéÂ≠òÂÇ®ÁöÑÈÖçÁΩÆÔºâ
 */
const attemptDataRestore = () => {
  let hasRestoredData = false

  if (props.selectedWidgetId) {
    try {
      console.log('üîç [DEBUG-Restore] ÂºÄÂßãÂ∞ùËØïÊÅ¢Â§çÈÖçÁΩÆ:', props.selectedWidgetId)
      // const savedConfig = configurationManager.getConfiguration(props.selectedWidgetId)
      // console.log('üîç [DEBUG-Restore] ConfigurationManagerËøîÂõûÁöÑÂÆåÊï¥ÈÖçÁΩÆ:', savedConfig)

      // Â∞ùËØï‰ªéÂ§öÁßçÊï∞ÊçÆÁªìÊûÑÊÅ¢Â§ç
      let dataSourceBindings = null

      // TODO: ÂÆûÁé∞ÈÖçÁΩÆÊÅ¢Â§çÈÄªËæë
      // if (savedConfig?.dataSource?.config?.dataSourceBindings) {
      //   dataSourceBindings = savedConfig.dataSource.config.dataSourceBindings
      //   console.log('üîß [DEBUG-Config] ‰ªédataSource.configÊÅ¢Â§çÊï∞ÊçÆ:', dataSourceBindings)
      // } else if (savedConfig?.dataSourceBindings) {
      //   dataSourceBindings = savedConfig.dataSourceBindings
      //   console.log('üîß [DEBUG-Config] ‰ªédataSourceBindingsÁõ¥Êé•ÊÅ¢Â§çÊï∞ÊçÆ:', dataSourceBindings)
      // }

      if (dataSourceBindings && Object.keys(dataSourceBindings).length > 0) {
        // ÊÅ¢Â§çÊØè‰∏™Êï∞ÊçÆÊ∫êÁöÑ‰øùÂ≠òÊï∞ÊçÆ
        Object.entries(dataSourceBindings).forEach(([key, binding]: [string, any]) => {
          if (binding?.rawData) {
            try {
              // üî• ‰øÆÂ§çÔºöÊ£ÄÊü•‰øùÂ≠òÁöÑÊï∞ÊçÆÁªìÊûÑÊ†ºÂºè
              const parsedRawData = JSON.parse(binding.rawData)

              // üî• ‰øÆÂ§çÔºöÊ†πÊçÆÊï∞ÊçÆÁªìÊûÑÂÜ≥ÂÆöÂ¶Ç‰ΩïÊÅ¢Â§ç
              if (parsedRawData && typeof parsedRawData === 'object' && parsedRawData.currentData !== undefined) {
                // Êñ∞Êï∞ÊçÆÁªìÊûÑÔºöÂåÖÂê´ currentData Âíå rawDataList
                dataValues[key] = {
                  currentData: parsedRawData.currentData,
                  rawDataList: parsedRawData.rawDataList || []
                }
                console.log(`üîß [DEBUG-Config] ÊÅ¢Â§çÊñ∞Êï∞ÊçÆÁªìÊûÑ ${key}:`, dataValues[key])
              } else {
                // ÊóßÊï∞ÊçÆÁªìÊûÑÔºöÁõ¥Êé•ÊòØÊï∞ÊçÆÂÜÖÂÆπ
                dataValues[key] = {
                  currentData: parsedRawData,
                  rawDataList: []
                }
                console.log(`üîß [DEBUG-Config] ÊÅ¢Â§çÊóßÊï∞ÊçÆÁªìÊûÑÂπ∂ËΩ¨Êç¢ ${key}:`, dataValues[key])
              }

              // üî• ‰øÆÂ§çÔºöÂêåÊó∂‰ªéÂéüÂßãÊï∞ÊçÆÂàóË°®ÈÖçÁΩÆ‰∏≠ÊÅ¢Â§ç
              if (binding.rawDataList) {
                dataValues[key].rawDataList = binding.rawDataList
                console.log(`üîß [DEBUG-Config] ÊÅ¢Â§çÂéüÂßãÊï∞ÊçÆÂàóË°® ${key}:`, binding.rawDataList)
              }

              hasRestoredData = true
            } catch (error) {
              console.warn(`‚ö†Ô∏è [DEBUG-Config] ÊÅ¢Â§çÊï∞ÊçÆÊ∫ê ${key} Â§±Ë¥•:`, error)
              // üî• ‰øÆÂ§çÔºöÊÅ¢Â§çÂ§±Ë¥•Êó∂‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆÁªìÊûÑ
              const defaultData = getDefaultData(key)
              dataValues[key] = {
                currentData: defaultData,
                rawDataList: []
              }
            }
          }
        })
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è [DEBUG-Config] ÈÖçÁΩÆÊÅ¢Â§çÂ§±Ë¥•:', error)
    }
  }

  // Â¶ÇÊûúÊ≤°ÊúâÊÅ¢Â§çÂà∞Êï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
  if (!hasRestoredData) {
    useDefaultData()
  }

  // üî• ‰øÆÂ§çÔºöÂè™Âú®Ê≤°ÊúâÊÅ¢Â§çÂà∞Êï∞ÊçÆÊó∂ÂèëÈÄÅÂàùÂßãÈÖçÁΩÆ
  // ÊÅ¢Â§çÊï∞ÊçÆÊó∂‰∏çÂèëÈÄÅÔºåÈÅøÂÖçÈáçÂ§çÂèëÈÄÅÁõ∏ÂêåÈÖçÁΩÆ
  if (!hasRestoredData) {
    console.log('üîß [DEBUG-Config] ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆÔºåÂèëÈÄÅÂàùÂßãÈÖçÁΩÆ')
    sendUpdate()
  } else {
    console.log('üîß [DEBUG-Config] Êï∞ÊçÆÂ∑≤ÊÅ¢Â§çÔºå‰∏çÂèëÈÄÅÈáçÂ§çÈÖçÁΩÆ')
    // üî• ‰øÆÂ§çÔºöÊõ¥Êñ∞ lastSentConfig ‰ª•ÈÅøÂÖçÂêéÁª≠ÈáçÂ§çÂèëÈÄÅ
    const dataSourceBindings: Record<string, any> = {}
    props.dataSources.forEach(dataSource => {
      const dataSourceValue = dataValues[dataSource.key]
      if (dataSourceValue?.currentData !== undefined) {
        dataSourceBindings[dataSource.key] = {
          rawData: JSON.stringify(dataSourceValue.currentData),
          rawDataList: dataSourceValue.rawDataList || [],
          metadata: {
            hasRawDataList: dataSourceValue.rawDataList?.length > 0
            // ÁßªÈô§ activeRawDataIdÔºåÂõ†‰∏∫ÂéüÂßãÊï∞ÊçÆÈ°π‰∏çÂΩ±ÂìçÊúÄÁªàÊï∞ÊçÆ
          }
        }
      }
    })
    lastSentConfig = JSON.stringify({ dataSourceBindings })
  }
}

/**
 * ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ - üî• ‰øÆÊîπÔºöÊîØÊåÅÊñ∞ÁöÑÊï∞ÊçÆÁªìÊûÑ
 */
const useDefaultData = () => {
  console.log('üî• [DEBUG-Config] ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆÂàùÂßãÂåñ - Êñ∞Êï∞ÊçÆÁªìÊûÑ')
  props.dataSources.forEach(dataSource => {
    const defaultData = getDefaultData(dataSource.key)
    dataValues[dataSource.key] = {
      currentData: defaultData,
      rawDataList: []
    }
    console.log(`üîß [DEBUG-Config] ÂàùÂßãÂåñÊï∞ÊçÆÊ∫ê: ${dataSource.key}`, dataValues[dataSource.key])
  })
}

// üî• ÂéüÂßãÊï∞ÊçÆÁÆ°ÁêÜÂáΩÊï∞

/**
 * üî• Êñ∞Â¢ûÔºöËé∑ÂèñÂ§çÊùÇJSONÁ§∫‰æã
 */
const getJsonPlaceholder = () => {
  return `{
  "name": "Âº†‰∏â",
  "age": 25,
  "email": "zhangsan@example.com"
}`
}

/**
 * üî• Êñ∞Â¢ûÔºöËé∑ÂèñJSONÁ§∫‰æãÁöÑÈªòËÆ§ÂÄºÔºàÁî®‰∫éÂàùÂßãÂåñËæìÂÖ•Ê°ÜÔºâ
 */
const getJsonDefaultValue = () => {
  return getJsonPlaceholder()
}

// üî• Êñ∞Â¢ûÔºöÊï∞ÊçÆÂ§ÑÁêÜÊ†∏ÂøÉÂáΩÊï∞

/**
 * Â∫îÁî®Êï∞ÊçÆËøáÊª§Ë∑ØÂæÑ
 */
const applyDataFilter = (data: any, filterPath: string): any => {
  if (!filterPath || filterPath.trim() === '') return data

  try {
    // ÁÆÄÂçïÁöÑJSONPathÂÆûÁé∞
    let current = data
    let cleanPath = filterPath.replace(/^\$\.?/, '').trim()

    if (!cleanPath) return data

    // ÊåâÁÇπÂàÜÂâ≤Ôºå‰ΩÜË¶ÅÂ§ÑÁêÜÊï∞ÁªÑÁ¥¢Âºï
    const parts = cleanPath.split(/\.|\[|\]/).filter(part => part !== '')

    for (const part of parts) {
      if (current === null || current === undefined) return null

      // Â§ÑÁêÜÊï∞ÁªÑÁ¥¢Âºï
      if (/^\d+$/.test(part)) {
        const index = parseInt(part)
        if (Array.isArray(current) && index >= 0 && index < current.length) {
          current = current[index]
        } else {
          return null
        }
      } else {
        // Â§ÑÁêÜÂØπË±°Â±ûÊÄß
        if (typeof current === 'object' && current !== null && part in current) {
          current = current[part]
        } else {
          return null
        }
      }
    }

    return current
  } catch (error) {
    console.warn('üîß [DataFilter] ËøáÊª§Ë∑ØÂæÑËß£ÊûêÂ§±Ë¥•:', error)
    return data // Â§±Ë¥•Êó∂ËøîÂõûÂéüÊï∞ÊçÆ
  }
}

/**
 * Â∫îÁî®Â§ÑÁêÜËÑöÊú¨
 */
const applyProcessScript = async (data: any, script: string): Promise<any> => {
  if (!script || script.trim() === '') return data

  try {
    console.log('üîß [ProcessScript] ÊâßË°åËÑöÊú¨:', script.substring(0, 100))

    // üî• ‰øÆÂ§çÔºöÂàõÂª∫Êï∞ÊçÆÁöÑÊ∑±Êã∑Ë¥ùÔºåÈÅøÂÖç‰øÆÊîπÂéüÂßãÊï∞ÊçÆ
    const dataCopy = JSON.parse(JSON.stringify(data))

    // ‰ΩøÁî®ËÑöÊú¨ÂºïÊìéÊâßË°å
    const result = await defaultScriptEngine.execute(script, { data: dataCopy })

    if (result.success) {
      console.log('‚úÖ [ProcessScript] ËÑöÊú¨ÊâßË°åÊàêÂäü')
      return result.data
    } else {
      console.error('‚ùå [ProcessScript] ËÑöÊú¨ÊâßË°åÂ§±Ë¥•:', result.error)
      console.warn('üîß [ProcessScript] ËøîÂõûÂéüÂßãÊï∞ÊçÆ')
      return data // Â§±Ë¥•Êó∂ËøîÂõûÂéüÊï∞ÊçÆ
    }
  } catch (error) {
    console.error('‚ùå [ProcessScript] ËÑöÊú¨ÊâßË°åÂºÇÂ∏∏:', error)
    console.warn('üîß [ProcessScript] ËøîÂõûÂéüÂßãÊï∞ÊçÆ')
    return data // ÂºÇÂ∏∏Êó∂ËøîÂõûÂéüÊï∞ÊçÆ
  }
}

/**
 * ÂÆåÊï¥ÁöÑÊï∞ÊçÆÂ§ÑÁêÜÊµÅÁ®ãÔºöÂéüÂßãÊï∞ÊçÆ -> ËøáÊª§ -> ËÑöÊú¨Â§ÑÁêÜ
 */
const processRawData = async (rawData: any, config: any): Promise<any> => {
  let processedData = rawData

  // 1. Â∫îÁî®Êï∞ÊçÆËøáÊª§
  if (config?.filterPath) {
    processedData = applyDataFilter(processedData, config.filterPath)
    console.log('üîß [DataProcess] ËøáÊª§ÂêéÊï∞ÊçÆ:', processedData)
  }

  // 2. Â∫îÁî®Â§ÑÁêÜËÑöÊú¨
  if (config?.processScript) {
    processedData = await applyProcessScript(processedData, config.processScript)
    console.log('üîß [DataProcess] ËÑöÊú¨Â§ÑÁêÜÂêéÊï∞ÊçÆ:', processedData)
  }

  return processedData
}

/**
 * üî• Êñ∞Â¢ûÔºöËé∑ÂèñÊï∞ÊçÆÈ°πÁ±ªÂûãÂØπÂ∫îÁöÑÈ¢úËâ≤
 */
const getDataItemTypeColor = (
  type: RawDataItemType
): 'default' | 'primary' | 'info' | 'success' | 'warning' | 'error' => {
  switch (type) {
    case 'json':
      return 'success'
    case 'http':
      return 'info'
    case 'websocket':
      return 'warning'
    default:
      return 'default'
  }
}

/**
 * üî• Êñ∞Â¢ûÔºöÊ†πÊçÆÁ±ªÂûãÁîüÊàêÊï∞ÊçÆ
 */
const generateDataFromType = (type: RawDataItemType) => {
  console.log('üîß [DEBUG-GenerateData] ÁîüÊàêÊï∞ÊçÆÔºåÁ±ªÂûã:', type, 'ÂÜÖÂÆπ:', newRawDataJsonContent.value.substring(0, 50))

  switch (type) {
    case 'json':
      // JSON Á±ªÂûãÔºöÂ¶ÇÊûúÁî®Êà∑ËæìÂÖ•‰∫ÜÂÜÖÂÆπÔºåÂ∞ùËØïËß£ÊûêÔºåÂê¶ÂàôËøîÂõûÁ©∫ÂØπË±°
      if (newRawDataJsonContent.value.trim()) {
        try {
          return JSON.parse(newRawDataJsonContent.value)
        } catch (error) {
          console.warn('JSON Ëß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®Á©∫ÂØπË±°:', error)
          return {}
        }
      }
      return {}

    case 'http':
      // HTTP Á±ªÂûãÔºöËøîÂõûÈªòËÆ§HTTPÈÖçÁΩÆÁªìÊûÑ
      return {
        url: newRawDataHttpUrl.value || '',
        method: newRawDataHttpMethod.value || 'GET',
        headers: newRawDataHttpHeaders.value ? JSON.parse(newRawDataHttpHeaders.value || '{}') : {},
        status: 'ready',
        lastFetch: null
      }

    case 'websocket':
      // WebSocket Á±ªÂûãÔºöËøîÂõûÈªòËÆ§WebSocketÈÖçÁΩÆÁªìÊûÑ
      return {
        url: newRawDataWebsocketUrl.value || '',
        protocols: newRawDataWebsocketProtocols.value
          ? newRawDataWebsocketProtocols.value.split(',').map(p => p.trim())
          : [],
        readyState: 'connecting',
        lastMessage: null
      }

    default:
      return {}
  }
}

/**
 * üî• ÁÆÄÂåñÔºöÊ†πÊçÆÁ±ªÂûãÁîüÊàêÈÖçÁΩÆÔºàÂåÖÂê´ËøáÊª§Ë∑ØÂæÑÂíåÂ§ÑÁêÜËÑöÊú¨Ôºâ
 */
const generateConfigFromType = (type: RawDataItemType) => {
  const baseConfig = {
    filterPath: currentFilterPath.value.trim() || undefined,
    processScript: currentProcessScript.value.trim() || undefined
  }

  switch (type) {
    case 'json':
      return {
        ...baseConfig,
        jsonData: newRawDataJsonContent.value || ''
      }

    case 'http':
      return {
        ...baseConfig,
        httpConfig: {
          url: newRawDataHttpUrl.value || '',
          method: newRawDataHttpMethod.value || 'GET',
          headers: newRawDataHttpHeaders.value ? JSON.parse(newRawDataHttpHeaders.value || '{}') : {}
        }
      }

    case 'websocket':
      return {
        ...baseConfig,
        websocketConfig: {
          url: newRawDataWebsocketUrl.value || '',
          protocols: newRawDataWebsocketProtocols.value
            ? newRawDataWebsocketProtocols.value.split(',').map(p => p.trim())
            : []
        }
      }

    default:
      return baseConfig
  }
}

/**
 * ÊâìÂºÄÊ∑ªÂä†ÂéüÂßãÊï∞ÊçÆÂºπÁ™ó
 */
const openAddRawDataModal = (dataSourceKey: string) => {
  // üî• Êñ∞Â¢ûÔºöÈáçÁΩÆÁºñËæëÊ®°ÂºèÁä∂ÊÄÅÔºàÁ°Æ‰øùÊòØÊ∑ªÂä†Ê®°ÂºèÔºâ
  resetEditMode()

  currentDataSourceKey.value = dataSourceKey
  newRawDataName.value = ''

  // üî• ‰øÆÊîπÔºöÈáçÁΩÆË°®ÂçïÁä∂ÊÄÅÂπ∂ËÆæÁΩÆJSONÈªòËÆ§ÂÄº
  newRawDataType.value = 'json'
  newRawDataJsonContent.value = getJsonDefaultValue() // ËÆæÁΩÆÈªòËÆ§JSONÂÜÖÂÆπ
  newRawDataHttpUrl.value = ''
  newRawDataHttpMethod.value = 'GET'
  newRawDataHttpHeaders.value = ''
  newRawDataWebsocketUrl.value = ''
  newRawDataWebsocketProtocols.value = ''

  // üî• ÁÆÄÂåñÔºöÈáçÁΩÆËøáÊª§Ë∑ØÂæÑÂíåÊ∑ªÂä†Á§∫‰æãÂ§ÑÁêÜËÑöÊú¨
  currentFilterPath.value = ''
  currentProcessScript.value = `// Á§∫‰æãÔºöÊääÁ¨¨‰∏Ä‰∏™keyÂèòÊàêusername
var keys = Object.keys(data);
if (keys.length > 0) {
  var firstKey = keys[0];
  var firstValue = data[firstKey];
  delete data[firstKey];
  data.username = firstValue;
}
return data;`

  // üî• Êñ∞Â¢ûÔºöÂàùÂßãÂåñÊï∞ÊçÆÈ¢ÑËßà
  updatePreviewData()

  showAddRawDataModal.value = true
}

/**
 * Âø´ÈÄüÊ∑ªÂä†ÂéüÂßãÊï∞ÊçÆ - ÊûÅÁÆÄ‰∫§‰∫íÔºåÁõ¥Êé•Ê∑ªÂä†ÔºàÂ§áÁî®Ôºâ
 */
const quickAddRawData = (dataSourceKey: string) => {
  // üî• ‰øÆÂ§çÔºöÁ°Æ‰øùÊï∞ÊçÆÊ∫êÂ≠òÂú®‰∏îrawDataListÊòØÊï∞ÁªÑ
  if (!dataValues[dataSourceKey]) {
    dataValues[dataSourceKey] = {
      currentData: getDefaultData(dataSourceKey),
      rawDataList: []
    }
  }

  if (!dataValues[dataSourceKey].rawDataList || !Array.isArray(dataValues[dataSourceKey].rawDataList)) {
    dataValues[dataSourceKey].rawDataList = []
  }

  // ÁîüÊàêÁÆÄÊ¥ÅÁöÑÊï∞ÊçÆÈ°πÂêçÁß∞
  const itemCount = dataValues[dataSourceKey].rawDataList.length + 1
  const itemName = `Êï∞ÊçÆÈ°π${itemCount}`

  // üî• ‰øÆÊîπÔºöÂàõÂª∫Êñ∞ÁöÑÂéüÂßãÊï∞ÊçÆÈ°πÔºåÂåÖÂê´Á±ªÂûã‰ø°ÊÅØ
  const newRawDataItem: RawDataItem = {
    id: `raw-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
    name: itemName,
    type: 'json', // Âø´ÈÄüÊ∑ªÂä†ÈªòËÆ§‰∏∫ JSON Á±ªÂûã
    data: {}, // Á©∫ÂØπË±°ÔºåÂÆåÂÖ®Áã¨Á´ã
    config: { jsonData: '' }, // ÈªòËÆ§JSONÈÖçÁΩÆ
    createdAt: new Date().toISOString(),
    isActive: false
  }

  // Ê∑ªÂä†Âà∞ÂàóË°®
  dataValues[dataSourceKey].rawDataList.push(newRawDataItem)

  console.log('üîß [DEBUG-Config] Âø´ÈÄüÊ∑ªÂä†Êï∞ÊçÆÈ°π:', {
    dataSourceKey,
    itemName,
    totalCount: dataValues[dataSourceKey].rawDataList.length
  })
}

/**
 * Ê∑ªÂä†ÂéüÂßãÊï∞ÊçÆÔºàÂºπÁ™óÁâàÊú¨Ôºâ- üî• ÊîØÊåÅÂ§çÊùÇÈÖçÁΩÆ
 */
const addRawData = () => {
  console.log('üîß [DEBUG-AddRawData] addRawData ÂáΩÊï∞ÂºÄÂßãÊâßË°å:', {
    newRawDataName: newRawDataName.value,
    trimmed: newRawDataName.value.trim(),
    currentDataSourceKey: currentDataSourceKey.value
  })

  if (!newRawDataName.value.trim()) {
    console.warn('üîß [DEBUG-AddRawData] ÂéüÂßãÊï∞ÊçÆÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫')
    return
  }

  const dataSourceKey = currentDataSourceKey.value

  console.log('üîß [DEBUG-AddRawData] Ê£ÄÊü•Êï∞ÊçÆÊ∫êKey:', {
    dataSourceKey,
    hasDataSource: !!dataValues[dataSourceKey],
    allDataKeys: Object.keys(dataValues)
  })

  // üî• ‰øÆÂ§çÔºöÁ°Æ‰øùÊï∞ÊçÆÊ∫êÂ≠òÂú®‰∏îrawDataListÊòØÊï∞ÁªÑ
  if (!dataValues[dataSourceKey]) {
    dataValues[dataSourceKey] = {
      currentData: getDefaultData(dataSourceKey),
      rawDataList: []
    }
  }

  if (!dataValues[dataSourceKey].rawDataList || !Array.isArray(dataValues[dataSourceKey].rawDataList)) {
    dataValues[dataSourceKey].rawDataList = []
  }

  // üî• ‰øÆÊîπÔºöÊ†πÊçÆÁ±ªÂûãÁîüÊàêÊï∞ÊçÆÂíåÈÖçÁΩÆ
  const generatedData = generateDataFromType(newRawDataType.value)
  const generatedConfig = generateConfigFromType(newRawDataType.value)

  // ÂàõÂª∫Êñ∞ÁöÑÂéüÂßãÊï∞ÊçÆÈ°π - ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞ÂíåÁ±ªÂûã
  const newRawDataItem: RawDataItem = {
    id: `raw-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
    name: newRawDataName.value.trim(),
    type: newRawDataType.value, // üî• Êñ∞Â¢ûÔºö‰øùÂ≠òÁ±ªÂûã
    data: generatedData, // üî• ‰øÆÊîπÔºöÊ†πÊçÆÁ±ªÂûãÁîüÊàêÊï∞ÊçÆ
    config: generatedConfig, // üî• Êñ∞Â¢ûÔºö‰øùÂ≠òÈÖçÁΩÆ
    createdAt: new Date().toISOString(),
    isActive: false
  }

  // Ê∑ªÂä†Âà∞ÂàóË°®
  dataValues[dataSourceKey].rawDataList.push(newRawDataItem)

  console.log('üîß [DEBUG-Config] Ê∑ªÂä†Êï∞ÊçÆÈ°πÔºàÂºπÁ™óÁâàÊú¨Ôºâ:', {
    dataSourceKey,
    newItem: newRawDataItem,
    totalCount: dataValues[dataSourceKey].rawDataList.length
  })

  // üî• ‰øÆÂ§çÔºöË∞ÉÁî® sendUpdate ÈÄöÁü•Â§ñÈÉ®ÁªÑ‰ª∂Êï∞ÊçÆÂèòÂåñ
  sendUpdate()

  console.log('üîß [DEBUG-AddRawData] ÂáÜÂ§áÂÖ≥Èó≠ÂºπÁ™óÂπ∂ÈáçÁΩÆË°®Âçï')

  // ÂÖ≥Èó≠ÂºπÁ™óÂπ∂ÈáçÁΩÆË°®Âçï
  showAddRawDataModal.value = false
  newRawDataName.value = ''

  // üî• Êñ∞Â¢ûÔºöÈáçÁΩÆÁ±ªÂûãÈÄâÊã©Áõ∏ÂÖ≥Áä∂ÊÄÅ
  newRawDataType.value = 'json'
  newRawDataJsonContent.value = ''
  newRawDataHttpUrl.value = ''
  newRawDataHttpMethod.value = 'GET'
  newRawDataHttpHeaders.value = ''
  newRawDataWebsocketUrl.value = ''
  newRawDataWebsocketProtocols.value = ''

  console.log('üîß [DEBUG-Config] Êï∞ÊçÆÈ°πÂ∑≤Ê∑ªÂä†ÔºåÂ∑≤ÈÄöÁü•Êõ¥Êñ∞')
}

/**
 * Âà†Èô§ÂéüÂßãÊï∞ÊçÆ - üî• ‰øÆÊîπÔºöÂéüÂßãÊï∞ÊçÆÈ°πÂÆåÂÖ®Áã¨Á´ãÔºå‰∏çÂΩ±ÂìçÊúÄÁªàÊï∞ÊçÆ
 */
const deleteRawData = (dataSourceKey: string, rawDataId: string) => {
  const dataSourceValue = dataValues[dataSourceKey]
  if (!dataSourceValue) return

  // ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑÈ°πÁöÑÁ¥¢Âºï
  const itemIndex = dataSourceValue.rawDataList.findIndex(item => item.id === rawDataId)
  if (itemIndex === -1) return

  const deletedItem = dataSourceValue.rawDataList[itemIndex]

  // Âà†Èô§È°π
  dataSourceValue.rawDataList.splice(itemIndex, 1)

  console.log('üîß [DEBUG-Config] Âà†Èô§Áã¨Á´ãÂéüÂßãÊï∞ÊçÆÈ°π:', {
    dataSourceKey,
    rawDataId,
    deletedItem,
    remainingCount: dataSourceValue.rawDataList.length
  })

  // üî• ‰øÆÊîπÔºöÂéüÂßãÊï∞ÊçÆÈ°π‰∏çÂΩ±ÂìçÊúÄÁªàÊï∞ÊçÆÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅË∞ÉÁî® sendUpdate()
  console.log('üîß [DEBUG-Config] ÂéüÂßãÊï∞ÊçÆÈ°πÂ∑≤Âà†Èô§Ôºå‰∏çÂΩ±ÂìçÊúÄÁªàÊï∞ÊçÆ')
}

// üî• Êñ∞Â¢ûÔºöÊü•ÁúãÂΩìÂâçÊï∞ÊçÆÊ∫êÊúÄÁªàÊï∞ÊçÆ
const showCurrentFinalData = (dataSourceKey: string) => {
  const dataSourceValue = dataValues[dataSourceKey]
  if (dataSourceValue?.currentData) {
    try {
      currentFinalData.value = JSON.stringify(dataSourceValue.currentData, null, 2)
    } catch {
      currentFinalData.value = String(dataSourceValue.currentData)
    }
  } else {
    currentFinalData.value = 'ÊöÇÊó†Êï∞ÊçÆ'
  }

  currentDataSourceKey.value = dataSourceKey
  showFinalDataModal.value = true
}

// üî• ‰øÆÊîπÔºöÊü•ÁúãÊï∞ÊçÆËØ¶ÊÉÖ - ÊòæÁ§∫Â§ÑÁêÜÂêéÁöÑÊï∞ÊçÆ
const viewRawDataDetail = async (dataSourceKey: string, rawDataId: string) => {
  const dataSourceValue = dataValues[dataSourceKey]
  if (!dataSourceValue) return

  const targetItem = dataSourceValue.rawDataList.find(item => item.id === rawDataId)
  if (!targetItem) return

  try {
    // Â∫îÁî®Êï∞ÊçÆÂ§ÑÁêÜÈÄªËæë
    const processedData = await processRawData(targetItem.data, targetItem.config)

    // ÊòæÁ§∫Â§ÑÁêÜÂêéÁöÑÊï∞ÊçÆ
    currentRawDataDetail.value = JSON.stringify(processedData, null, 2)
    console.log('üîß [ViewData] ÂéüÂßãÊï∞ÊçÆ:', targetItem.data)
    console.log('üîß [ViewData] Â§ÑÁêÜÂêéÊï∞ÊçÆ:', processedData)
  } catch {
    currentRawDataDetail.value = String(targetItem.data)
  }

  currentRawDataName.value = targetItem.name
  showRawDataDetailModal.value = true
}

// üî• Êñ∞Â¢ûÔºöÁºñËæëÊï∞ÊçÆÈ°π
const editRawData = (dataSourceKey: string, rawDataId: string) => {
  const dataSourceValue = dataValues[dataSourceKey]
  if (!dataSourceValue) return

  const targetItem = dataSourceValue.rawDataList.find(item => item.id === rawDataId)
  if (!targetItem) return

  // ËøõÂÖ•ÁºñËæëÊ®°Âºè
  isEditMode.value = true
  editingDataSourceKey.value = dataSourceKey
  editingRawDataId.value = rawDataId

  // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
  newRawDataName.value = targetItem.name
  newRawDataType.value = targetItem.type

  // Ê†πÊçÆÁ±ªÂûãÂ°´ÂÖÖÂØπÂ∫îÁöÑÊï∞ÊçÆ
  switch (targetItem.type) {
    case 'json':
      newRawDataJsonContent.value = targetItem.config?.jsonData || JSON.stringify(targetItem.data, null, 2)
      break
    case 'http':
      newRawDataHttpUrl.value = targetItem.config?.httpConfig?.url || ''
      newRawDataHttpMethod.value = targetItem.config?.httpConfig?.method || 'GET'
      newRawDataHttpHeaders.value = targetItem.config?.httpConfig?.headers
        ? JSON.stringify(targetItem.config.httpConfig.headers)
        : ''
      break
    case 'websocket':
      newRawDataWebsocketUrl.value = targetItem.config?.websocketConfig?.url || ''
      newRawDataWebsocketProtocols.value = targetItem.config?.websocketConfig?.protocols
        ? targetItem.config.websocketConfig.protocols.join(',')
        : ''
      break
  }

  // Â°´ÂÖÖËøáÊª§Ë∑ØÂæÑÂíåÂ§ÑÁêÜËÑöÊú¨
  currentFilterPath.value = targetItem.config?.filterPath || ''
  currentProcessScript.value = targetItem.config?.processScript || ''

  console.log('üîß [EditData] ËøõÂÖ•ÁºñËæëÊ®°Âºè:', {
    dataSourceKey,
    rawDataId,
    targetItem,
    editMode: true
  })

  showAddRawDataModal.value = true
}

// üî• Êñ∞Â¢ûÔºö‰øùÂ≠òÁºñËæë
const saveEdit = () => {
  if (!isEditMode.value || !editingDataSourceKey.value || !editingRawDataId.value) return

  const dataSourceValue = dataValues[editingDataSourceKey.value]
  if (!dataSourceValue) return

  const targetItemIndex = dataSourceValue.rawDataList.findIndex(item => item.id === editingRawDataId.value)
  if (targetItemIndex === -1) return

  const targetItem = dataSourceValue.rawDataList[targetItemIndex]

  // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
  targetItem.name = newRawDataName.value.trim()
  targetItem.type = newRawDataType.value

  // Ê†πÊçÆÁ±ªÂûãÁîüÊàêÊñ∞ÁöÑÊï∞ÊçÆÂíåÈÖçÁΩÆ
  targetItem.data = generateDataFromType(newRawDataType.value)
  targetItem.config = generateConfigFromType(newRawDataType.value)

  console.log('üîß [SaveEdit] ‰øùÂ≠òÁºñËæë:', {
    dataSourceKey: editingDataSourceKey.value,
    rawDataId: editingRawDataId.value,
    updatedItem: targetItem
  })

  // ÈÄÄÂá∫ÁºñËæëÊ®°ÂºèÂπ∂ÂÖ≥Èó≠ÂºπÁ™ó
  resetEditMode()
  showAddRawDataModal.value = false
}

// üî• Êñ∞Â¢ûÔºöÂèñÊ∂àÁºñËæë
const cancelEdit = () => {
  resetEditMode()
  showAddRawDataModal.value = false
}

// üî• Êñ∞Â¢ûÔºöÈáçÁΩÆÁºñËæëÊ®°ÂºèÁä∂ÊÄÅ
const resetEditMode = () => {
  isEditMode.value = false
  editingDataSourceKey.value = ''
  editingRawDataId.value = ''

  // Ê∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ
  newRawDataName.value = ''
  newRawDataType.value = 'json'
  newRawDataJsonContent.value = ''
  newRawDataHttpUrl.value = ''
  newRawDataHttpMethod.value = 'GET'
  newRawDataHttpHeaders.value = ''
  newRawDataWebsocketUrl.value = ''
  newRawDataWebsocketProtocols.value = ''
  currentFilterPath.value = ''
  currentProcessScript.value = ''
}

// üî• Êñ∞Â¢ûÔºöÁªü‰∏ÄÁöÑÁ°ÆËÆ§ÁÇπÂáªÂ§ÑÁêÜÂáΩÊï∞
const handleConfirmClick = () => {
  console.log('üîß [DEBUG-Click] Á°ÆËÆ§ÊåâÈíÆË¢´ÁÇπÂáª:', {
    isEditMode: isEditMode.value,
    newRawDataName: newRawDataName.value,
    currentDataSourceKey: currentDataSourceKey.value
  })

  if (isEditMode.value) {
    console.log('üîß [DEBUG-Click] ÊâßË°åÁºñËæë‰øùÂ≠ò')
    saveEdit()
  } else {
    console.log('üîß [DEBUG-Click] ÊâßË°åÊ∑ªÂä†Êï∞ÊçÆ')
    addRawData()
  }
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ
onMounted(() => {
  initializeData()
})

// üî• ÁõëÂê¨ selectedWidgetId ÂèòÂåñÔºåÈáçÊñ∞ÂàùÂßãÂåñ
watch(
  () => props.selectedWidgetId,
  (newId, oldId) => {
    if (newId && newId !== oldId) {
      console.log('üîÑ [DataSourceConfigForm] selectedWidgetId ÂèòÂåñÔºåÈáçÊñ∞ÂàùÂßãÂåñ:', { oldId, newId })
      initializeData()
    }
  },
  { immediate: false }
)

// ÁõëÂê¨ props ÂèòÂåñÔºåÈáçÊñ∞ÂàùÂßãÂåñ
watch(
  () => props.dataSources,
  () => {
    initializeData()
  },
  { deep: true }
)

// üî• Ë∞ÉËØïÔºöÁõëÂê¨dataValuesÂèòÂåñ
watch(
  () => dataValues,
  newDataValues => {
    console.log('üîß [DEBUG-Config] dataValuesÂèòÂåñ:', {
      keys: Object.keys(newDataValues),
      values: newDataValues
    })
  },
  { deep: true, immediate: true }
)
</script>

<style scoped>
.data-source-config-form {
  width: 100%;
}

.data-source-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.example-data-icon {
  color: var(--text-color-3);
  margin-left: 8px;
  cursor: help;
  transition: color 0.2s;
}

.example-data-icon:hover {
  color: var(--primary-color);
}

.example-data-tooltip {
  max-width: 350px;
  padding: 4px 0;
}

.tooltip-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 8px;
  opacity: 0.9;
}

.example-code-container {
  background: var(--code-color, var(--card-color));
  border: 1px solid var(--border-color);
  border-radius: 6px;
  overflow: hidden;
}

.example-code {
  margin: 0;
  padding: 12px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
  font-size: 12px;
  line-height: 1.4;
  color: var(--text-color);
  background: transparent;
  overflow-x: auto;
  white-space: pre;
  max-height: 200px;
  overflow-y: auto;
}

/* ÊòéÊöó‰∏ªÈ¢òÈÄÇÈÖç */
[data-theme='dark'] .example-code-container {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.1);
}

[data-theme='dark'] .example-code {
  color: rgba(255, 255, 255, 0.9);
}

[data-theme='light'] .example-code-container {
  background: rgba(0, 0, 0, 0.02);
  border-color: rgba(0, 0, 0, 0.08);
}

[data-theme='light'] .example-code {
  color: rgba(0, 0, 0, 0.85);
}

/* ÊªöÂä®Êù°ÁæéÂåñ */
.example-code::-webkit-scrollbar {
  width: 4px;
  height: 4px;
}

.example-code::-webkit-scrollbar-track {
  background: transparent;
}

.example-code::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 2px;
}

.example-code::-webkit-scrollbar-thumb:hover {
  background: var(--text-color-3);
}

.data-source-content {
  padding: 16px;
  background: var(--card-color);
  border-radius: 6px;
  border: 1px solid var(--border-color);
}

/* Ê∑ªÂä†ÊåâÈíÆÊ†∑Âºè - ÊûÅÁÆÄÁªèÊµéËÆæËÆ° */
.add-data-btn {
  width: 100%;
  border-style: dashed;
  border-width: 1px;
  background: transparent;
  transition: all 0.2s ease;
  font-size: 12px;
  height: 28px;
  color: var(--text-color-3);
}

.add-data-btn:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--primary-color-hover);
}

.add-data-btn:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px var(--primary-color-pressed);
}

/* ÂéüÂßãÊï∞ÊçÆÂàóË°®Ê†∑Âºè */
.raw-data-list {
  max-height: 200px;
  overflow-y: auto;
}

.raw-data-item-compact {
  padding: 6px 10px;
  border: 1px solid var(--border-color);
  border-radius: 3px;
  margin-bottom: 3px;
  transition: all 0.15s;
  background-color: var(--card-color);
  font-size: 12px;
}

.raw-data-item-compact:hover {
  border-color: var(--primary-color);
  background-color: var(--hover-color);
}

/* Á¥ßÂáëÊåâÈíÆÊ†∑Âºè */
.compact-btn {
  min-width: 36px;
  height: 20px;
  font-size: 10px;
  padding: 0 6px;
  border-radius: 3px;
}

.compact-btn:hover {
  transform: none;
  box-shadow: none;
}

.raw-data-name {
  font-weight: 500;
  color: var(--text-color);
}

/* üî• Êñ∞Â¢ûÔºöÂä®ÊÄÅË°®ÂçïÂå∫ÂüüÊ†∑Âºè - Á¥ßÂáëÂåñÂ∏ÉÂ±Ä */
.dynamic-form-area {
  margin-top: 6px;
  border: 1px dashed var(--border-color);
  border-radius: 4px;
  padding: 8px;
  background: var(--hover-color);
  transition: all 0.2s ease;
  min-height: 60px;
}

.dynamic-form-area:hover {
  border-color: var(--primary-color);
  background: var(--primary-color-hover);
}

/* ÂºπÁ™óÂÜÖÈÉ®Ë°®ÂçïÈ°πÁ¥ßÂáëÂåñ */
.dynamic-form-area .n-form-item {
  margin-bottom: 0;
}

/* ÂºπÁ™óÊñáÊú¨Âå∫Âüü‰ºòÂåñ */
.dynamic-form-area .n-input__textarea-el {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
  font-size: 12px;
  line-height: 1.4;
}

/* Á±ªÂûãÊ†áÁ≠æÊ†∑ÂºèË∞ÉÊï¥ */
.dynamic-form-area .n-tag {
  transition: all 0.15s ease;
}

.dynamic-form-area .n-tag:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ÊòéÊöó‰∏ªÈ¢òÈÄÇÈÖç */
[data-theme='dark'] .dynamic-form-area {
  background: rgba(255, 255, 255, 0.03);
  border-color: rgba(255, 255, 255, 0.1);
}

[data-theme='dark'] .dynamic-form-area:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: var(--primary-color);
}

[data-theme='light'] .dynamic-form-area {
  background: rgba(0, 0, 0, 0.02);
  border-color: rgba(0, 0, 0, 0.08);
}

[data-theme='light'] .dynamic-form-area:hover {
  background: rgba(0, 0, 0, 0.03);
  border-color: var(--primary-color);
}

/* üî• ÁÆÄÂåñÔºöÁßªÈô§Â§çÊùÇÊ†∑ÂºèÔºå‰ΩøÁî®Ê†áÂáÜË°®ÂçïÊ†∑Âºè */
</style>
