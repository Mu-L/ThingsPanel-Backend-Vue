<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>输入框焦点丢失修复测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-header {
      background: linear-gradient(135deg, #ff7875 0%, #fa8c16 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    .test-section {
      margin-bottom: 32px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
    }
    .issue-item {
      margin-bottom: 16px;
      padding: 16px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #ff4d4f;
    }
    .issue-item.fixed {
      border-left-color: #52c41a;
      background: #f6ffed;
    }
    .issue-item h4 {
      margin: 0 0 8px 0;
      color: #ff4d4f;
    }
    .issue-item.fixed h4 {
      color: #52c41a;
    }
    .issue-item p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .step {
      margin-bottom: 16px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #2080f0;
    }
    .step h4 {
      margin: 0 0 8px 0;
      color: #333;
    }
    .step p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .nav-link {
      display: inline-block;
      padding: 12px 24px;
      background: #2080f0;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      margin-right: 12px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    .nav-link:hover {
      background: #40a9ff;
      transform: translateY(-1px);
    }
    .code-block {
      background: #f8f8f8;
      padding: 16px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #333;
      margin: 12px 0;
      border: 1px solid #e0e0e0;
    }
    .before-after {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .before, .after {
      padding: 16px;
      border-radius: 6px;
    }
    .before {
      background: #fff2f0;
      border: 1px solid #ffccc7;
    }
    .after {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>🛠️ 输入框焦点丢失修复测试</h1>
      <p>修复URL参数配置中输入框失去焦点和默认值覆盖的问题</p>
    </div>

    <div class="test-section">
      <h3>🐛 修复的问题清单</h3>
      
      <div class="issue-item fixed">
        <h4>✅ 问题1：输入框焦点丢失</h4>
        <p>每次输入一个字符后，参数名输入框失去焦点，需要重新点击才能继续输入</p>
        <p><strong>根本原因</strong>：Vue key值不稳定，每次输入触发组件重新渲染</p>
      </div>

      <div class="issue-item fixed">
        <h4>✅ 问题2：默认值强制覆盖用户输入</h4>
        <p>清空参数名输入框后，会被默认值自动填充，无法保持空值状态</p>
        <p><strong>根本原因</strong>：缺少合理的默认值策略，过度的自动填充逻辑</p>
      </div>

      <div class="issue-item fixed">
        <h4>✅ 问题3：频繁的组件重新渲染</h4>
        <p>每次键盘输入都触发整个参数列表重新渲染，影响性能和用户体验</p>
        <p><strong>根本原因</strong>：缺少防抖机制，过度的响应式更新</p>
      </div>
    </div>

    <div class="test-section">
      <h3>🔧 修复方案对比</h3>
      
      <div class="before-after">
        <div class="before">
          <h4>修复前 ❌</h4>
          <div class="code-block">
// 不稳定的key值（包含param.key）
:key="param._id || `param-${index}-${param.key || 'empty'}`"

// 每次输入都触发更新
@update:value="value => updateParameter({ ...param, key: value }, index)"

// 无防抖机制，频繁重新渲染
const updateParameter = (param, index) => {
  emit('update:modelValue', updatedParams)
}
          </div>
        </div>
        
        <div class="after">
          <h4>修复后 ✅</h4>
          <div class="code-block">
// 稳定的key值（仅使用_id）
:key="param._id"

// 使用@input替代@update:value
@input="value => updateParameterKey(param, index, value)"

// 添加blur事件处理默认值逻辑
@blur="() => ensureParameterKeyNotEmpty(param, index)"

// 计算属性确保所有参数都有稳定ID
const parametersWithStableIds = computed(() => {
  return props.modelValue.map((param, index) => 
    ensureParameterHasId(param, index)
  )
})
          </div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h3>🚀 核心修复内容</h3>
      
      <div class="step">
        <h4>修复1：稳定的Vue Key值</h4>
        <p>• 使用纯_id作为key，不再依赖可变的param.key<br>
           • 为历史参数自动生成稳定的ID<br>
           • 确保Vue能正确追踪DOM元素，避免重新创建</p>
      </div>

      <div class="step">
        <h4>修复2：优化的输入事件处理</h4>
        <p>• 使用@input替代@update:value，提供更好的输入体验<br>
           • 立即更新显示值，避免输入延迟<br>
           • 移除不必要的防抖定时器（简化逻辑）</p>
      </div>

      <div class="step">
        <h4>修复3：合理的默认值策略</h4>
        <p>• 仅在完全为空时设置默认值（失去焦点时检查）<br>
           • 不强制覆盖用户的输入<br>
           • 提供更友好的用户体验</p>
      </div>

      <div class="step">
        <h4>修复4：历史参数兼容性</h4>
        <p>• 自动为没有_id的历史参数生成稳定ID<br>
           • 通过计算属性确保兼容性<br>
           • 不影响现有功能</p>
      </div>
    </div>

    <div class="test-section">
      <h3>📋 测试步骤</h3>
      
      <div class="step">
        <h4>步骤1：访问数据源系统测试页面</h4>
        <p>打开数据源系统测试页面，找到HTTP配置表单</p>
        <a href="http://localhost:5002/test/data-source-system" class="nav-link" target="_blank">
          数据源系统测试
        </a>
      </div>

      <div class="step">
        <h4>步骤2：测试参数名输入框</h4>
        <p>1. 点击"添加参数"添加新的URL参数<br>
           2. 在参数名输入框中<strong>连续输入多个字符</strong><br>
           3. <strong>验证：输入框应保持焦点，无需重新点击</strong></p>
      </div>

      <div class="step">
        <h4>步骤3：测试默认值逻辑</h4>
        <p>1. 将参数名输入框完全清空<br>
           2. 点击其他地方使输入框失去焦点<br>
           3. <strong>验证：应设置合理的默认值如"param1"</strong><br>
           4. 再次编辑时，应能正常清空和修改</p>
      </div>

      <div class="step">
        <h4>步骤4：测试参数值输入框</h4>
        <p>1. 点击参数的"配置"按钮展开详情面板<br>
           2. 在"值"输入框中连续输入<br>
           3. <strong>验证：输入框应保持焦点，输入流畅</strong></p>
      </div>
    </div>

    <div class="test-section">
      <h3>✅ 预期结果</h3>
      
      <div class="step">
        <h4>🎯 输入体验改善</h4>
        <p>• 输入框保持焦点，可以连续输入而无需重新点击<br>
           • 输入响应流畅，没有明显的延迟<br>
           • 不会出现意外的默认值覆盖</p>
      </div>

      <div class="step">
        <h4>🚀 性能提升</h4>
        <p>• 减少不必要的组件重新渲染<br>
           • 稳定的DOM元素追踪<br>
           • 更好的Vue响应式性能</p>
      </div>

      <div class="step">
        <h4>🛡️ 兼容性保证</h4>
        <p>• 历史参数正常显示和编辑<br>
           • 不影响现有的参数配置功能<br>
           • 保持与其他组件的集成</p>
      </div>
    </div>

    <div class="test-section">
      <h3>🔗 相关测试链接</h3>
      <a href="http://localhost:5002/test/data-source-system" class="nav-link" target="_blank">
        数据源系统测试
      </a>
      <a href="http://localhost:5002/test/data-binding-system-integration" class="nav-link" target="_blank">
        数据绑定系统测试
      </a>
      <a href="http://localhost:5002/test/editor-integration" class="nav-link" target="_blank">
        编辑器集成测试
      </a>
    </div>

    <div class="test-section" style="background: #e6f7ff; border-color: #91d5ff;">
      <h3>💡 技术要点总结</h3>
      
      <div class="code-block">
// 核心修复：稳定的Vue Key值
:key="param._id"  // 只依赖稳定ID，不依赖可变属性

// 优化的事件处理
@input="value => updateParameterKey(param, index, value)"  // 立即响应
@blur="() => ensureParameterKeyNotEmpty(param, index)"     // 智能默认值

// 兼容性处理
const parametersWithStableIds = computed(() => {
  return props.modelValue.map((param, index) => ensureParameterHasId(param, index))
})
      </div>
    </div>
  </div>
</body>
</html>