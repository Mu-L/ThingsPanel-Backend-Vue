# ThingsPanel 工具函数和基础设施详解

## 基础设施概述

ThingsPanel项目在核心业务功能之外，还构建了一套完整的基础设施系统，包括工具函数、组合式函数、类型定义、国际化系统和卡片生态。这些基础设施为整个应用提供了坚实的技术支撑，体现了现代前端架构的最佳实践。

## 1. 工具函数系统 (src/utils)

### 目录结构
```
src/utils/
├── common/                    # 通用工具函数
│   ├── datetime.ts            # 时间处理工具
│   ├── number.ts              # 数字处理工具
│   └── tool.ts                # 通用工具集合
├── echarts/                   # 图表工具
│   └── echarts-manager.ts     # ECharts管理器
├── form/                      # 表单工具
│   └── rule.ts                # 表单验证规则
├── service/                   # 服务工具
│   ├── handler.ts             # 请求处理器
│   └── index.ts               # 服务工具入口
├── common4.ts                 # 兼容性工具
├── logger.ts                  # 日志系统
├── storage.ts                 # 存储工具
├── websocketUtil.ts           # WebSocket工具
└── usePageCache.ts            # 页面缓存Hook
```

### 核心功能模块

#### 时间处理工具 (datetime.ts)
```typescript
/**
 * 时间格式化工具
 * 基于Day.js实现统一的时间处理
 */
export function formatDateTime(ts: string | null | undefined): string | null {
  return ts ? dayjs(ts).format('YYYY-MM-DD HH:mm:ss') : null
}

export function formatDate(ts: string | null | undefined): string | null {
  return ts ? dayjs(ts).format('YYYY-MM-DD') : null
}

export function formatTime(ts: string | null | undefined): string | null {
  return ts ? dayjs(ts).format('HH:mm:ss') : null
}

export function getRelativeTime(ts: string): string {
  return dayjs(ts).fromNow()
}
```

#### 通用工具集 (tool.ts)
```typescript
/**
 * 通用工具函数库
 * 包含RSA加密、深度克隆、UUID生成等功能
 */

// RSA加密解密
export function encryptDataByRsa(data: string): string {
  const key = '-----BEGIN PUBLIC KEY-----\n...';
  const encryptor = new JSEncrypt();
  encryptor.setPublicKey(key);
  return encryptor.encrypt(data) || '';
}

// 深度克隆
export function deepClone<T>(obj: T): T {
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }
  
  if (obj instanceof Date) {
    return new Date(obj.getTime()) as unknown as T;
  }
  
  if (obj instanceof Array) {
    return obj.map(item => deepClone(item)) as unknown as T;
  }
  
  if (typeof obj === 'object') {
    const clonedObj = {} as T;
    for (const key in obj) {
      clonedObj[key] = deepClone(obj[key]);
    }
    return clonedObj;
  }
  
  return obj;
}

// UUID生成
export function generateUUID(): string {
  return nanoid();
}

// 类型检测工具
export function isObject(value: unknown): value is Record<string, any> {
  return value !== null && typeof value === 'object';
}

export function isArray(value: unknown): value is Array<any> {
  return Array.isArray(value);
}

// 服务器URL获取
export function getApiServerUrl(): string {
  const protocol = window.location.protocol;
  const hostname = window.location.hostname;
  const port = window.location.port;
  return `${protocol}//${hostname}:${port}/api/v1`;
}

export function getWebSocketUrl(): string {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const hostname = window.location.hostname;
  const port = window.location.port;
  return `${protocol}//${hostname}:${port}/ws`;
}
```

#### 日志系统 (logger.ts)
```typescript
/**
 * 统一日志系统
 * 支持模块化日志记录和环境适配
 */
export default class Logger {
  private moduleName: string
  private isDev: boolean

  constructor(moduleName: string = '') {
    this.moduleName = moduleName
    this.isDev = import.meta.env.MODE === 'development'
  }

  info(...args: any[]) {
    if (this.isDev) {
      console.info(`[INFO][${this.moduleName}]`, ...args)
    }
  }

  debug(...args: any[]) {
    if (this.isDev) {
      console.debug(`[DEBUG][${this.moduleName}]`, ...args)
    }
  }

  warn(...args: any[]) {
    console.warn(`[WARN][${this.moduleName}]`, ...args)
  }

  error(...args: any[]) {
    console.error(`[ERROR][${this.moduleName}]`, ...args)
  }

  /**
   * 性能监控日志
   */
  performance(label: string, fn: () => void) {
    if (this.isDev) {
      console.time(`[PERF][${this.moduleName}] ${label}`)
      fn()
      console.timeEnd(`[PERF][${this.moduleName}] ${label}`)
    } else {
      fn()
    }
  }
}

// 创建模块化日志实例
export const createLogger = (moduleName: string) => new Logger(moduleName)
```

#### WebSocket实时通信工具 (websocketUtil.ts)
```typescript
/**
 * WebSocket实时通信工具
 * 支持多设备连接、自动重连、心跳检测
 */
export class WebSocketManager {
  private connections = new Map<string, WebSocket>()
  private reconnectTimers = new Map<string, NodeJS.Timeout>()
  private heartbeatTimers = new Map<string, NodeJS.Timeout>()

  /**
   * 创建WebSocket连接
   */
  connect(deviceId: string, onMessage: (data: any) => void): WebSocket {
    const url = `${getWebSocketUrl()}/device/${deviceId}`
    const ws = new WebSocket(url)

    ws.onopen = () => {
      console.log(`WebSocket连接成功: ${deviceId}`)
      this.startHeartbeat(deviceId, ws)
    }

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data)
        onMessage(data)
      } catch (error) {
        console.error('WebSocket消息解析失败:', error)
      }
    }

    ws.onclose = () => {
      console.log(`WebSocket连接关闭: ${deviceId}`)
      this.handleReconnect(deviceId, onMessage)
    }

    ws.onerror = (error) => {
      console.error(`WebSocket连接错误: ${deviceId}`, error)
    }

    this.connections.set(deviceId, ws)
    return ws
  }

  /**
   * 自动重连机制
   */
  private handleReconnect(deviceId: string, onMessage: (data: any) => void) {
    const timer = setTimeout(() => {
      console.log(`尝试重连WebSocket: ${deviceId}`)
      this.connect(deviceId, onMessage)
    }, 3000)

    this.reconnectTimers.set(deviceId, timer)
  }

  /**
   * 心跳检测
   */
  private startHeartbeat(deviceId: string, ws: WebSocket) {
    const timer = setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }))
      }
    }, 30000)

    this.heartbeatTimers.set(deviceId, timer)
  }

  /**
   * 断开连接
   */
  disconnect(deviceId: string) {
    const ws = this.connections.get(deviceId)
    if (ws) {
      ws.close()
      this.connections.delete(deviceId)
    }

    // 清理定时器
    const reconnectTimer = this.reconnectTimers.get(deviceId)
    if (reconnectTimer) {
      clearTimeout(reconnectTimer)
      this.reconnectTimers.delete(deviceId)
    }

    const heartbeatTimer = this.heartbeatTimers.get(deviceId)
    if (heartbeatTimer) {
      clearInterval(heartbeatTimer)
      this.heartbeatTimers.delete(deviceId)
    }
  }

  /**
   * 发送消息
   */
  send(deviceId: string, message: any) {
    const ws = this.connections.get(deviceId)
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(message))
    } else {
      console.warn(`WebSocket未连接或已关闭: ${deviceId}`)
    }
  }
}

// 全局WebSocket管理器实例
export const wsManager = new WebSocketManager()
```

#### ECharts管理器 (echarts-manager.ts)
```typescript
/**
 * ECharts图表管理器
 * 提供统一的图表实例管理和主题切换
 */
import { init, dispose, registerTheme } from 'echarts/core'
import type { ECharts, EChartsOption } from 'echarts/core'

export class EChartsManager {
  private charts = new Map<string, ECharts>()
  private currentTheme: 'light' | 'dark' = 'light'

  /**
   * 初始化图表
   */
  initChart(container: HTMLElement, theme?: string): ECharts {
    const chart = init(container, theme || this.currentTheme)
    const chartId = nanoid()
    this.charts.set(chartId, chart)
    
    // 存储图表ID到DOM元素
    container.setAttribute('data-chart-id', chartId)
    
    return chart
  }

  /**
   * 销毁图表
   */
  disposeChart(chartOrContainer: ECharts | HTMLElement) {
    let chartId: string | undefined
    
    if (chartOrContainer instanceof HTMLElement) {
      chartId = chartOrContainer.getAttribute('data-chart-id') || undefined
      if (chartId) {
        const chart = this.charts.get(chartId)
        if (chart) {
          dispose(chart)
          this.charts.delete(chartId)
        }
      }
    } else {
      // 查找对应的chartId
      for (const [id, chart] of this.charts.entries()) {
        if (chart === chartOrContainer) {
          dispose(chart)
          this.charts.delete(id)
          break
        }
      }
    }
  }

  /**
   * 切换全局主题
   */
  switchTheme(theme: 'light' | 'dark') {
    this.currentTheme = theme
    
    // 重新初始化所有图表
    this.charts.forEach((chart, id) => {
      const container = chart.getDom()
      const option = chart.getOption()
      
      // 销毁旧图表
      dispose(chart)
      
      // 重新创建图表
      const newChart = init(container, theme)
      newChart.setOption(option)
      
      this.charts.set(id, newChart)
    })
  }

  /**
   * 注册自定义主题
   */
  registerCustomTheme(themeName: string, theme: any) {
    registerTheme(themeName, theme)
  }

  /**
   * 获取所有图表实例
   */
  getAllCharts(): ECharts[] {
    return Array.from(this.charts.values())
  }

  /**
   * 响应窗口大小变化
   */
  resizeAllCharts() {
    this.charts.forEach(chart => {
      chart.resize()
    })
  }
}

// 全局ECharts管理器实例
export const echartsManager = new EChartsManager()

// 自动响应窗口大小变化
window.addEventListener('resize', () => {
  echartsManager.resizeAllCharts()
})
```

## 2. 组合式函数系统 (src/hooks)

### 目录结构
```
src/hooks/
├── business/                  # 业务相关Hooks
│   ├── use-hook-table.ts      # 通用表格Hook
│   ├── use-count-down.ts      # 倒计时Hook
│   ├── use-sms-code.ts        # 短信验证码Hook
│   └── use-image-verify.ts    # 图片验证Hook
├── chart/                     # 图表相关Hooks
│   ├── use-echarts.ts         # ECharts集成Hook
│   └── use-tp-echarts.ts      # ThingsPanel定制ECharts
├── common/                    # 通用Hooks
│   ├── form.ts                # 表单Hook
│   ├── router.ts              # 路由Hook
│   ├── table.ts               # 表格Hook
│   └── use-loading-empty.ts   # 加载状态Hook
└── tp-chart/                  # ThingsPanel图表专用Hooks
```

### 核心组合式函数

#### 通用表格Hook (use-hook-table.ts)
```typescript
/**
 * 通用表格Hook
 * 提供分页、加载、数据转换等完整功能
 */
interface HookTableConfig<TableData, ApiFn> {
  apiRequestAdapter?: ApiRequestAdapter<TableData, ApiFn>
  apiDataAdapter?: ApiDataAdapter<TableData>
  columns: DataTableColumns<TableData>
  pagination?: PaginationProps
  immediate?: boolean
}

export default function useHookTable<TableData = any, ApiFn = any>(
  apiFn: ApiFn,
  config: HookTableConfig<TableData, ApiFn>
) {
  const { 
    apiRequestAdapter,
    apiDataAdapter,
    columns: propColumns,
    pagination: propPagination = {},
    immediate = true
  } = config

  // 表格数据状态
  const data = ref<TableData[]>([])
  const columns = ref<DataTableColumns<TableData>>(propColumns)
  const loading = ref(false)
  const empty = computed(() => data.value.length === 0)

  // 分页状态
  const pagination = reactive({
    page: 1,
    pageSize: 10,
    itemCount: 0,
    showSizePicker: true,
    pageSizes: [10, 20, 50, 100],
    ...propPagination,
    onChange: (page: number) => {
      pagination.page = page
      getData()
    },
    onUpdatePageSize: (pageSize: number) => {
      pagination.pageSize = pageSize
      pagination.page = 1
      getData()
    }
  })

  /**
   * 获取表格数据
   */
  async function getData() {
    try {
      loading.value = true

      // 准备请求参数
      const params = apiRequestAdapter ? 
        apiRequestAdapter(pagination) : 
        { page: pagination.page, pageSize: pagination.pageSize }

      // 调用API
      const response = await (apiFn as any)(params)

      // 数据适配
      if (apiDataAdapter) {
        const adaptedData = apiDataAdapter(response)
        data.value = adaptedData.data || []
        pagination.itemCount = adaptedData.total || 0
      } else {
        data.value = response.data || []
        pagination.itemCount = response.total || 0
      }
    } catch (error) {
      console.error('获取表格数据失败:', error)
      data.value = []
      pagination.itemCount = 0
    } finally {
      loading.value = false
    }
  }

  /**
   * 重新加载数据
   */
  function reloadData() {
    pagination.page = 1
    getData()
  }

  /**
   * 更新列配置
   */
  function reloadColumns(newColumns: DataTableColumns<TableData>) {
    columns.value = newColumns
  }

  /**
   * 更新分页配置
   */
  function updatePagination(newPagination: Partial<PaginationProps>) {
    Object.assign(pagination, newPagination)
  }

  // 立即执行
  if (immediate) {
    getData()
  }

  return {
    data: readonly(data),
    columns: readonly(columns),
    loading: readonly(loading),
    empty,
    pagination,
    getData,
    reloadData,
    reloadColumns,
    updatePagination
  }
}
```

#### ECharts集成Hook (use-echarts.ts)
```typescript
/**
 * ECharts图表Hook
 * 提供主题切换、尺寸自适应、生命周期管理
 */
export interface ChartHooks {
  onRender?: (chart: ECharts) => void
  onUpdated?: (chart: ECharts) => void
  onDestroy?: (chart: ECharts) => void
}

export function useEcharts<T extends ECOption>(
  optionsFactory: () => T,
  hooks: ChartHooks = {}
) {
  const domRef = ref<HTMLElement>()
  const initialOptions = optionsFactory()
  let chart: ECharts | null = null

  const { width, height } = useElementSize(domRef)
  const { theme } = useThemeStore()

  /**
   * 初始化图表
   */
  function initChart() {
    if (!domRef.value) return

    // 使用全局图表管理器创建图表
    chart = echartsManager.initChart(domRef.value, theme === 'dark' ? 'dark' : 'light')
    
    chart.setOption(initialOptions)
    hooks.onRender?.(chart)
  }

  /**
   * 更新图表选项
   */
  function updateOptions(newOptions: T, notMerge = false) {
    if (chart) {
      chart.setOption(newOptions, notMerge)
      hooks.onUpdated?.(chart)
    }
  }

  /**
   * 销毁图表
   */
  function destroyChart() {
    if (chart) {
      hooks.onDestroy?.(chart)
      echartsManager.disposeChart(chart)
      chart = null
    }
  }

  // 响应尺寸变化
  watch([width, height], () => {
    if (chart) {
      chart.resize()
    }
  })

  // 响应主题变化
  watch(() => theme, (newTheme) => {
    if (chart) {
      // 重新创建图表以应用新主题
      const currentOptions = chart.getOption()
      destroyChart()
      nextTick(() => {
        initChart()
        updateOptions(currentOptions as T)
      })
    }
  })

  // 生命周期管理
  onMounted(() => {
    nextTick(initChart)
  })

  onBeforeUnmount(() => {
    destroyChart()
  })

  return {
    domRef,
    updateOptions,
    getInstance: () => chart
  }
}
```

#### 表单验证Hook (form.ts)
```typescript
/**
 * 表单验证规则Hook
 * 提供统一的表单验证规则和国际化支持
 */
export function useFormRules() {
  const { $t } = useI18n()

  // 基础验证规则
  const patternRules = {
    email: {
      pattern: /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,
      message: $t('form.email.invalid'),
      trigger: 'blur'
    },
    phone: {
      pattern: /^1[3-9]\d{9}$/,
      message: $t('form.phone.invalid'),
      trigger: 'blur'
    },
    userName: {
      pattern: /^[a-zA-Z0-9_-]{4,16}$/,
      message: $t('form.userName.invalid'),
      trigger: 'blur'
    },
    password: {
      pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/,
      message: $t('form.password.invalid'),
      trigger: 'blur'
    },
    url: {
      pattern: /^https?:\/\/.+/,
      message: $t('form.url.invalid'),
      trigger: 'blur'
    },
    ip: {
      pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
      message: $t('form.ip.invalid'),
      trigger: 'blur'
    }
  }

  /**
   * 创建必填验证规则
   */
  function createRequiredRule(message: string) {
    return {
      required: true,
      message,
      trigger: 'blur'
    }
  }

  /**
   * 创建长度验证规则
   */
  function createLengthRule(min: number, max: number, message?: string) {
    return {
      min,
      max,
      message: message || $t('form.length.invalid', { min, max }),
      trigger: 'blur'
    }
  }

  /**
   * 创建自定义验证规则
   */
  function createCustomRule(validator: (rule: any, value: any) => boolean | Promise<boolean>, message: string) {
    return {
      validator: async (rule: any, value: any) => {
        const result = await validator(rule, value)
        if (!result) {
          throw new Error(message)
        }
        return true
      },
      trigger: 'blur'
    }
  }

  // 常用表单规则组合
  const formRules = {
    userName: [
      createRequiredRule($t('form.userName.required')),
      patternRules.userName
    ],
    email: [
      createRequiredRule($t('form.email.required')),
      patternRules.email
    ],
    password: [
      createRequiredRule($t('form.password.required')),
      patternRules.password
    ],
    phone: [
      createRequiredRule($t('form.phone.required')),
      patternRules.phone
    ],
    confirmPassword: (passwordRef: Ref<string>) => [
      createRequiredRule($t('form.confirmPassword.required')),
      createCustomRule(
        (_, value) => value === passwordRef.value,
        $t('form.confirmPassword.notMatch')
      )
    ]
  }

  return {
    patternRules,
    formRules,
    createRequiredRule,
    createLengthRule,
    createCustomRule
  }
}
```

## 3. 类型定义系统 (src/typings)

### 目录结构
```
src/typings/
├── app.d.ts              # 应用全局类型
├── business.d.ts         # 业务领域类型
├── api.d.ts              # API接口类型
├── common.d.ts           # 通用类型
├── device/               # 设备相关类型
│   └── device.d.ts
├── panel/                # 面板相关类型
│   └── panel.d.ts
├── router.d.ts           # 路由类型
├── storage.d.ts          # 存储类型
├── vue.d.ts              # Vue扩展类型
├── components.d.ts       # 组件类型
├── env.d.ts              # 环境变量类型
├── global.d.ts           # 全局声明
├── modules.d.ts          # 模块声明
└── union-key.d.ts        # 联合类型
```

### 核心类型定义

#### 应用全局类型 (app.d.ts)
```typescript
declare namespace App {
  /**
   * 主题系统类型
   */
  namespace Theme {
    interface ThemeSetting {
      themeScheme: ThemeScheme
      grayscale: boolean
      themeColor: string
      otherColor: OtherColor
      isCustomizeInfoColor: boolean
      layout: Layout
      page: Page
      header: Header
      tab: Tab
      sider: Sider
      footer: Footer
    }

    type ThemeScheme = 'light' | 'dark' | 'auto'
    
    interface ThemeColor {
      primary: string
      info: string
      success: string
      warning: string
      error: string
    }
  }

  /**
   * 全局通用类型
   */
  namespace Global {
    interface Menu {
      key: string
      label: string
      routeName: string
      routePath: string
      icon?: string
      children?: Menu[]
    }

    interface Tab {
      id: string
      label: string
      routeName: string
      routePath: string
      query?: Record<string, any>
      icon?: string
      activeMenu?: string
    }

    interface Breadcrumb {
      key: string
      label: string
      routeName: string
    }

    type FormRule = import('naive-ui').FormItemRule
    type DropdownOption = import('naive-ui').DropdownOption
  }

  /**
   * 国际化类型系统
   */
  namespace I18n {
    type LangType = 'en-US' | 'zh-CN'
    
    interface Schema {
      common: {
        add: string
        delete: string
        edit: string
        query: string
        // ... 更多通用词汇
      }
      route: {
        home: string
        dashboard: string
        device: string
        // ... 路由翻译
      }
      form: {
        required: string
        invalid: string
        // ... 表单翻译
      }
      // ... 其他领域翻译
    }

    type I18nKey = import('vue-i18n').Path<Schema>
    type $T = (key: I18nKey, ...args: any[]) => string
  }

  /**
   * 服务类型
   */
  namespace Service {
    interface ServiceConfig {
      baseURL: string
      otherBaseURL: OtherBaseURL
    }

    interface OtherBaseURL {
      demo?: string
      mock?: string
    }

    type OtherBaseURLKey = keyof OtherBaseURL

    type ServiceConfigMap = Record<Env.ServiceEnvType, ServiceConfig>

    interface Response<T = unknown> {
      code: string
      msg: string
      data: T
    }

    type DEVResponse<T = unknown> = Response<T>
    type MockResponse<T = unknown> = Response<T>
  }
}
```

#### API类型定义 (api.d.ts)
```typescript
declare namespace Api {
  /**
   * 基础API类型
   */
  namespace BaseApi {
    interface Response<T = any> {
      code: number
      message: string
      data: T
    }

    interface PaginatedResponse<T = any> extends Response<T[]> {
      total: number
      page: number
      pageSize: number
    }
  }

  /**
   * 通用类型约束
   */
  namespace Common {
    interface PaginatingCommonParams {
      page?: number
      pageSize?: number
    }

    interface CommonSearchParams extends PaginatingCommonParams {
      keyword?: string
      startTime?: string
      endTime?: string
    }

    interface CommonRecord {
      id: string
      createTime?: string
      updateTime?: string
    }
  }

  /**
   * 认证相关类型
   */
  namespace Auth {
    interface LoginToken {
      token: string
      refreshToken?: string
    }

    interface UserInfo {
      id: string
      userName: string
      userRole: string
      email?: string
      phone?: string
      avatar?: string
      permissions?: string[]
    }

    interface RegisterParams {
      userName: string
      email: string
      password: string
      confirmPassword: string
      code: string
    }

    interface ResetPasswordParams {
      email: string
      code: string
      password: string
    }

    type RoleType = 'SYS_ADMIN' | 'TENANT_ADMIN' | 'TENANT_USER'
  }

  /**
   * 设备管理类型
   */
  namespace Device {
    interface DeviceInfo extends Common.CommonRecord {
      name: string
      deviceNo: string
      status: 'online' | 'offline'
      deviceType: string
      protocol: string
      description?: string
      location?: {
        longitude: number
        latitude: number
      }
      lastActiveTime?: string
    }

    interface TelemetryData {
      deviceId: string
      key: string
      value: any
      timestamp: number
      dataType: 'int' | 'float' | 'string' | 'boolean' | 'json'
    }

    interface AttributeData {
      deviceId: string
      key: string
      value: any
      clientScope: boolean
      sharedScope: boolean
    }

    interface CommandData extends Common.CommonRecord {
      deviceId: string
      command: string
      params: Record<string, any>
      status: 'pending' | 'success' | 'failed' | 'timeout'
      result?: any
      executeTime?: string
    }

    interface DeviceGroup extends Common.CommonRecord {
      name: string
      description?: string
      parentId?: string
      children?: DeviceGroup[]
      deviceCount?: number
    }
  }

  /**
   * 面板管理类型
   */
  namespace Panel {
    interface Board extends Common.CommonRecord {
      name: string
      description?: string
      config: BoardConfig
      isHome: boolean
      thumbnail?: string
    }

    interface BoardConfig {
      layout: LayoutItem[]
      theme: ThemeConfig
      settings: BoardSettings
    }

    interface LayoutItem {
      id: string
      type: string
      x: number
      y: number
      w: number
      h: number
      props: Record<string, any>
    }

    interface ThemeConfig {
      primaryColor: string
      backgroundColor: string
      textColor: string
      borderColor: string
    }

    interface BoardSettings {
      refreshInterval?: number
      autoRefresh?: boolean
      allowEdit?: boolean
    }
  }
}
```

#### 业务领域类型 (business.d.ts)
```typescript
/**
 * 设备管理业务类型扩展
 */
declare namespace DeviceManagement {
  interface Service extends Api.Common.CommonRecord {
    name: string
    description?: string
    status: 'active' | 'inactive'
    serviceType: string
    config: Record<string, any>
    deviceCount?: number
  }

  interface DeviceDetail extends Api.Device.DeviceInfo {
    telemetryData?: Api.Device.TelemetryData[]
    attributes?: Record<string, any>
    commands?: Api.Device.CommandData[]
    alarmRules?: AlarmRule[]
  }

  interface AlarmRule extends Api.Common.CommonRecord {
    name: string
    deviceId: string
    condition: AlarmCondition
    actions: AlarmAction[]
    enabled: boolean
  }

  interface AlarmCondition {
    telemetryKey: string
    operator: 'gt' | 'lt' | 'eq' | 'ne' | 'gte' | 'lte'
    value: any
    duration?: number
  }

  interface AlarmAction {
    type: 'email' | 'sms' | 'webhook' | 'notification'
    config: Record<string, any>
  }

  type DeviceTypeKey = string
  type ProtocolType = 'MQTT' | 'HTTP' | 'CoAP' | 'WebSocket' | 'TCP' | 'UDP'
}

/**
 * 可视化编辑器类型扩展
 */
declare namespace VisualEditor {
  interface ComponentDefinition {
    id: string
    name: string
    type: string
    category: string
    icon: string
    component: any
    configPanel?: any
    defaultProps: Record<string, any>
    schema: ComponentSchema
  }

  interface ComponentSchema {
    props: Record<string, PropSchema>
    events?: Record<string, EventSchema>
    slots?: Record<string, SlotSchema>
  }

  interface PropSchema {
    type: 'string' | 'number' | 'boolean' | 'object' | 'array'
    default?: any
    required?: boolean
    description?: string
    options?: Array<{ label: string; value: any }>
  }

  interface EventSchema {
    description?: string
    params?: Record<string, PropSchema>
  }

  interface SlotSchema {
    description?: string
    props?: Record<string, PropSchema>
  }
}

/**
 * 自定义路由类型
 */
declare namespace CustomRoute {
  interface Route extends Api.Route.MenuRoute {
    component?: any
    redirect?: string
    children?: Route[]
  }
}
```

## 4. 国际化系统 (src/locales)

### 目录结构
```
src/locales/
├── index.ts                   # 国际化系统入口
├── locale.ts                  # 语言包加载器
├── dayjs.ts                   # Day.js国际化配置
├── naive.ts                   # Naive UI国际化配置
├── langs/                     # 语言包目录
│   ├── zh-cn/                 # 中文语言包
│   │   ├── common.json        # 通用翻译
│   │   ├── page.json          # 页面翻译
│   │   ├── route.json         # 路由翻译
│   │   ├── form.json          # 表单翻译
│   │   ├── theme.json         # 主题翻译
│   │   ├── card.json          # 卡片翻译
│   │   ├── visual-editor.json # 可视化编辑器翻译
│   │   ├── device.json        # 设备管理翻译
│   │   ├── panel.json         # 面板管理翻译
│   │   └── ...               # 其他业务领域翻译
│   └── en-us/                 # 英文语言包（相同结构）
└── ThingsPanel国际化开发指南.md
```

### 国际化系统核心实现

#### 系统入口配置 (index.ts)
```typescript
/**
 * Vue I18n国际化系统配置
 */
import { createI18n } from 'vue-i18n'
import { localStg } from '@/utils/storage'
import messages from './locale'

export const i18n = createI18n({
  locale: localStg.get('lang') || 'zh-CN',
  fallbackLocale: 'en-US',
  messages,
  legacy: false,  // 使用Composition API模式
  globalInjection: true,  // 全局注入$t函数
  silentTranslationWarn: true,  // 静默翻译警告
  silentFallbackWarn: true      // 静默回退警告
})

/**
 * 导出全局翻译函数
 */
export const $t = i18n.global.t as I18n.$T

/**
 * 设置语言
 */
export function setLocale(locale: I18n.LangType) {
  i18n.global.locale.value = locale
  localStg.set('lang', locale)
  
  // 更新HTML lang属性
  document.documentElement.lang = locale
}

/**
 * 获取当前语言
 */
export function getLocale(): I18n.LangType {
  return i18n.global.locale.value as I18n.LangType
}

/**
 * 获取可用语言列表
 */
export function getAvailableLocales(): I18n.LangType[] {
  return i18n.global.availableLocales as I18n.LangType[]
}

/**
 * Setup plugin i18n
 */
export function setupI18n(app: App) {
  app.use(i18n)
}
```

#### 语言包加载器 (locale.ts)
```typescript
/**
 * 自动加载语言包
 */
interface Messages {
  [key: string]: any
}

// 中文语言包加载
const zhCN = import.meta.glob('./langs/zh-cn/*.json', { eager: true })
const enUS = import.meta.glob('./langs/en-us/*.json', { eager: true })

/**
 * 转换语言包格式
 */
function transformMessages(messages: Record<string, any>): Messages {
  const result: Messages = {}
  
  for (const [path, module] of Object.entries(messages)) {
    const key = path.replace(/^\.\/langs\/[^/]+\/(.+)\.json$/, '$1')
    result[key] = (module as any).default
  }
  
  return result
}

// 组装最终的语言包
const messages = {
  'zh-CN': transformMessages(zhCN),
  'en-US': transformMessages(enUS)
}

export default messages
```

#### 第三方库国际化配置

##### Naive UI配置 (naive.ts)
```typescript
/**
 * Naive UI组件库国际化配置
 */
import { dateEnUS, dateZhCN, enUS, zhCN } from 'naive-ui'

export const naiveLocales = {
  'zh-CN': zhCN,
  'en-US': enUS
}

export const naiveDateLocales = {
  'zh-CN': dateZhCN,
  'en-US': dateEnUS
}
```

##### Day.js配置 (dayjs.ts)
```typescript
/**
 * Day.js时间库国际化配置
 */
import dayjs from 'dayjs'
import 'dayjs/locale/zh-cn'
import 'dayjs/locale/en'

export function setupDayjsLocale(locale: I18n.LangType) {
  const dayjsLocaleMap = {
    'zh-CN': 'zh-cn',
    'en-US': 'en'
  }
  
  dayjs.locale(dayjsLocaleMap[locale] || 'en')
}
```

### 语言包组织示例

#### 通用词汇 (common.json)
```json
{
  "add": "添加",
  "delete": "删除",
  "edit": "编辑",
  "save": "保存",
  "cancel": "取消",
  "confirm": "确认",
  "back": "返回",
  "next": "下一步",
  "previous": "上一步",
  "search": "搜索",
  "filter": "筛选",
  "reset": "重置",
  "refresh": "刷新",
  "loading": "加载中...",
  "noData": "暂无数据",
  "operation": "操作",
  "status": {
    "active": "启用",
    "inactive": "禁用",
    "online": "在线",
    "offline": "离线",
    "success": "成功",
    "failed": "失败",
    "pending": "待处理"
  }
}
```

#### 表单翻译 (form.json)
```json
{
  "required": "此项为必填项",
  "invalid": "格式不正确",
  "userName": {
    "label": "用户名",
    "placeholder": "请输入用户名",
    "required": "请输入用户名",
    "invalid": "用户名格式不正确"
  },
  "email": {
    "label": "邮箱",
    "placeholder": "请输入邮箱",
    "required": "请输入邮箱",
    "invalid": "邮箱格式不正确"
  },
  "password": {
    "label": "密码",
    "placeholder": "请输入密码",
    "required": "请输入密码",
    "invalid": "密码强度不够"
  },
  "confirmPassword": {
    "label": "确认密码",
    "placeholder": "请再次输入密码",
    "required": "请确认密码",
    "notMatch": "两次输入的密码不一致"
  }
}
```

#### 设备管理翻译 (device.json)
```json
{
  "title": "设备管理",
  "add": "添加设备",
  "edit": "编辑设备",
  "delete": "删除设备",
  "detail": "设备详情",
  "group": {
    "title": "设备分组",
    "add": "添加分组",
    "edit": "编辑分组",
    "delete": "删除分组"
  },
  "status": {
    "online": "在线",
    "offline": "离线"
  },
  "telemetry": {
    "title": "遥测数据",
    "current": "当前数据",
    "history": "历史数据"
  },
  "attributes": {
    "title": "属性",
    "client": "客户端属性",
    "shared": "共享属性"
  },
  "commands": {
    "title": "命令",
    "send": "发送命令",
    "history": "命令历史"
  }
}
```

## 5. 卡片生态系统 (Card & Card2.1)

### 两代卡片系统对比

| 特性 | Card (Legacy) | Card 2.1 (New) |
|------|--------------|----------------|
| **架构模式** | 传统组件模式 | 现代化模块系统 |
| **注册方式** | 手动注册 | 自动发现注册 |
| **权限控制** | 基础权限 | 精细化权限控制 |
| **数据绑定** | 简单数据绑定 | 完整数据绑定系统 |
| **Visual Editor支持** | 有限支持 | 原生集成 |
| **类型安全** | 部分类型 | 完整TypeScript支持 |
| **开发体验** | 复杂配置 | 约定优于配置 |

### Card 2.1 核心特性

#### 自动注册系统
```typescript
/**
 * 组件自动发现和注册
 */
export class ComponentRegistry {
  private registry = new Map<string, ComponentDefinition>()

  constructor() {
    this.discoverComponents()
  }

  /**
   * 自动发现组件
   */
  private discoverComponents() {
    // 扫描组件目录
    const modules = import.meta.glob('./components/*/index.ts', { eager: true })
    
    for (const [path, module] of Object.entries(modules)) {
      const component = (module as any).default as ComponentDefinition
      
      if (component && component.type) {
        this.registry.set(component.type, component)
        console.log(`已注册组件: ${component.type}`)
      }
    }
  }

  /**
   * 获取组件定义
   */
  getComponent(type: string): ComponentDefinition | undefined {
    return this.registry.get(type)
  }

  /**
   * 获取所有组件
   */
  getAllComponents(): ComponentDefinition[] {
    return Array.from(this.registry.values())
  }

  /**
   * 按分类获取组件
   */
  getComponentsByCategory(category: string): ComponentDefinition[] {
    return this.getAllComponents().filter(comp => comp.category === category)
  }
}
```

#### 权限控制系统
```typescript
/**
 * 组件权限过滤器
 */
export function filterComponentsByPermissions(
  components: ComponentDefinition[],
  userPermissions: string[]
): ComponentDefinition[] {
  return components.filter(component => {
    // 没有权限要求的组件默认可访问
    if (!component.requiredPermissions?.length) {
      return true
    }
    
    // 检查用户是否有任一所需权限
    return component.requiredPermissions.some(permission => 
      userPermissions.includes(permission)
    )
  })
}

/**
 * 权限检查工具
 */
export function hasComponentPermission(
  component: ComponentDefinition,
  userPermissions: string[]
): boolean {
  if (!component.requiredPermissions?.length) {
    return true
  }
  
  return component.requiredPermissions.every(permission =>
    userPermissions.includes(permission)
  )
}
```

#### 数据绑定系统
```typescript
/**
 * 完整的数据绑定架构
 */

// 数据转换管道
export class DataTransformPipeline {
  async transform(sourceData: any, config: DataTransformConfig): Promise<any> {
    let result = sourceData

    // 应用转换器链
    for (const transformer of config.transformers) {
      result = await this.applyTransformer(result, transformer)
    }

    return result
  }

  private async applyTransformer(data: any, transformer: DataTransformer): Promise<any> {
    switch (transformer.type) {
      case 'map':
        return this.mapTransform(data, transformer.config)
      case 'filter':
        return this.filterTransform(data, transformer.config)
      case 'aggregate':
        return this.aggregateTransform(data, transformer.config)
      case 'format':
        return this.formatTransform(data, transformer.config)
      default:
        return data
    }
  }
}

// 响应式数据绑定
export class ReactiveBinding {
  private bindings = new Map<string, DataBinding>()

  /**
   * 创建数据绑定
   */
  createBinding(componentId: string, dataRequirement: DataRequirement): DataBinding {
    const binding = new DataBinding(componentId, dataRequirement)
    this.bindings.set(componentId, binding)
    
    // 启动数据订阅
    binding.start()
    
    return binding
  }

  /**
   * 移除数据绑定
   */
  removeBinding(componentId: string) {
    const binding = this.bindings.get(componentId)
    if (binding) {
      binding.stop()
      this.bindings.delete(componentId)
    }
  }

  /**
   * 更新绑定配置
   */
  updateBinding(componentId: string, newRequirement: DataRequirement) {
    const binding = this.bindings.get(componentId)
    if (binding) {
      binding.updateRequirement(newRequirement)
    }
  }
}

// 数据绑定实例
class DataBinding {
  private subscription?: Subscription
  private currentData = ref<any>(null)
  private loading = ref(false)
  private error = ref<Error | null>(null)

  constructor(
    private componentId: string,
    private requirement: DataRequirement
  ) {}

  /**
   * 启动数据订阅
   */
  start() {
    this.loading.value = true
    
    // 根据数据源类型创建订阅
    const dataSource = this.createDataSource()
    this.subscription = dataSource.subscribe({
      next: (data) => {
        this.currentData.value = data
        this.loading.value = false
        this.error.value = null
      },
      error: (err) => {
        this.error.value = err
        this.loading.value = false
        console.error(`数据绑定错误 (${this.componentId}):`, err)
      }
    })
  }

  /**
   * 停止数据订阅
   */
  stop() {
    if (this.subscription) {
      this.subscription.unsubscribe()
      this.subscription = undefined
    }
  }

  /**
   * 获取响应式数据
   */
  getData() {
    return {
      data: readonly(this.currentData),
      loading: readonly(this.loading),
      error: readonly(this.error)
    }
  }

  private createDataSource(): DataSource {
    switch (this.requirement.type) {
      case 'api':
        return new ApiDataSource(this.requirement.config)
      case 'websocket':
        return new WebSocketDataSource(this.requirement.config)
      case 'static':
        return new StaticDataSource(this.requirement.config)
      default:
        throw new Error(`不支持的数据源类型: ${this.requirement.type}`)
    }
  }
}
```

#### Visual Editor集成
```typescript
/**
 * Visual Editor集成Hook
 */
export function useVisualEditorIntegration(options: IntegrationOptions = {}) {
  const { autoInit = false } = options
  const componentRegistry = new ComponentRegistry()

  // 可用组件列表（响应式）
  const availableWidgets = computed(() => {
    const components = componentRegistry.getAllComponents()
    
    // 转换为Visual Editor Widget格式
    return components.map(component => ({
      type: component.type,
      name: component.name,
      category: component.category,
      icon: component.icon,
      
      // 默认布局配置
      defaultLayout: {
        canvas: {
          width: component.defaultLayout?.width || 300,
          height: component.defaultLayout?.height || 200
        },
        gridstack: {
          w: Math.ceil((component.defaultLayout?.width || 300) / 150),
          h: Math.ceil((component.defaultLayout?.height || 200) / 150)
        }
      },
      
      // 默认属性
      defaultProperties: component.defaultProps || {},
      
      // 元数据
      metadata: {
        isCard2Component: true,
        card2ComponentId: component.type,
        card2Definition: component
      }
    }))
  })

  /**
   * 获取组件定义
   */
  const getComponentDefinition = (type: string) => {
    const widget = availableWidgets.value.find(w => w.type === type)
    return widget ? componentRegistry.getComponent(type) : undefined
  }

  /**
   * 初始化集成
   */
  const initIntegration = () => {
    console.log('Card 2.1 与 Visual Editor 集成初始化完成')
    console.log(`可用组件数量: ${availableWidgets.value.length}`)
  }

  // 自动初始化
  if (autoInit) {
    onMounted(initIntegration)
  }

  return {
    availableWidgets,
    getComponentDefinition,
    initIntegration
  }
}
```

### 组件开发标准

#### 标准组件结构
```typescript
/**
 * Card 2.1 组件标准定义
 */
import SimpleCard from './SimpleCard.vue'
import SimpleCardConfigPanel from './SimpleCardConfigPanel.vue'
import { CardIcon } from '@vicons/ionicons5'

export default {
  // 基本信息
  type: 'simple-card',
  name: '简单卡片',
  category: 'basic',
  icon: CardIcon,
  
  // 组件实现
  component: SimpleCard,
  configPanel: SimpleCardConfigPanel,
  
  // 权限配置
  requiredPermissions: ['card:view'],
  
  // 默认属性
  defaultProps: {
    title: '默认标题',
    content: '默认内容',
    backgroundColor: '#ffffff',
    textColor: '#333333'
  },
  
  // 数据需求声明
  dataRequirements: {
    main: {
      type: 'api',
      description: '主要数据源',
      required: false
    }
  },
  
  // 属性架构
  propsSchema: {
    title: {
      type: 'string',
      label: '标题',
      description: '卡片标题',
      required: true
    },
    content: {
      type: 'string',
      label: '内容',
      description: '卡片内容',
      required: false
    }
  }
} as ComponentDefinition
```

## 总结

ThingsPanel的工具函数和基础设施系统展现了现代前端项目的完整生态：

### 技术亮点
1. **工具函数模块化**: 按功能域清晰分离，便于维护和复用
2. **组合式函数先进**: 充分利用Vue 3 Composition API的优势
3. **类型系统完整**: 分层次的TypeScript类型定义体系
4. **国际化体系化**: 按业务域组织的多语言支持
5. **卡片系统革新**: Card 2.1的现代化架构设计

### 设计理念
1. **约定优于配置**: 自动发现和注册机制
2. **类型安全优先**: 完整的TypeScript约束
3. **响应式设计**: 全面拥抱Vue 3响应式系统
4. **模块化组织**: 清晰的功能边界和职责分工
5. **可扩展架构**: 支持插件化扩展和定制

### 物联网适配
1. **实时数据处理**: WebSocket工具和响应式数据绑定
2. **设备管理类型**: 完整的设备生命周期类型定义
3. **可视化组件**: 专业的图表和面板组件生态
4. **多语言支持**: 国际化的物联网应用需求

这套基础设施为ThingsPanel提供了坚实的技术基础，支撑了复杂物联网应用的各种需求，体现了企业级Vue 3项目的最佳实践。