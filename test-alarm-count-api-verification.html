<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>告警计数组件 API 调用验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .success {
            color: #10b981;
            font-weight: bold;
            background: #ecfdf5;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #10b981;
        }
        .info {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #0284c7;
            margin: 15px 0;
        }
        .code-block {
            background: #1f2937;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 12px 0;
            overflow-x: auto;
        }
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .checklist li:before {
            content: '✅ ';
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="section">
            <h1>🔗 告警计数组件 API 调用验证</h1>
            <div class="success">
                ✨ 已修复：组件现在调用真实的 API 而不是模拟数据！
            </div>
        </header>

        <section class="section">
            <h2>🎯 修复内容</h2>
            <ul class="checklist">
                <li><strong>添加 API 导入</strong> - 导入 getAlarmCount 函数</li>
                <li><strong>替换模拟数据</strong> - 移除 Math.random() 生成的假数据</li>
                <li><strong>使用真实 API</strong> - 调用 getAlarmCount() 获取实际告警数据</li>
                <li><strong>保持数据格式兼容</strong> - 继续支持 alarm_device_total 字段</li>
                <li><strong>错误处理完善</strong> - 增强 API 响应异常处理</li>
            </ul>
        </section>

        <section class="section">
            <h2>💻 代码对比</h2>
            
            <h3>修复前（模拟数据）：</h3>
            <div class="code-block">
// ❌ 错误：使用模拟随机数据
const mockAlarmCount = Math.floor(Math.random() * 100)
componentState.currentValue = mockAlarmCount
            </div>

            <h3>修复后（真实 API）：</h3>
            <div class="code-block">
// ✅ 正确：调用真实的告警计数API
import { getAlarmCount } from '@/service/api'

const response = await getAlarmCount()

// 从响应中获取告警设备总数
let alarmCount = 0
if (response && response.data && typeof response.data.alarm_device_total === 'number') {
  alarmCount = response.data.alarm_device_total
} else {
  logger.warn('告警数据响应格式异常', response)
  alarmCount = 0
}

componentState.currentValue = alarmCount
            </div>
        </section>

        <section class="section">
            <h2>🔍 API 调用流程</h2>
            
            <div class="info">
                <strong>🔄 数据获取流程：</strong><br>
                1. 组件挂载时自动调用 <span class="highlight">fetchAlarmData()</span><br>
                2. 内部调用 <span class="highlight">getAlarmCount()</span> API<br>
                3. 解析响应中的 <span class="highlight">alarm_device_total</span> 字段<br>
                4. 更新组件状态并触发数据变化事件<br>
                5. 显示真实的告警设备总数
            </div>

            <h3>API 响应格式：</h3>
            <div class="code-block">
{
  "data": {
    "alarm_device_total": 23,    // 告警设备总数
    // 其他字段...
  }
}
            </div>
        </section>

        <section class="section">
            <h2>🛡️ 错误处理机制</h2>
            <ul class="checklist">
                <li><strong>响应格式验证</strong> - 检查响应结构和数据类型</li>
                <li><strong>异常捕获</strong> - try-catch 包装 API 调用</li>
                <li><strong>用户友好提示</strong> - 显示加载和错误状态</li>
                <li><strong>日志记录</strong> - 记录成功和失败的调用</li>
                <li><strong>降级处理</strong> - API 失败时显示 0</li>
            </ul>
        </section>

        <section class="section">
            <h2>🚀 组件特性</h2>
            
            <div class="info">
                <strong>🎯 核心特性：</strong><br>
                • <strong>开箱即用</strong> - 无需配置数据源，自动获取数据<br>
                • <strong>实时数据</strong> - 显示真实的系统告警统计<br>
                • <strong>自动刷新</strong> - 可配置定时刷新机制<br>
                • <strong>向后兼容</strong> - 支持原组件的数据格式<br>
                • <strong>错误恢复</strong> - API 调用失败时优雅降级
            </div>
        </section>

        <section class="section">
            <h2>🧪 测试验证</h2>
            
            <h3>如何验证修复效果：</h3>
            <ol>
                <li><strong>启动开发服务器</strong> - <code>pnpm dev</code></li>
                <li><strong>访问 Visual Editor</strong> - 添加告警计数组件到面板</li>
                <li><strong>观察数据显示</strong> - 应该显示真实的告警数据而不是随机数</li>
                <li><strong>检查网络请求</strong> - 在开发者工具中确认 API 调用</li>
                <li><strong>测试错误情况</strong> - 断网或 API 异常时的处理</li>
            </ol>

            <div class="info">
                <strong>🔧 调试提示：</strong><br>
                查看浏览器控制台的 <span class="highlight">[AlarmCount]</span> 日志，
                确认 API 调用和数据解析过程。
            </div>
        </section>

        <section class="section">
            <h2>✅ 修复完成</h2>
            <div class="success">
                🎉 告警计数组件现在使用真实的 API 数据，不再是模拟数据！<br>
                组件会自动调用 <strong>getAlarmCount()</strong> API 并显示实际的告警设备总数。
            </div>
        </section>
    </div>
</body>
</html>