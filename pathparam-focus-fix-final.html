<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PathParam焦点问题终极修复</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
    }
    .fix-container {
      max-width: 1100px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .fix-header {
      background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 28px;
      text-align: center;
    }
    .problem-analysis {
      background: #fff2f0;
      border: 2px solid #ffccc7;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .solution-summary {
      background: #f6ffed;
      border: 2px solid #b7eb8f;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .code-fix {
      background: #f8f8f8;
      border: 1px solid #d9d9d9;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 16px 0;
      overflow-x: auto;
    }
    .test-steps {
      background: #e6f7ff;
      border: 2px solid #91d5ff;
      border-radius: 8px;
      padding: 20px;
    }
    .step-item {
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #1890ff;
    }
    .step-item h4 {
      margin: 0 0 8px 0;
      color: #1890ff;
    }
    .nav-link {
      display: inline-block;
      padding: 14px 28px;
      background: #ff4d4f;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin-right: 12px;
      margin-bottom: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .nav-link:hover {
      background: #ff7875;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255,77,79,0.3);
    }
    .critical-point {
      background: #fff1f0;
      border: 1px solid #ffa39e;
      padding: 16px;
      border-radius: 6px;
      margin: 12px 0;
    }
    .critical-point::before {
      content: "⚠️ ";
      font-weight: bold;
      color: #ff4d4f;
    }
  </style>
</head>
<body>
  <div class="fix-container">
    <div class="fix-header">
      <h1>🎯 PathParam输入框焦点问题终极修复</h1>
      <p>基于您的实际测试反馈，精准修复HttpConfigStep1.vue中的状态管理问题</p>
    </div>

    <div class="problem-analysis">
      <h3>🔍 问题根源分析（基于您的日志）</h3>
      <p>从您提供的控制台日志可以看出：</p>
      <div class="code-fix">
🔄 [HttpConfigStep1] 配置更新 - pathParams: [{…}]
🔄 [HttpConfigStep1] 配置更新 - pathParameter: {...}
📝 [HttpConfigStep1] 参数配置更新，但不修改URL模板
      </div>
      
      <div class="critical-point">
        <strong>核心问题：</strong>每次输入一个字符都触发3次配置更新：
        <ol>
          <li><code>updateConfig('pathParams', params)</code></li>
          <li><code>updateConfig('pathParameter', {...})</code></li>
          <li><code>updateConfig('url', apiInfo.url)</code></li>
        </ol>
        每次emit都导致父组件重新渲染，破坏了输入框的焦点状态。
      </div>
    </div>

    <div class="solution-summary">
      <h3>✅ 修复方案总结</h3>
      
      <h4>修复1：批量更新配置</h4>
      <div class="code-fix">
// 修复前：多次单独更新
updateConfig('pathParams', params)
updateConfig('pathParameter', {...})
updateConfig('url', apiInfo.url)

// 修复后：一次性批量更新
const batchUpdates = { pathParams: params, pathParameter: {...}, url: apiInfo.url }
const newConfig = { ...props.modelValue, ...batchUpdates }
emit('update:modelValue', newConfig)  // 只发射一次
      </div>

      <h4>修复2：避免循环更新</h4>
      <div class="code-fix">
// 添加更新标记
const isUpdatingFromChild = ref(false)

// 在子组件更新时设置标记
const onUrlParamsUpdate = (params) => {
  isUpdatingFromChild.value = true
  // ...更新逻辑
  nextTick(() => { isUpdatingFromChild.value = false })
}

// 在watch中检查标记
watch(() => props.modelValue, () => {
  if (isUpdatingFromChild.value) return  // 跳过循环更新
  // ...同步逻辑
})
      </div>

      <h4>修复3：稳定的Vue Key值（DynamicParameterEditor）</h4>
      <div class="code-fix">
// 确保参数列表使用稳定的key
:key="param._id"  // 而不是基于param.key的不稳定key
      </div>
    </div>

    <div class="test-steps">
      <h3>🧪 验证测试步骤</h3>
      
      <div class="step-item">
        <h4>步骤1：访问HTTP配置页面</h4>
        <p>打开数据源系统测试页面，找到HTTP配置表单</p>
        <a href="http://localhost:5002/test/data-source-system" class="nav-link" target="_blank">
          打开数据源系统测试
        </a>
      </div>

      <div class="step-item">
        <h4>步骤2：选择内部地址类型</h4>
        <p>1. 在HTTP配置第1步中，选择"地址类型"为"内部地址"<br>
           2. 选择任何一个带有路径参数的接口（如：设备详情 - /device/detail/{id}）</p>
      </div>

      <div class="step-item">
        <h4>步骤3：启用URL传参</h4>
        <p>1. 找到"URL传参"开关并启用<br>
           2. 此时会出现"参数配置"区域，显示pathParam输入框</p>
      </div>

      <div class="step-item">
        <h4>步骤4：测试焦点保持（关键！）</h4>
        <p>1. 在参数名输入框中<strong>连续输入多个字符</strong><br>
           2. <strong>验证：输入框应保持焦点，不会每输入一个字符就失去焦点</strong><br>
           3. 检查控制台，应该看到"批量参数配置更新"而不是多次单独更新</p>
      </div>

      <div class="step-item">
        <h4>步骤5：测试默认值行为</h4>
        <p>1. 清空参数名输入框<br>
           2. 点击其他地方使输入框失去焦点<br>
           3. <strong>验证：应设置合理的默认值，但不会强制覆盖正在输入的内容</strong></p>
      </div>
    </div>

    <div style="background: #fafafa; border: 1px solid #e8e8e8; border-radius: 8px; padding: 20px; margin-top: 24px;">
      <h3>📊 预期修复效果</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div style="background: #fff2f0; padding: 16px; border-radius: 6px;">
          <h4 style="color: #ff4d4f; margin: 0 0 8px 0;">修复前 ❌</h4>
          <ul style="margin: 0; font-size: 14px;">
            <li>每输入一个字符失去焦点</li>
            <li>控制台显示3次配置更新</li>
            <li>默认值强制覆盖用户输入</li>
            <li>输入体验极其糟糕</li>
          </ul>
        </div>
        
        <div style="background: #f6ffed; padding: 16px; border-radius: 6px;">
          <h4 style="color: #52c41a; margin: 0 0 8px 0;">修复后 ✅</h4>
          <ul style="margin: 0; font-size: 14px;">
            <li>输入框保持焦点</li>
            <li>控制台显示1次批量更新</li>
            <li>智能的默认值策略</li>
            <li>流畅的输入体验</li>
          </ul>
        </div>
      </div>
    </div>

    <div style="text-align: center; margin-top: 32px; padding: 20px; background: #e6f7ff; border-radius: 8px;">
      <h3>🚀 立即测试修复效果！</h3>
      <p>现在就可以按照上述步骤验证pathParam输入框是否已经修复了焦点丢失问题</p>
      <a href="http://localhost:5002/test/data-source-system" class="nav-link" target="_blank" style="font-size: 16px;">
        🔗 开始测试PathParam修复效果
      </a>
    </div>
  </div>
</body>
</html>