<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试组件注册问题</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
        }
        .section { 
            margin-bottom: 30px; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        pre { 
            background: #f8f8f8; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
        }
        .error { color: #d32f2f; }
        .success { color: #2e7d32; }
        .warning { color: #f57f17; }
        .info { color: #1976d2; }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1565c0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>组件注册系统调试</h1>
        
        <div class="section">
            <h2>调试操作</h2>
            <button onclick="debugAutoRegistry()">调试自动注册系统</button>
            <button onclick="debugComponentTree()">调试组件树</button>
            <button onclick="debugVisualEditorIntegration()">调试 Visual Editor 集成</button>
            <button onclick="checkTripleDataDisplay()">检查 triple-data-display</button>
            <button onclick="listAllRegistrations()">列出所有注册</button>
        </div>

        <div class="section">
            <h2>调试输出</h2>
            <pre id="output"></pre>
        </div>

        <div class="section">
            <h2>组件列表</h2>
            <pre id="components"></pre>
        </div>

        <div class="section">
            <h2>错误信息</h2>
            <pre id="errors"></pre>
        </div>
    </div>

    <script type="module">
        function log(message, level = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = level;
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(`[${level.toUpperCase()}] ${message}`);
        }

        function logError(message, error = null) {
            const errorDiv = document.getElementById('errors');
            const timestamp = new Date().toLocaleTimeString();
            errorDiv.innerHTML += `<span class="error">[${timestamp}] ${message}</span>\n`;
            if (error) {
                errorDiv.innerHTML += `<span class="error">  详细错误: ${error.message || error}</span>\n`;
                console.error(message, error);
            }
        }

        async function debugAutoRegistry() {
            log('开始调试自动注册系统...', 'info');
            
            try {
                // 导入自动注册系统
                const { autoRegistry } = await import('./src/card2.1/components/auto-registry.ts');
                
                log('✅ 自动注册系统导入成功', 'success');
                
                // 检查初始化状态
                const isInitialized = autoRegistry.initialized;
                log(`初始化状态: ${isInitialized}`, isInitialized ? 'success' : 'warning');
                
                if (!isInitialized) {
                    log('正在初始化自动注册系统...', 'info');
                    await autoRegistry.initialize();
                    log('✅ 自动注册系统初始化完成', 'success');
                }
                
                // 获取统计信息
                const stats = autoRegistry.getStats();
                log(`统计信息: ${JSON.stringify(stats, null, 2)}`, 'info');
                
                // 获取所有组件
                const components = autoRegistry.getAllComponents();
                log(`组件总数: ${components.length}`, 'info');
                
                // 检查 triple-data-display
                const tripleComponent = autoRegistry.getComponentDefinition('triple-data-display');
                if (tripleComponent) {
                    log('✅ triple-data-display 找到', 'success');
                    log(`组件信息: ${JSON.stringify({
                        type: tripleComponent.type,
                        name: tripleComponent.name,
                        hasComponent: !!tripleComponent.component
                    }, null, 2)}`, 'info');
                } else {
                    log('❌ triple-data-display 未找到', 'error');
                }
                
                // 显示组件列表
                const componentsList = components.map(c => ({
                    type: c.type,
                    name: c.name,
                    category: c.category,
                    hasComponent: !!c.component
                }));
                
                document.getElementById('components').textContent = JSON.stringify(componentsList, null, 2);
                
            } catch (error) {
                logError('调试自动注册系统失败', error);
            }
        }

        async function debugComponentTree() {
            log('开始调试组件树...', 'info');
            
            try {
                const { useComponentTree } = await import('./src/card2.1/hooks/useComponentTree.ts');
                
                const componentTree = useComponentTree({ autoInit: true });
                await componentTree.initialize();
                
                log('✅ 组件树初始化完成', 'success');
                
                const components = componentTree.filteredComponents.value;
                log(`组件树中组件数量: ${Array.isArray(components) ? components.length : 'not array'}`, 'info');
                
                if (Array.isArray(components)) {
                    const hasTriple = components.some(c => c.type === 'triple-data-display');
                    log(`组件树中是否包含 triple-data-display: ${hasTriple}`, hasTriple ? 'success' : 'error');
                }
                
            } catch (error) {
                logError('调试组件树失败', error);
            }
        }

        async function debugVisualEditorIntegration() {
            log('开始调试 Visual Editor 集成...', 'info');
            
            try {
                const { useComponentTree } = await import('./src/card2.1/hooks/useComponentTree.ts');
                
                const integration = useComponentTree({ autoInit: true });
                await integration.initialize();
                
                log('✅ Visual Editor 集成初始化完成', 'success');
                
                const widgets = integration.availableWidgets.value;
                log(`可用组件数量: ${widgets.length}`, 'info');
                
                const hasTriple = widgets.some(w => w.type === 'triple-data-display');
                log(`集成中是否包含 triple-data-display: ${hasTriple}`, hasTriple ? 'success' : 'error');
                
                // 尝试获取组件定义
                const componentDef = integration.getComponentDefinition('triple-data-display');
                if (componentDef) {
                    log('✅ getComponentDefinition 返回了组件定义', 'success');
                } else {
                    log('❌ getComponentDefinition 返回 undefined', 'error');
                }
                
                // 尝试获取组件实例
                const component = integration.getComponent('triple-data-display');
                if (component) {
                    log('✅ getComponent 返回了组件实例', 'success');
                } else {
                    log('❌ getComponent 返回 null', 'error');
                }
                
            } catch (error) {
                logError('调试 Visual Editor 集成失败', error);
            }
        }

        async function checkTripleDataDisplay() {
            log('检查 triple-data-display 组件定义...', 'info');
            
            try {
                const module = await import('./src/card2.1/components/test/triple-data-display/index.ts');
                
                log('✅ triple-data-display 模块导入成功', 'success');
                log(`模块导出: ${Object.keys(module)}`, 'info');
                
                const definition = module.default;
                if (definition) {
                    log('✅ 默认导出存在', 'success');
                    log(`组件定义结构: ${JSON.stringify({
                        type: definition.type,
                        name: definition.name,
                        hasComponent: !!definition.component,
                        componentType: typeof definition.component
                    }, null, 2)}`, 'info');
                } else {
                    log('❌ 默认导出不存在', 'error');
                }
                
            } catch (error) {
                logError('检查 triple-data-display 组件定义失败', error);
            }
        }

        async function listAllRegistrations() {
            log('列出所有注册系统状态...', 'info');
            
            try {
                // 检查新注册系统
                const { getComponentRegistry } = await import('./src/card2.1/index.ts');
                const registry = getComponentRegistry();
                const allComponents = registry.getAll();
                
                log(`新注册系统组件数量: ${allComponents.length}`, 'info');
                allComponents.forEach(comp => {
                    log(`  - ${comp.type}: ${comp.name}`, 'info');
                });
                
                // 检查旧注册系统
                const { ComponentRegistry } = await import('./src/card2.1/core/component-registry.ts');
                log(`旧注册系统组件数量: ${Object.keys(ComponentRegistry['components'] || {}).length}`, 'info');
                
            } catch (error) {
                logError('列出注册状态失败', error);
            }
        }

        // 绑定函数到 window 对象
        window.debugAutoRegistry = debugAutoRegistry;
        window.debugComponentTree = debugComponentTree;
        window.debugVisualEditorIntegration = debugVisualEditorIntegration;
        window.checkTripleDataDisplay = checkTripleDataDisplay;
        window.listAllRegistrations = listAllRegistrations;

        // 页面加载时自动运行一些检查
        window.addEventListener('load', () => {
            log('页面加载完成，开始自动检查...', 'info');
            setTimeout(() => {
                checkTripleDataDisplay();
            }, 1000);
        });
    </script>
</body>
</html>