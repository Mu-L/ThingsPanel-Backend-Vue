<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔍 SimpleDataBridge 执行调试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .test-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 32px;
      text-align: center;
    }
    .test-header h1 {
      margin: 0 0 12px 0;
      font-size: 28px;
    }
    .test-header p {
      margin: 0;
      font-size: 16px;
      opacity: 0.9;
    }
    .test-section {
      margin-bottom: 40px;
      padding: 24px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: #fafafa;
    }
    .test-section h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 20px;
    }
    .step {
      margin-bottom: 20px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #2080f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .step h4 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 16px;
    }
    .step p {
      margin: 0;
      color: #666;
      font-size: 14px;
      line-height: 1.6;
    }
    .step ul {
      margin: 8px 0 0 0;
      color: #666;
      font-size: 14px;
    }
    .step li {
      margin-bottom: 4px;
    }
    .debug-enhancement {
      background: #e6f4ff;
      border-left-color: #1890ff;
    }
    .debug-enhancement h4 {
      color: #1890ff;
    }
    .nav-link {
      display: inline-block;
      padding: 12px 24px;
      background: #2080f0;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin-right: 12px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .nav-link:hover {
      background: #40a9ff;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(32,128,240,0.3);
    }
    .debug-logs {
      background: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #333;
      margin: 16px 0;
      border: 1px solid #e0e0e0;
      overflow-x: auto;
    }
    .critical-issue {
      background: #fff2e8;
      border-left-color: #fa8c16;
    }
    .critical-issue h4 {
      color: #fa8c16;
    }
    .success-banner {
      background: linear-gradient(135deg, #52c41a, #73d13d);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
    }
    .success-banner h4 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }
    .success-banner p {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>🔍 SimpleDataBridge 执行调试</h1>
      <p>深度调试 SimpleDataBridge 内部执行流程，定位HTTP请求未发出的根本原因</p>
    </div>

    <div class="success-banner">
      <h4>🔍 调试增强完成</h4>
      <p>已在 SimpleDataBridge 的关键执行节点添加详细调试日志，可以完整追踪数据执行流程</p>
    </div>

    <div class="test-section">
      <h3>🔧 新增的调试节点</h3>
      
      <div class="step debug-enhancement">
        <h4>✅ executeComponent 开始阶段</h4>
        <div class="debug-logs">
🚀 [SimpleDataBridge] executeComponent 开始 {
  componentId: 'xxx',
  requirementKeys: ['componentId', 'dataSources', ...],
  hasDataSources: true,
  dataSourcesLength: 3
}
        </div>
      </div>

      <div class="step debug-enhancement">
        <h4>✅ 缓存数据检查阶段</h4>
        <div class="debug-logs">
🔍 [SimpleDataBridge] 检查缓存数据 {
  componentId: 'xxx',
  hasCachedData: true,
  cachedDataType: 'object',
  cachedDataKeys: ['temperature', 'humidity', 'pressure']
}

🔍 [SimpleDataBridge] 验证缓存数据有效性 {
  componentId: 'xxx',
  hasDataItems: true,
  shouldUseCachedData: true
}

✅ [SimpleDataBridge] 使用缓存数据，跳过HTTP请求 {
  componentId: 'xxx',
  finalDataKeys: ['temperature', 'humidity', 'pressure'],
  cacheHit: true
}
        </div>
      </div>

      <div class="step debug-enhancement">
        <h4>✅ 数据源配置转换阶段</h4>
        <div class="debug-logs">
🔍 [SimpleDataBridge] 使用 DataSourceConfiguration 格式 {
  componentId: 'xxx'
}

🚀 [SimpleDataBridge] 开始执行 MultiLayerExecutorChain {
  componentId: 'xxx',
  dataSourcesCount: 3,
  hasHttpDataItems: true
}

✅ [SimpleDataBridge] MultiLayerExecutorChain 执行完成 {
  componentId: 'xxx',
  executionSuccess: true,
  hasComponentData: true,
  componentDataKeys: ['temperature', 'humidity', 'pressure'],
  error: undefined
}
        </div>
      </div>
    </div>

    <div class="test-section">
      <h3>🎯 关键诊断点</h3>
      
      <div class="step critical-issue">
        <h4>🚨 最可能的问题原因</h4>
        <p>基于之前的日志分析，问题很可能是以下之一：</p>
        <ul>
          <li><strong>缓存命中导致跳过HTTP请求</strong>：SimpleDataBridge 发现有缓存数据，直接返回缓存结果</li>
          <li><strong>MultiLayerExecutorChain 内部问题</strong>：执行器链没有正确处理 HTTP 请求</li>
          <li><strong>配置转换后数据源丢失</strong>：转换过程中 HTTP 数据源配置被错误处理</li>
          <li><strong>DataItemFetcher 未被调用</strong>：执行链没有到达 HTTP 请求执行层</li>
        </ul>
      </div>

      <div class="step">
        <h4>🔍 现在需要观察的关键信息</h4>
        <ul>
          <li><strong>hasCachedData</strong>：是否存在缓存数据导致跳过HTTP请求</li>
          <li><strong>cacheHit</strong>：是否命中缓存，直接返回旧数据</li>
          <li><strong>hasHttpDataItems</strong>：转换后的配置是否包含 HTTP 数据项</li>
          <li><strong>MultiLayerExecutorChain 执行结果</strong>：是否成功执行并有数据返回</li>
        </ul>
      </div>
    </div>

    <div class="test-section">
      <h3>🧪 测试验证步骤</h3>
      
      <div class="step">
        <h4>步骤 1：访问数据源系统测试页面</h4>
        <p>修改设备ID，观察新增的 SimpleDataBridge 调试日志</p>
        <a href="http://localhost:5002/test/data-source-system" class="nav-link" target="_blank">
          🔗 数据源系统测试
        </a>
      </div>

      <div class="step">
        <h4>步骤 2：重点观察关键日志</h4>
        <ul>
          <li><strong>🚀 [SimpleDataBridge] executeComponent 开始</strong> - 确认方法被调用</li>
          <li><strong>🔍 [SimpleDataBridge] 检查缓存数据</strong> - 确认是否有缓存</li>
          <li><strong>✅ [SimpleDataBridge] 使用缓存数据</strong> - 如果看到这个，说明跳过了HTTP请求</li>
          <li><strong>🚀 [SimpleDataBridge] 开始执行 MultiLayerExecutorChain</strong> - 确认执行器链被调用</li>
        </ul>
      </div>

      <div class="step">
        <h4>步骤 3：根据日志确定问题类型</h4>
        <p>根据看到的日志，我们就能准确定位问题：</p>
        <ul>
          <li><strong>如果看到缓存命中日志</strong>：问题是缓存机制阻止了新的HTTP请求</li>
          <li><strong>如果没有缓存但仍无HTTP请求</strong>：问题在 MultiLayerExecutorChain 内部</li>
          <li><strong>如果配置转换后 hasHttpDataItems: false</strong>：问题在配置转换阶段</li>
        </ul>
      </div>
    </div>

    <div class="test-section">
      <h3>🔗 相关测试链接</h3>
      <a href="http://localhost:5002/test/data-source-system" class="nav-link" target="_blank">
        数据源系统测试
      </a>
      <a href="http://localhost:5002/test/editor-integration" class="nav-link" target="_blank">
        编辑器集成测试
      </a>
    </div>
  </div>
</body>
</html>