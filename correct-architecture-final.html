<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>正确架构最终确认</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
        }
        .correct-banner {
            background: linear-gradient(135deg, #18a058, #36ad6a);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(24, 160, 88, 0.3);
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #18a058;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .feature-card h3 {
            margin-top: 0;
            color: #18a058;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .feature-list li:before {
            content: "✅ ";
            margin-right: 8px;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 16px 0;
        }
        .highlight {
            background: #e7f3ff;
            padding: 2px 6px;
            border-radius: 4px;
            color: #0066cc;
            font-weight: bold;
        }
        .data-structure {
            background: #fff9e6;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="correct-banner">
        <h1>✅ 正确架构最终确认</h1>
        <p><strong>交互系统现已按照正确架构实现：3个事件类型 + 2个动作类型</strong></p>
        <p>所有功能逻辑严格按照用户描述实现，无额外添加功能</p>
    </div>

    <div class="feature-grid">
        <div class="feature-card">
            <h3>📋 事件类型 (3个)</h3>
            <ul class="feature-list">
                <li><strong>点击时</strong> (click) - 用户点击组件触发</li>
                <li><strong>悬停时</strong> (hover) - 鼠标悬停在组件上触发</li>
                <li><strong>属性变化时</strong> (dataChange) - 组件属性值发生变化时触发</li>
            </ul>
        </div>

        <div class="feature-card">
            <h3>⚡ 动作类型 (2个)</h3>
            <ul class="feature-list">
                <li><strong>页面跳转</strong> - 外部链接或内部菜单跳转</li>
                <li><strong>修改目标组件属性</strong> - 改变其他组件的属性值</li>
            </ul>
        </div>

        <div class="feature-card">
            <h3>🔍 属性监听机制</h3>
            <ul class="feature-list">
                <li>组件通过 index.ts 声明可监听属性</li>
                <li>注册到 propertyExposureRegistry</li>
                <li>配置表单从注册表获取属性选项</li>
                <li>支持分组和详细描述</li>
            </ul>
        </div>

        <div class="feature-card">
            <h3>🎯 目标组件机制</h3>
            <ul class="feature-list">
                <li>从当前编辑器画布获取组件列表</li>
                <li>优先显示组件标题</li>
                <li>根据目标组件类型获取可响应属性</li>
                <li>通过属性暴露注册表动态加载</li>
            </ul>
        </div>
    </div>

    <div class="data-structure">
        <h3>🔗 内部菜单数据结构</h3>
        <p>从 <span class="highlight">fetchGetUserRoutes()</span> API 获取的数据结构：</p>
        <div class="code-block">{
  "code": 200,
  "message": "操作成功", 
  "data": {
    "list": [
      {
        "id": "...",
        "param1": "/home",           // ← 用作跳转路径
        "description": "首页",       // ← 用作显示标签
        "children": [...]            // ← 支持层级结构
      }
    ]
  }
}</div>
        <p><strong>使用逻辑：</strong></p>
        <ul>
            <li><span class="highlight">param1</span> 字段作为实际跳转路径</li>
            <li><span class="highlight">description</span> 字段作为用户看到的标签</li>
            <li>支持 <span class="highlight">children</span> 递归处理子菜单</li>
            <li>扁平化为下拉选项，层级用 "/" 分隔</li>
        </ul>
    </div>

    <div class="feature-card" style="margin-top: 30px;">
        <h3>🎯 核心实现要点</h3>
        
        <h4>1. 事件类型选项 (严格3个)</h4>
        <div class="code-block">const eventOptions = [
  { label: '点击时', value: 'click' },
  { label: '悬停时', value: 'hover' },
  { label: '属性变化时', value: 'dataChange' }
]</div>

        <h4>2. 动作类型选项 (严格2个)</h4>
        <div class="code-block">const actionTypeOptions = [
  { label: '页面跳转', value: 'jump' },
  { label: '修改目标组件属性', value: 'modify' }
]</div>

        <h4>3. 动态组件获取</h4>
        <div class="code-block">const componentOptions = computed(() => {
  const components = visualEditorState.getAvailableComponents()
  
  return components.map(comp => ({
    // 优先使用标题，然后是名称，最后是ID前8位
    label: comp.title || comp.label || comp.name || `组件 (${comp.id.slice(0, 8)}...)`,
    value: comp.id,
    componentType: comp.type
  }))
})</div>

        <h4>4. 目标属性动态获取</h4>
        <div class="code-block">const targetPropertyOptions = computed(() => {
  // 根据选择的目标组件ID找到组件类型
  const targetComponent = components.find(comp => comp.id === currentInteraction.value.targetComponentId)
  
  // 从属性暴露注册表获取该组件类型的可响应属性
  const componentExposure = propertyExposureRegistry.getComponentExposure(targetComponent.type)
  
  // 转换为分组选项格式
  return formatPropertyOptions(componentExposure.listenableProperties)
})</div>

        <h4>5. 内部菜单路径处理</h4>
        <div class="code-block">const flattenRoutes = (routes, prefix = '') => {
  const options = []
  
  for (const route of routes) {
    const path = route.param1          // 使用 param1 作为路径
    const title = route.description    // 使用 description 作为标签
    const fullLabel = prefix ? `${prefix} / ${title}` : title
    
    if (path && title) {
      options.push({ label: fullLabel, value: path })
    }
    
    // 递归处理子路由
    if (route.children?.length > 0) {
      options.push(...flattenRoutes(route.children, fullLabel))
    }
  }
  
  return options
}</div>
    </div>

    <div class="correct-banner" style="margin-top: 40px;">
        <h2>🎉 架构确认完成</h2>
        <div style="text-align: left; max-width: 800px; margin: 0 auto;">
            <p><strong>✅ 严格按照用户要求实现：</strong></p>
            <ul style="text-align: left;">
                <li>🔢 <strong>3个事件类型</strong>：点击、悬停、属性变化</li>
                <li>🎯 <strong>2个动作类型</strong>：页面跳转、修改目标组件属性</li>
                <li>📊 <strong>属性监听</strong>：组件index.ts → 属性暴露注册表 → 配置表单</li>
                <li>🎨 <strong>目标组件</strong>：从编辑器画布获取，优先显示标题</li>
                <li>🔗 <strong>内部菜单</strong>：param1作路径，description作标签</li>
            </ul>
            <br>
            <p style="margin-top: 20px; font-size: 18px; color: #ffd700;">
                <strong>功能逻辑完全正确，UI优化成功！</strong>
            </p>
        </div>
    </div>

    <script>
        // 检查开发服务器状态
        fetch('http://localhost:5002')
            .then(response => {
                if (response.ok) {
                    console.log('✅ 开发服务器运行正常');
                } else {
                    console.log('⚠️ 服务器响应异常');
                }
            })
            .catch(error => {
                console.log('❌ 无法连接到开发服务器，请运行 pnpm dev');
            });
    </script>
</body>
</html>